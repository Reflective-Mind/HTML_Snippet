<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy Text Manager - Ultimate Edition</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0073e6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* ========== THEME SYSTEM ========== */
        :root {
            /* Standard Theme (Default) */
            --theme-bg-primary: #121212;
            --theme-bg-secondary: #1e1e1e;
            --theme-bg-tertiary: #2d2d2d;
            --theme-text-primary: #ffffff;
            --theme-text-secondary: #aaaaaa;
            --theme-text-tertiary: #666666;
            --theme-accent: #0073e6;
            --theme-accent-hover: #005bb5;
            --theme-border: #444444;
            --theme-border-light: rgba(255, 255, 255, 0.1);
            --theme-success: #4caf50;
            --theme-error: #f44336;
            --theme-warning: #ff9800;
            --theme-favorite: #ffd700;
            --theme-shadow: rgba(0, 0, 0, 0.3);
            --theme-shadow-heavy: rgba(0, 0, 0, 0.5);
            --theme-radius: 8px;
            --theme-radius-small: 4px;
            --theme-spacing: 20px;
            --theme-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Settings Button */
        .settings-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: #1a1a1a;
            border: 2px solid #666666;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .settings-button:hover {
            transform: scale(1.1) rotate(90deg);
            border-color: #ffffff;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* Settings Menu */
        .settings-menu {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9998;
            background: #1a1a1a;
            border: 2px solid #666666;
            border-radius: 8px;
            padding: 15px;
            min-width: 220px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
            animation: slideDown 0.3s ease;
        }
        .settings-menu.active {
            display: block;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .settings-menu-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .settings-option {
            padding: 12px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .settings-option:hover {
            background: #333333;
            border-color: #666666;
        }
        .settings-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }
        .settings-name {
            flex: 1;
            font-weight: 500;
            color: #ffffff;
        }
        .settings-divider {
            height: 1px;
            background: #666666;
            margin: 10px 0;
        }
        
        /* High Contrast Theme - Always Applied */
        :root {
            --theme-bg-primary: #000000;
            --theme-bg-secondary: #1a1a1a;
            --theme-bg-tertiary: #333333;
            --theme-text-primary: #ffffff;
            --theme-text-secondary: #cccccc;
            --theme-accent: #ffffff;
            --theme-accent-hover: #e0e0e0;
            --theme-border: #666666;
        }
        
        /* Apply High Contrast theme to all elements */
        #copy-text-manager {
            background: var(--theme-bg-primary);
            color: var(--theme-text-primary);
        }
        #copy-text-manager .tab-button {
            background-color: var(--theme-bg-secondary);
            color: var(--theme-text-secondary);
            border-color: var(--theme-border);
        }
        #copy-text-manager .tab-button.active {
            background-color: var(--theme-accent);
            color: #000000;
            border-color: var(--theme-accent);
        }
        #copy-text-manager .tab-button:hover:not(.active) {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }
        .copy-button {
            background-color: var(--theme-accent);
            color: #000000;
        }
        .copy-button:hover {
            background-color: var(--theme-accent-hover);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: rgba(34, 34, 34, 0.95);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 650px;
            border-color: #aaa;
            border-radius: 5px;
            color: #fff;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 20px;
            z-index: 10;
        }
        .close:hover,
        .close:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        .toast {
            background: var(--theme-bg-secondary);
            border-color: var(--theme-border);
            color: var(--theme-text-primary);
        }
        
        /* Apply High Contrast to Notes Section */
        .notepad-container {
            background-color: var(--theme-bg-primary);
        }
        .notepad-content {
            background-color: var(--theme-bg-primary);
        }
        .notepad-sidebar {
            background-color: var(--theme-bg-secondary);
            border-color: var(--theme-border);
        }
        .notepad-sidebar-header {
            background-color: var(--theme-bg-tertiary);
            border-color: var(--theme-border);
        }
        .notepad-category-item {
            color: var(--theme-text-secondary);
            border-color: var(--theme-border);
        }
        .notepad-category-item:hover {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }
        .notepad-category-item.active {
            background-color: var(--theme-accent);
            color: #000000;
            border-color: var(--theme-accent);
        }
        .notepad-tab {
            background-color: var(--theme-bg-secondary);
            color: var(--theme-text-secondary);
            border-color: var(--theme-border);
        }
        .notepad-tab.active {
            background-color: var(--theme-accent);
            color: #000000;
            border-color: var(--theme-accent);
        }
        .notepad-tab:hover {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }
        .notepad-editor-header {
            background-color: var(--theme-bg-secondary);
            border-color: var(--theme-border);
        }
        .notepad-title-input {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            border-color: var(--theme-border);
        }
        #notepadTextarea {
            background-color: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            border-color: var(--theme-border);
        }
        .notepad-action-btn {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            border-color: var(--theme-border);
        }
        .notepad-action-btn:hover {
            background-color: var(--theme-accent);
            color: #000000;
        }
        .notepad-new-note-btn-header {
            background-color: var(--theme-accent);
            color: #000000;
        }
        .notepad-new-note-btn-header:hover {
            background-color: var(--theme-accent-hover);
        }
        .notepad-template-btn {
            background-color: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            border-color: var(--theme-border);
        }
        .notepad-template-btn:hover {
            background-color: var(--theme-accent);
            color: #000000;
        }
        #notepadCategoryMenu {
            background: var(--theme-bg-secondary);
            border-color: var(--theme-border);
            color: var(--theme-text-primary);
        }
        .notepad-tabs-container {
            background-color: var(--theme-bg-tertiary);
            border-color: var(--theme-border);
        }
        
        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            min-width: 250px;
            max-width: 400px;
        }
        .toast.success {
            border-left: 4px solid #4caf50;
        }
        .toast.error {
            border-left: 4px solid #f44336;
        }
        .toast.info {
            border-left: 4px solid #2196F3;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* Favorites System */
        .favorite-button {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            transition: all 0.2s;
            margin-right: 5px;
        }
        .favorite-button:hover {
            color: #ffd700;
        }
        .favorite-button.active {
            color: #ffd700;
        }
        .favorite-button.active::before {
            content: '★';
        }
        .favorite-button:not(.active)::before {
            content: '☆';
        }
        /* Tags System */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        .tag {
            padding: 2px 8px;
            background: #0073e6;
            color: white;
            border-radius: 12px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            margin-left: 4px;
        }
        .tag-remove:hover {
            opacity: 1;
        }
        .tag-input {
            padding: 2px 6px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 12px;
            color: #ddd;
            font-size: 11px;
            width: 80px;
        }
        /* Copy History Button */
        .history-button {
            padding: 6px 12px;
            background-color: #9c27b0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        .history-button:hover {
            background-color: #7b1fa2;
        }
        /* Search Highlight */
        .search-highlight {
            background-color: rgba(255, 215, 0, 0.3);
            padding: 2px 0;
        }
        /* Keyboard Shortcut Hint */
        .shortcut-hint {
            font-size: 10px;
            color: #666;
            margin-left: 5px;
        }
        /* Tag Input UI */
        .tag-input-container {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-items: center;
        }
        .tag-input-field {
            padding: 4px 8px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 12px;
            color: #ddd;
            font-size: 11px;
            width: 120px;
        }
        .tag-add-button {
            padding: 4px 8px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        .tag-add-button:hover {
            background: #45a049;
        }
        /* Help Modal */
        .help-shortcuts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .shortcut-item {
            padding: 8px;
            background: #252525;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        .shortcut-key {
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
        }
        /* Duplicate Button */
        .duplicate-button {
            padding: 4px 6px;
            font-size: 12px;
            background-color: #9c27b0;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            transition: background-color 0.2s ease;
        }
        .duplicate-button:hover {
            background-color: #7b1fa2;
        }
        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .filter-button {
            padding: 6px 12px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .filter-button:hover {
            background: #2d2d2d;
            color: #ddd;
        }
        .filter-button.active {
            background: #0073e6;
            color: white;
            border-color: #0073e6;
        }
        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: #2d2d2d;
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        /* Better Confirmation Modal */
        .confirm-modal-content {
            text-align: center;
        }
        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        /* Statistics Dashboard */
        .stats-container {
            background: rgba(20, 20, 35, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(10, 10, 20, 0.6);
            border-radius: 6px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
        }
        .stat-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #0073e6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        /* Quick Actions Menu */
        .quick-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .quick-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #0073e6;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 20px;
            margin-bottom: 10px;
            display: block;
            transition: all 0.3s;
        }
        .quick-action-btn:hover {
            transform: scale(1.1);
            background: #005bb5;
        }
        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(34, 34, 34, 0.95);
            border: 1px solid #444;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 5px;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #444;
        }
        .suggestion-item:hover {
            background: #2d2d2d;
        }
        /* Tag Autocomplete */
        .tag-autocomplete {
            position: absolute;
            background: rgba(34, 34, 34, 0.95);
            border: 1px solid #444;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 2px;
        }
        .tag-suggestion {
            padding: 6px 10px;
            cursor: pointer;
            font-size: 11px;
        }
        .tag-suggestion:hover {
            background: #2d2d2d;
        }
        /* Bulk Selection removed */
        /* .bulk-select-checkbox {
            margin-right: 8px;
        }
        .bulk-actions-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(34, 34, 34, 0.95);
            border-top: 2px solid #0073e6;
            padding: 10px 20px;
            display: none;
            z-index: 999;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
        }
        .bulk-actions-bar.active {
            display: flex;
            justify-content: space-between;
            align-items: center;
        } */
        /* Better Animations */
        .copy-container {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Export Format Selector */
        .export-format-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .format-button {
            padding: 6px 12px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            color: #ddd;
            cursor: pointer;
        }
        .format-button.active {
            background: #0073e6;
            border-color: #0073e6;
            color: white;
        }
        /* Command Palette - VS Code Style */
        .command-palette {
            display: none;
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 90vw;
            background: rgba(34, 34, 34, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 10001;
            overflow: hidden;
        }
        .command-palette.active {
            display: block;
            animation: commandPaletteSlide 0.2s ease;
        }
        @keyframes commandPaletteSlide {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        .command-palette-input {
            width: 100%;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-size: 16px;
            outline: none;
        }
        .command-palette-results {
            max-height: 400px;
            overflow-y: auto;
        }
        .command-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }
        .command-item:hover,
        .command-item.selected {
            background: rgba(0, 115, 230, 0.2);
        }
        .command-item-icon {
            margin-right: 10px;
            font-size: 18px;
        }
        .command-item-content {
            flex: 1;
        }
        .command-item-title {
            color: #fff;
            font-weight: 500;
        }
        .command-item-desc {
            color: #aaa;
            font-size: 12px;
            margin-top: 2px;
        }
        .command-item-shortcut {
            color: #666;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
        }
        /* Quick Actions Floating Button */
        .quick-actions-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0073e6, #005bb5);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 115, 230, 0.4);
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quick-actions-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0, 115, 230, 0.6);
        }
        .quick-actions-menu {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: rgba(34, 34, 34, 0.98);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            animation: slideUp 0.2s ease;
        }
        .quick-actions-menu.active {
            display: block;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .quick-action-item {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .quick-action-item:hover {
            background: rgba(0, 115, 230, 0.2);
        }
        /* Snippet Preview on Hover */
        .snippet-preview {
            position: absolute;
            background: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border);
            border-radius: 8px;
            padding: 15px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.6;
            color: var(--theme-text-primary);
        }
        .copy-container:hover .snippet-preview {
            display: block;
        }
        /* Quick Access Panel */
        .quick-access-panel {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 300px;
            background: rgba(20, 20, 35, 0.95);
            border-right: 1px solid rgba(255, 215, 0, 0.2);
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            backdrop-filter: blur(20px);
        }
        .quick-access-panel.active {
            transform: translateX(0);
        }
        .quick-access-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quick-access-title {
            color: #ffd700;
            font-weight: 600;
            font-size: 18px;
        }
        .quick-access-item {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quick-access-item:hover {
            background: rgba(0, 115, 230, 0.2);
        }
        .quick-access-item-icon {
            font-size: 18px;
        }
        /* Context Menu */
        .context-menu {
            position: fixed;
            background: rgba(34, 34, 34, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 5px;
            z-index: 10000;
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: rgba(0, 115, 230, 0.2);
        }
        .context-menu-separator {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }
        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(34, 34, 34, 0.8);
            border: 1px solid #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1000;
            transition: all 0.3s;
        }
        .theme-toggle:hover {
            background: rgba(0, 115, 230, 0.2);
            transform: scale(1.1);
        }
        /* Notes toggle button - Modern App Icon Style */
        .notepad-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 28px;
            height: 28px;
            border-radius: 7px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4), 
                        0 1px 2px rgba(0, 0, 0, 0.3),
                        0 0 4px rgba(255, 255, 255, 0.8),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .notepad-toggle:hover {
            background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
            border-color: #ffffff;
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5), 
                        0 2px 4px rgba(0, 0, 0, 0.4),
                        0 0 6px rgba(255, 255, 255, 1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        .notepad-toggle:active {
            transform: translateY(0) scale(1.02);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        .notepad-toggle.active {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border-color: #ffffff;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.6),
                        0 1px 3px rgba(0, 0, 0, 0.3),
                        0 0 5px rgba(255, 255, 255, 1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        .notepad-toggle.active:hover {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            box-shadow: 0 3px 12px rgba(255, 255, 255, 0.7),
                        0 2px 5px rgba(0, 0, 0, 0.3),
                        0 0 7px rgba(255, 255, 255, 1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        .notepad-toggle span {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
        }
        .notepad-toggle:hover span {
            transform: scale(1.1);
        }
        /* Inline Notes Toggle Button (inside notes sidebar) */
        .notepad-toggle-inline {
            width: 28px;
            height: 28px;
            border-radius: 7px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4), 
                        0 1px 2px rgba(0, 0, 0, 0.3),
                        0 0 4px rgba(255, 255, 255, 0.8),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        .notepad-toggle-inline:hover {
            background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
            border-color: #ffffff;
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5), 
                        0 2px 4px rgba(0, 0, 0, 0.4),
                        0 0 6px rgba(255, 255, 255, 1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        .notepad-toggle-inline:active {
            transform: translateY(0) scale(1.02);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        .notepad-toggle-inline span {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transition: transform 0.3s ease;
        }
        .notepad-toggle-inline:hover span {
            transform: scale(1.1);
        }
        /* Light Theme */
        body.light-theme {
            background: #f5f5f5;
            color: #333;
        }
        body.light-theme #copy-text-manager {
            background: #ffffff;
            color: #333;
        }
        body.light-theme .copy-button {
            background-color: #0073e6;
            color: white;
        }
        body.light-theme .modal-content {
            background-color: rgba(255, 255, 255, 0.98);
            color: #333;
        }
        /* Smart Suggestions */
        .smart-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(34, 34, 34, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suggestion-item:hover {
            background: rgba(0, 115, 230, 0.2);
        }
        .suggestion-match {
            color: #ffd700;
            font-weight: 600;
        }
        /* Snippet Variables */
        .variable-tag {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-family: monospace;
            margin: 0 2px;
        }
        /* Usage Badge */
        .usage-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(76, 175, 80, 0.8);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        /* Smooth Transitions */
        * {
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }
        /* Quick Paste Menu */
        .quick-paste-menu {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: rgba(34, 34, 34, 0.98);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 10px;
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        .quick-paste-menu.active {
            display: block;
        }
        .quick-paste-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .quick-paste-item:hover {
            background: rgba(0, 115, 230, 0.2);
            border-color: #0073e6;
        }
        .quick-paste-item-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }
        .quick-paste-item-preview {
            font-size: 11px;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* Enhanced Copy Button */
        .copy-button {
            position: relative;
            overflow: visible;
            transition: var(--theme-transition);
            box-shadow: 0 2px 8px var(--theme-shadow);
        }
        .copy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--theme-shadow-heavy);
        }
        .copy-button:focus,
        .copy-button:active {
            outline: none;
            box-shadow: 0 2px 8px var(--theme-shadow);
        }
        .copy-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(76, 175, 80, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .copy-button.copied::after {
            width: 300px;
            height: 300px;
        }
        /* Smart Search Highlight */
        .search-match {
            background: rgba(255, 215, 0, 0.4);
            padding: 2px 0;
            border-radius: 2px;
        }
        /* Pulse Animation for New Items */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .new-item {
            animation: pulse 2s infinite;
        }
        /* Drag Preview */
        .drag-preview {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        /* Focus Ring - Removed blue outline */
        .copy-container:focus-within {
            outline: none;
        }
        /* Smart Shortcuts System */
        .shortcut-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 215, 0, 0.8);
            color: #1a1a2e;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 8px;
            font-weight: 700;
            font-family: monospace;
            z-index: 10;
        }
        /* Rich Text Preview */
        .rich-text-preview {
            max-width: 500px;
            padding: 15px;
            background: rgba(20, 20, 30, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
        }
        .rich-text-preview code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .rich-text-preview pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        /* Duplicate Detection */
        .duplicate-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left: 3px solid #ff9800;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .duplicate-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        /* Keyboard Navigation Indicator */
        .keyboard-nav-active .copy-container:focus {
            outline: none;
            transform: scale(1.02);
        }
        /* Smart Collections */
        .collection-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(156, 39, 176, 0.3);
            color: #ce93d8;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        /* Snippet Encryption */
        .encrypted-badge {
            background: rgba(244, 67, 54, 0.3);
            color: #ef5350;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            margin-left: 5px;
        }
        /* Quick Insert Modal */
        .quick-insert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(34, 34, 34, 0.98);
            border: 2px solid #0073e6;
            border-radius: 12px;
            padding: 20px;
            z-index: 10001;
            min-width: 500px;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }
        .quick-insert-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .quick-insert-item {
            padding: 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .quick-insert-item:hover,
        .quick-insert-item.selected {
            background: rgba(0, 115, 230, 0.2);
            border-color: #0073e6;
        }
        /* Smart Suggestions Panel */
        .smart-suggestions-panel {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(34, 34, 34, 0.95);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 15px;
            width: 250px;
            max-height: 60vh;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .smart-suggestions-panel.active {
            display: block;
        }
        .suggestion-header {
            color: #ffd700;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }
        /* Snippet Groups/Collections */
        .collection-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(156, 39, 176, 0.1);
            border-left: 3px solid #9c27b0;
            margin: 10px 0;
            border-radius: 4px;
        }
        /* Enhanced Animations */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-slide-down {
            animation: slideDown 0.3s ease;
        }
        .animate-scale-in {
            animation: scaleIn 0.3s ease;
        }
        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0073e6, #005bb5);
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -100% 0; }
            100% { background-position: 100% 0; }
        }
        /* Smart Search Results */
        .search-results-count {
            padding: 5px 10px;
            background: rgba(0, 115, 230, 0.2);
            border-radius: 12px;
            font-size: 11px;
            color: #0073e6;
            margin-left: 10px;
        }
        /* Enhanced Copy Button States */
        .copy-button.copied {
            background: linear-gradient(135deg, #4caf50, #45a049);
            animation: copySuccess 0.6s ease;
        }
        @keyframes copySuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        /* Snippet Metadata */
        .snippet-metadata {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            font-size: 10px;
            color: #666;
        }
        .metadata-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        /* Smart Folders */
        .smart-folder {
            background: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4caf50;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        /* Accessibility - Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #0073e6;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 20000;
        }
        .skip-link:focus {
            top: 0;
        }
        /* High Contrast Mode */
        body.high-contrast {
            filter: contrast(1.2);
        }
        body.high-contrast .copy-button {
            border: 2px solid currentColor;
        }
        /* Mobile Swipe Gestures */
        .swipeable {
            touch-action: pan-y;
        }
        .swipe-indicator {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #4caf50;
            transform: scaleX(0);
            transition: transform 0.3s;
        }
        .swipeable.swiping .swipe-indicator {
            transform: scaleX(1);
        }
        /* Voice Command Interface */
        .voice-command {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e91e63, #f06292);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(233, 30, 99, 0.4);
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .voice-command:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(233, 30, 99, 0.6);
        }
        .voice-command.listening {
            animation: pulse-voice 1.5s infinite;
            background: linear-gradient(135deg, #f44336, #e91e63);
        }
        @keyframes pulse-voice {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 20px rgba(233, 30, 99, 0.4); }
            50% { transform: scale(1.15); box-shadow: 0 6px 40px rgba(233, 30, 99, 0.8); }
        }
        .voice-status {
            position: fixed;
            bottom: 170px;
            right: 30px;
            background: rgba(34, 34, 34, 0.98);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 15px;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        .voice-status.active {
            display: block;
            animation: slideUp 0.2s ease;
        }
        /* Advanced Analytics Dashboard */
        .analytics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .analytics-card {
            background: rgba(20, 20, 35, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .analytics-value {
            font-size: 32px;
            font-weight: 700;
            color: #ffd700;
            margin: 10px 0;
        }
        .analytics-label {
            color: #aaa;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .analytics-chart {
            height: 100px;
            margin-top: 15px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 5px;
        }
        .chart-bar {
            background: linear-gradient(180deg, #0073e6, #005bb5);
            width: 20px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
        }
        .chart-bar:hover {
            background: linear-gradient(180deg, #ffd700, #ffed4e);
            transform: scaleY(1.1);
        }
        /* Advanced Filters */
        .advanced-filters {
            background: rgba(20, 20, 35, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .filter-chip {
            padding: 6px 12px;
            background: rgba(0, 115, 230, 0.2);
            border: 1px solid #0073e6;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip:hover {
            background: rgba(0, 115, 230, 0.4);
        }
        .filter-chip.active {
            background: #0073e6;
            color: white;
        }
        /* Snippet Expiration */
        .expiration-badge {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            margin-left: 5px;
        }
        .expiration-badge.expired {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }
        /* Performance Monitor */
        .performance-monitor {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(34, 34, 34, 0.9);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            font-size: 10px;
            z-index: 9999;
            display: none;
            font-family: monospace;
        }
        .performance-monitor.active {
            display: block;
        }
        /* Share Snippet */
        .share-button {
            padding: 4px 8px;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            border-radius: 4px;
            color: #4caf50;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .share-button:hover {
            background: rgba(76, 175, 80, 0.4);
        }
        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        /* ARIA Improvements */
        [role="button"]:focus,
        button:focus,
        input:focus,
        textarea:focus {
            outline: none;
        }
        /* Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        /* Contextual Help Button */
        .contextual-help {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196F3, #42a5f5);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .contextual-help:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(33, 150, 243, 0.6);
        }
        .contextual-help.active {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
        }
        /* Inline Help Icons */
        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
            font-size: 11px;
            text-align: center;
            line-height: 16px;
            cursor: help;
            margin-left: 5px;
            font-weight: 700;
        }
        .help-icon:hover {
            background: rgba(33, 150, 243, 0.4);
        }
        /* Smart Defaults Indicator */
        .smart-default {
            position: relative;
        }
        .smart-default::before {
            content: '✨';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 14px;
            z-index: 10;
        }
        /* Feature Highlight */
        .feature-highlight {
            position: relative;
        }
        .feature-highlight::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #ffd700;
            border-radius: 8px;
            animation: highlightGlow 2s infinite;
            pointer-events: none;
        }
        @keyframes highlightGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        /* Progress Indicator */
        .feature-progress {
            position: fixed;
            bottom: 100px;
            right: 100px;
            background: rgba(34, 34, 34, 0.95);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 15px;
            min-width: 200px;
            z-index: 1000;
            display: none;
        }
        .feature-progress.active {
            display: block;
        }
        .progress-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffd700;
        }
        .progress-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
            font-size: 12px;
        }
        .progress-check {
            color: #4caf50;
            font-weight: 700;
        }
        /* Auto-Save Indicator */
        .auto-save-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 9999;
            display: none;
            animation: fadeInOut 2s ease;
        }
        .auto-save-indicator.active {
            display: block;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-10px); }
            20%, 80% { opacity: 1; transform: translateY(0); }
        }
        /* Smart Search Suggestions */
        .search-suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(34, 34, 34, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .search-suggestions-dropdown.active {
            display: block;
        }
        .search-suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }
        .search-suggestion-item:hover {
            background: rgba(0, 115, 230, 0.2);
        }
        .search-suggestion-item.selected {
            background: rgba(0, 115, 230, 0.3);
        }
        /* Keyboard Shortcut Display */
        .keyboard-shortcut-display {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-family: monospace;
            margin-left: 8px;
        }
        .keyboard-key {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Micro-Interactions */
        .micro-bounce {
            animation: microBounce 0.5s ease;
        }
        @keyframes microBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .micro-shake {
            animation: microShake 0.5s ease;
        }
        @keyframes microShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .micro-glow {
            animation: microGlow 1s ease;
        }
        @keyframes microGlow {
            0%, 100% { box-shadow: 0 0 0 rgba(0, 115, 230, 0); }
            50% { box-shadow: 0 0 20px rgba(0, 115, 230, 0.6); }
        }
        /* Smart Defaults Indicator */
        .smart-default-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }
        /* Visual Feedback for Actions */
        .action-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(76, 175, 80, 0.95);
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 25000;
            display: none;
            box-shadow: 0 10px 40px rgba(76, 175, 80, 0.5);
        }
        .action-feedback.active {
            display: block;
            animation: feedbackPop 0.5s ease;
        }
        @keyframes feedbackPop {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        /* Smart Tooltips */
        .smart-tooltip {
            position: absolute;
            background: rgba(20, 20, 30, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 12px;
            color: #ddd;
            z-index: 10000;
            max-width: 250px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: tooltipFadeIn 0.2s ease;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .smart-tooltip::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 6px solid transparent;
        }
        .smart-tooltip.top::after {
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            border-top-color: rgba(20, 20, 30, 0.98);
        }
        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s;
        }
        .progress-step.completed {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }
        .progress-step.active {
            background: #0073e6;
            border-color: #0073e6;
            color: white;
            animation: stepPulse 2s infinite;
        }
        @keyframes stepPulse {
            0%, 100% { box-shadow: 0 0 0 rgba(0, 115, 230, 0); }
            50% { box-shadow: 0 0 20px rgba(0, 115, 230, 0.6); }
        }
        /* Success Celebration */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 40000;
        }
        .celebration-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: celebrate 1s ease-out forwards;
        }
        @keyframes celebrate {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
        /* Glow Effects */
        .glow-on-hover:hover {
            box-shadow: 0 0 20px rgba(0, 115, 230, 0.5);
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-spinner-large {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #0073e6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        /* Keyboard Shortcut Display */
        .shortcut-display {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }
        .shortcut-key-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
    <style>
        /* Main container to ensure snippet is contained */
        #copy-text-manager {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--theme-text-primary);
            padding: var(--theme-spacing);
            margin: 0;
            position: relative;
            overflow-x: hidden;
            background: var(--theme-bg-primary);
            border-radius: var(--theme-radius);
            min-height: 400px;
            transition: var(--theme-transition);
            box-shadow: 0 4px 20px var(--theme-shadow);
        }
        #copy-text-manager .tabs {
            display: flex;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
            z-index: 1;
        }
        #copy-text-manager .tab-button {
            padding: 8px 16px;
            border: 2px solid var(--theme-border);
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: var(--theme-radius-small);
            transition: var(--theme-transition);
            white-space: nowrap;
            user-select: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--theme-bg-secondary);
            color: var(--theme-text-secondary);
            min-width: min-content;
            flex: 0 1 auto;
            font-weight: 500;
            box-shadow: 0 2px 4px var(--theme-shadow);
        }
        #copy-text-manager .tab-button.active {
            background-color: var(--theme-accent);
            color: #000000;
            border-color: var(--theme-accent);
            box-shadow: 0 4px 8px var(--theme-shadow);
            transform: translateY(-1px);
            font-weight: 600;
        }
        #copy-text-manager .tab-button:hover:not(.active) {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--theme-shadow);
        }
        #copy-text-manager .tab-content {
            display: none;
            padding-top: 10px;
            z-index: 1;
        }
        #copy-text-manager .tab-content.active {
            display: block;
        }
        #copy-text-manager .copy-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
            flex-wrap: wrap;
            z-index: 1;
        }
        #copy-text-manager .copy-container.drag-over {
            background-color: var(--theme-bg-tertiary);
            border-radius: var(--theme-radius-small);
            box-shadow: 0 0 0 2px var(--theme-accent);
        }
        #copy-text-manager .hidden-textarea {
            display: none;
            flex: 1;
            margin-right: 10px;
            border: 1px solid var(--theme-border);
            padding: 8px;
            border-radius: 4px;
            font-size: 1rem;
            min-height: 100px;
            background-color: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            user-select: none;
            outline: none;
        }
        #copy-text-manager .hidden-textarea:focus {
            outline: none;
        }
        #copy-text-manager .hidden-textarea.edit-mode {
            user-select: text;
        }
        #copy-text-manager .hidden-input {
            display: none;
            flex: 1;
            margin-right: 10px;
            border: 1px solid var(--theme-border);
            padding: 8px;
            border-radius: 4px;
            font-size: 1rem;
            background-color: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            user-select: none;
            outline: none;
        }
        #copy-text-manager .hidden-input:focus {
            outline: none;
        }
        #copy-text-manager .hidden-input.edit-mode {
            user-select: text;
        }
        #copy-text-manager .copy-button {
            padding: 8px 12px;
            background-color: #0073e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            user-select: none;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            outline: none;
        }
        #copy-text-manager .copy-button:hover {
            background-color: #005bb5;
        }
        #copy-text-manager .copy-button:focus,
        #copy-text-manager .copy-button:active {
            outline: none;
            box-shadow: none;
        }
        #copy-text-manager .edit-button-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 5px;
        }
        #copy-text-manager .edit-button, #copy-text-manager .add-subtext-button {
            height: 24px;
            width: 24px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #copy-text-manager .edit-button {
            padding: 6px;
            font-size: 12px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.1) 100%);
            color: #ffd700 !important;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6), 0 0 12px rgba(255, 215, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 3px;
            opacity: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        #copy-text-manager .edit-button:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 193, 7, 0.2) 100%);
            border-color: rgba(255, 215, 0, 0.6);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            transform: scale(1.05);
            opacity: 1;
        }
        #copy-text-manager .copy-success {
            margin-left: 10px;
            font-size: 14px;
            color: #00ff77;
            visibility: hidden;
            user-select: none;
        }
        #copy-text-manager .show-success {
            visibility: visible;
        }
        #copy-text-manager .add-remove-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            margin-top: 5px;
            z-index: 1;
        }
        #copy-text-manager .text-control-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 0px;
            margin-top: -5px;
            z-index: 1;
        }
        #copy-text-manager .add-remove-button {
            padding: 8px 12px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }
        #copy-text-manager .add-remove-button:hover {
            background-color: #45a049;
        }
        #copy-text-manager .add-remove-button-section {
            padding: 8px 12px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }
        #copy-text-manager .add-remove-button-section:hover {
            background-color: #e68a00;
        }
        #copy-text-manager .remove-section-button {
            padding: 8px 12px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }
        #copy-text-manager .remove-section-button:hover {
            background-color: darkred;
        }
        #copy-text-manager .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        #copy-text-manager .modal-content {
            background-color: rgba(34, 34, 34, 0.95);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-color: #aaa;
            border-radius: 5px;
            color: #fff;
        }
        #copy-text-manager .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        #copy-text-manager .close:hover,
        #copy-text-manager .close:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        #copy-text-manager .section-list {
            list-style: none;
            padding: 0;
        }
        #copy-text-manager .section-list-item {
            padding: 10px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            background-color: #252525; /* Lighter black */
            color: #aaa;
        }
        #copy-text-manager .section-list-item:hover {
            background-color: #2d2d2d; /* Even lighter black on hover */
            color: #ddd;
        }
        #copy-text-manager .import-export-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
            z-index: 1;
        }
        #copy-text-manager .import-export-button {
            padding: 6px 8px;
            background-color: #0073e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
        }
        #copy-text-manager .import-export-button:hover {
            background-color: #005bb5;
        }
        #copy-text-manager .search-container {
            position: absolute;
            top: 10px;
            right: 20px;
            z-index: 2;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #copy-text-manager .notepad-button {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #copy-text-manager .notepad-button:hover {
            background-color: #1976D2;
        }
        #copy-text-manager .notepad-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--theme-bg-primary);
            z-index: 9999;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
        }
        #copy-text-manager .notepad-content {
            background-color: var(--theme-bg-primary);
            width: 100%;
            height: 100%;
            display: flex;
            position: relative;
            overflow: hidden;
        }
        #copy-text-manager #notepadCategoryMenu {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 100001 !important;
        }
        
        /* Sidebar */
        #copy-text-manager .notepad-sidebar {
            width: 320px;
            background-color: var(--theme-bg-secondary);
            border-right: 1px solid var(--theme-border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        #copy-text-manager .notepad-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--theme-border);
            background-color: var(--theme-bg-tertiary);
            gap: 10px;
        }
        #copy-text-manager .notepad-new-note-btn-header {
            padding: 6px 12px;
            background-color: var(--theme-accent);
            color: #000000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            margin-left: auto;
            margin-right: 10px;
        }
        #copy-text-manager .notepad-new-note-btn-header:hover {
            background-color: var(--theme-accent-hover);
        }
        #copy-text-manager .notepad-title {
            color: var(--theme-text-primary);
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        #copy-text-manager .notepad-close-btn {
            background: none;
            border: none;
            color: var(--theme-text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        #copy-text-manager .notepad-close-btn:hover {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }
        
        /* Search removed */
        
        /* Categories */
        #copy-text-manager .notepad-categories {
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }
        #copy-text-manager .notepad-category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            margin: 4px 0;
            border-radius: 6px;
            cursor: pointer;
            color: var(--theme-text-secondary);
            border: 1px solid transparent;
            transition: all 0.2s;
            font-size: 14px;
            position: relative;
        }
        #copy-text-manager .notepad-delete-category {
            opacity: 0;
            transition: opacity 0.2s;
        }
        #copy-text-manager .notepad-category-item:hover .notepad-delete-category {
            opacity: 1;
        }
        #copy-text-manager .notepad-delete-category:hover {
            background-color: rgba(244, 67, 54, 0.2);
        }
        #copy-text-manager .notepad-edit-category {
            opacity: 0;
            transition: opacity 0.2s;
        }
        #copy-text-manager .notepad-category-item:hover .notepad-edit-category {
            opacity: 1;
        }
        #copy-text-manager .notepad-edit-category:hover {
            background-color: rgba(255, 215, 0, 0.2);
        }
        #copy-text-manager .notepad-category-item:hover {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }
        #copy-text-manager .notepad-category-item.active {
            background-color: var(--theme-accent);
            color: #000000;
            border-color: var(--theme-accent);
            font-weight: 500;
        }
        #copy-text-manager .notepad-category-item span:first-child {
            margin-right: 8px;
        }
        #copy-text-manager .note-count {
            background-color: var(--theme-bg-tertiary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--theme-text-secondary);
        }
        #copy-text-manager .notepad-category-item.active .note-count {
            background-color: rgba(0, 0, 0, 0.15);
            color: #000000;
            font-weight: 600;
        }
        #copy-text-manager .notepad-category-divider {
            height: 1px;
            background-color: var(--theme-border);
            margin: 10px 0;
        }
        #copy-text-manager .notepad-add-category-btn {
            width: 100%;
            padding: 10px;
            background-color: var(--theme-bg-tertiary);
            border: 1px dashed var(--theme-border);
            border-radius: 6px;
            color: var(--theme-text-primary);
            cursor: pointer;
            font-size: 13px;
            margin-top: 5px;
            transition: all 0.2s;
        }
        #copy-text-manager .notepad-add-category-btn:hover {
            background-color: var(--theme-bg-secondary);
            border-color: var(--theme-accent);
        }
        
        /* Notes Tabs Container (Browser-like) */
        #copy-text-manager .notepad-tabs-container {
            display: flex;
            align-items: center;
            background-color: var(--theme-bg-tertiary);
            border-bottom: 1px solid var(--theme-border);
            height: 45px;
            overflow-x: auto;
            overflow-y: hidden;
        }
        #copy-text-manager .notepad-tabs {
            display: flex;
            align-items: flex-end;
            height: 100%;
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
        }
        #copy-text-manager .notepad-tab {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background-color: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            color: var(--theme-text-secondary);
            font-size: 13px;
            white-space: nowrap;
            max-width: 200px;
            min-width: 120px;
            margin-right: 2px;
            transition: all 0.2s;
            position: relative;
        }
        #copy-text-manager .notepad-tab:hover {
            background-color: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }
        #copy-text-manager .notepad-tab.active {
            background-color: var(--theme-accent);
            color: #000000;
            border-color: var(--theme-accent);
            border-bottom-color: transparent;
            z-index: 1;
        }
        #copy-text-manager .notepad-tab.drag-over {
            background-color: var(--theme-bg-tertiary);
            border-color: var(--theme-accent);
        }
        #copy-text-manager .notepad-tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        #copy-text-manager .notepad-tab-close {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
            font-size: 14px;
            line-height: 1;
        }
        #copy-text-manager .notepad-tab-close:hover {
            opacity: 1;
            background-color: rgba(244, 67, 54, 0.2);
        }
        #copy-text-manager .notepad-new-tab-btn {
            padding: 8px 12px;
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            border-radius: 4px;
        }
        #copy-text-manager .notepad-new-tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        #copy-text-manager .notepad-item {
            padding: 12px;
            margin: 6px 0;
            background-color: rgba(40, 40, 40, 0.6);
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        #copy-text-manager .notepad-item:hover {
            background-color: rgba(50, 50, 50, 0.8);
            border-color: #444;
        }
        #copy-text-manager .notepad-item.active {
            background-color: rgba(0, 115, 230, 0.15);
            border-color: #0073e6;
        }
        #copy-text-manager .notepad-item-title {
            font-weight: 500;
            color: #fff;
            margin-bottom: 4px;
            font-size: 14px;
        }
        #copy-text-manager .notepad-item-preview {
            font-size: 12px;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 4px;
        }
        #copy-text-manager .notepad-item-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            font-size: 11px;
            color: #666;
        }
        #copy-text-manager .notepad-item-favorite {
            color: #ffd700;
            font-size: 12px;
        }
        #copy-text-manager .notepad-item-date {
            color: #666;
        }
        
        /* New Note Button */
        #copy-text-manager .notepad-new-note-btn {
            margin: 10px;
            padding: 12px;
            background-color: #0073e6;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        #copy-text-manager .notepad-new-note-btn:hover {
            background-color: #005bb5;
            transform: translateY(-1px);
        }
        
        /* Main Editor Area */
        #copy-text-manager .notepad-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        #copy-text-manager .notepad-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--theme-border);
            background-color: var(--theme-bg-secondary);
        }
        #copy-text-manager .notepad-editor-title-section {
            flex: 1;
        }
        #copy-text-manager .notepad-title-input {
            width: 100%;
            background: none;
            border: none;
            color: var(--theme-text-primary);
            font-size: 1.4em;
            font-weight: 600;
            padding: 5px 0;
            margin-bottom: 5px;
        }
        #copy-text-manager .notepad-title-input:focus {
            outline: none;
            border-bottom: 2px solid var(--theme-accent);
        }
        #copy-text-manager .notepad-meta-info {
            font-size: 12px;
            color: var(--theme-text-secondary);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #copy-text-manager .notepad-stats {
            color: var(--theme-text-secondary);
            font-size: 11px;
        }
        #copy-text-manager .notepad-save-indicator {
            color: #4caf50;
            font-size: 11px;
            animation: fadeInOut 2s ease;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        #copy-text-manager .notepad-editor-actions {
            display: flex;
            gap: 8px;
        }
        #copy-text-manager .notepad-action-btn {
            background: var(--theme-bg-tertiary);
            border: 1px solid var(--theme-border);
            border-radius: 6px;
            color: var(--theme-text-primary);
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }
        #copy-text-manager .notepad-action-btn:hover {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: #000000;
        }
        #copy-text-manager .notepad-action-btn.danger:hover {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }
        #copy-text-manager .notepad-action-btn.active {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: #000000;
        }
        #copy-text-manager .notepad-action-btn.favorite-active {
            color: #ffd700;
        }
        
        /* Editor */
        #copy-text-manager .notepad-editor {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #copy-text-manager .notepad-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--theme-text-secondary);
            text-align: center;
            padding: 40px;
        }
        #copy-text-manager .notepad-empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        #copy-text-manager .notepad-empty-state h3 {
            color: var(--theme-text-secondary);
            margin: 10px 0;
        }
        #copy-text-manager .notepad-empty-state p {
            color: var(--theme-text-secondary);
            margin-bottom: 20px;
        }
        #copy-text-manager .notepad-new-note-btn-large {
            padding: 12px 24px;
            background-color: var(--theme-accent);
            border: none;
            border-radius: 6px;
            color: #000000;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        #copy-text-manager .notepad-new-note-btn-large:hover {
            background-color: var(--theme-accent-hover);
        }
        #copy-text-manager .notepad-template-btn {
            padding: 10px 20px;
            background-color: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border);
            border-radius: 6px;
            color: var(--theme-text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        #copy-text-manager .notepad-template-btn:hover {
            background-color: var(--theme-accent);
            color: #000000;
        }
        #copy-text-manager .notepad-textarea {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--theme-bg-primary);
            border: none;
            color: var(--theme-text-primary);
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 15px;
            line-height: 1.6;
            resize: none;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #copy-text-manager .notepad-textarea:focus {
            outline: none;
        }
        #copy-text-manager .notepad-textarea::placeholder {
            color: var(--theme-text-secondary);
        }
        #copy-text-manager .hidden-text-filtered {
            display: none;
        }
        #copy-text-manager #import-textarea,
        #copy-text-manager #export-textarea {
            width: 98%;
            min-height: 100px;
            background-color: rgba(34, 34, 34, 0.8);
            color: #ddd;
            border: 1px solid #444;
            margin-bottom: 10px;
            resize: vertical;
            border-radius: 4px;
            padding: 8px;
        }
        #copy-text-manager #import-container {
            margin-bottom: 10px;
            padding: 15px;
            background-color: rgba(34, 34, 34, 0.9);
            border: 1px solid #444;
            border-radius: 5px;
            display: none;
        }
        #copy-text-manager .subtext-container {
            margin-left: 30px;
            border-left: 2px solid #444;
            padding-left: 10px;
            display: none;
        }
        #copy-text-manager .subtext-container.show {
            display: block;
        }
        #copy-text-manager .toggle-subtext {
            padding: 2px 6px;
            font-size: 12px;
            background-color: rgba(51, 51, 51, 0.8);
            color: #aaa;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            transition: background-color 0.2s ease;
            display: none;
        }
        #copy-text-manager .toggle-subtext.has-subtexts {
            display: inline-block;
        }
        #copy-text-manager .toggle-subtext:hover {
            background-color: rgba(68, 68, 68, 0.8);
            color: #ddd;
        }
        #copy-text-manager .add-subtext-button {
            padding: 4px 6px;
            font-size: 12px;
            background-color: #2a9d8f;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
            transition: background-color 0.2s ease;
        }
        #copy-text-manager .add-subtext-button:hover {
            background-color: #238b7e;
        }
        #copy-text-manager .rename-section-button {
            padding: 8px 12px;
            background-color: #9c27b0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }
        #copy-text-manager .rename-section-button:hover {
            background-color: #7b1fa2;
        }
        #copy-text-manager .subtext-list-container {
            border-left: 2px solid #444;
            margin-left: 12px;
            margin-top: -1px;
            margin-bottom: 5px;
        }
        #copy-text-manager .subtext-list-container .section-list-item {
            border-bottom: 1px solid #444;
            border-top: none;
        }
        #copy-text-manager #newSectionName {
            background-color: rgba(34, 34, 34, 0.8);
            color: #ddd;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        #copy-text-manager .pages-container {
            margin-bottom: 5px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        #copy-text-manager .pages-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
        }
        #copy-text-manager .pages-buttons {
            display: flex;
            gap: 5px;
        }
        #copy-text-manager .pages-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 0;
            margin: 0;
            flex: 1;
        }
        #copy-text-manager .pages-list-item.manage-item {
            font-size: 9px;
            opacity: 1;
            padding: 4px 4px;
            color: #ffd700 !important;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6), 0 0 12px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.1) 100%);
            border: 1px solid rgba(255, 215, 0, 0.4);
            margin-right: 5px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        #copy-text-manager .pages-list-item.manage-item:hover {
            opacity: 1;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 193, 7, 0.2) 100%);
            border-color: rgba(255, 215, 0, 0.6);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
        #copy-text-manager .tab-button.manage-sections-btn {
            font-size: 9px;
            opacity: 1;
            color: #ffd700 !important;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6), 0 0 12px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.1) 100%);
            border: 1px solid rgba(255, 215, 0, 0.4);
            padding: 4px 4px;
            margin-right: 5px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        #copy-text-manager .tab-button.manage-sections-btn:hover {
            opacity: 1;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 193, 7, 0.2) 100%);
            border-color: rgba(255, 215, 0, 0.6);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
        #copy-text-manager .manage-text-btn {
            font-size: 9px;
            opacity: 1;
            color: #ffd700 !important;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6), 0 0 12px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.1) 100%);
            border: 1px solid rgba(255, 215, 0, 0.4);
            padding: 4px 4px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0px;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            box-sizing: border-box;
        }
        #copy-text-manager .manage-text-btn:hover {
            opacity: 1;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 193, 7, 0.2) 100%);
            border-color: rgba(255, 215, 0, 0.6);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
        #copy-text-manager .edit-button {
            color: #ffd700 !important;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6), 0 0 12px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.1) 100%);
            border: 1px solid rgba(255, 215, 0, 0.4);
        }
        #copy-text-manager .edit-button:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 193, 7, 0.2) 100%);
            border-color: rgba(255, 215, 0, 0.6);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            transform: scale(1.05);
        }
        #copy-text-manager .pages-list-item {
            padding: 6px 12px;
            border: 1px solid #444;
            cursor: pointer;
            background-color: rgba(34, 34, 34, 0.8);
            color: #aaa;
            border-radius: 4px;
            margin: 0;
            transition: background-color 0.2s ease;
        }
        #copy-text-manager .pages-list-item:hover {
            background-color: rgba(68, 68, 68, 0.8);
            color: #ddd;
        }
        #copy-text-manager .pages-list-item.active {
            background-color: var(--theme-accent);
            color: #000000;
            border-color: var(--theme-accent);
            font-weight: 600;
        }
        #copy-text-manager .pages-list-item.drag-over {
            background-color: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            border-style: dashed;
        }
        #copy-text-manager .dropdown {
            position: relative;
            display: inline-block;
        }
        #copy-text-manager .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(34, 34, 34, 0.95);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            border: 1px solid #444;
        }
        #copy-text-manager .dropdown-content button {
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            border: none;
            background: none;
            color: #ddd;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: block;
        }
        #copy-text-manager .dropdown-content button:hover {
            background-color: rgba(68, 68, 68, 0.8);
        }
        #copy-text-manager .dropdown:hover .dropdown-content {
            display: block;
        }
        #copy-text-manager .manage-button {
            padding: 8px 12px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #copy-text-manager .manage-button:hover {
            background-color: #e68a00;
        }
        #copy-text-manager .management-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            padding: 5px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="copy-text-manager" role="main" id="main-content">
        <!-- Settings Menu Button -->
        <button class="settings-button" onclick="toggleSettingsMenu()" title="Settings & Options">
            <span>⚙️</span>
        </button>
        <div class="settings-menu" id="settingsMenu">
            <div class="settings-menu-title">Settings & Options</div>
            <div class="settings-option" onclick="showExportOptions(); closeSettingsMenu();">
                <span class="settings-icon">⬇</span>
                <span class="settings-name">Export Data</span>
            </div>
            <div class="settings-option" onclick="toggleImport(); closeSettingsMenu();">
                <span class="settings-icon">⬆</span>
                <span class="settings-name">Import Data</span>
            </div>
            <div class="settings-divider"></div>
            <div class="settings-option" onclick="showLayersManager(); closeSettingsMenu();">
                <span class="settings-icon">📚</span>
                <span class="settings-name">Manage Layers</span>
            </div>
            <div class="settings-divider"></div>
            <!-- Future settings can be added here -->
        </div>
        
        <!-- Notes Toggle (replaces theme toggle) -->
        <button class="theme-toggle notepad-toggle" onclick="toggleNotepad()" data-tooltip="Toggle Notes" title="Open/Close Notes">
            <span>📝</span>
        </button>
        
        <!-- Command Palette -->
        <div class="command-palette" id="commandPalette">
            <input type="text" class="command-palette-input" id="commandInput" placeholder="Type a command or search... (Esc to close)">
            <div class="command-palette-results" id="commandResults"></div>
        </div>
        
        <!-- Quick Access Panel -->
        
        
        <!-- Performance Monitor (Dev Mode) -->
        <div class="performance-monitor" id="performanceMonitor">
            <div>FPS: <span id="fpsCounter">60</span></div>
            <div>Memory: <span id="memoryCounter">0 MB</span></div>
        </div>
        
        <!-- Contextual Help Button -->
            <span>?</span>
        </button>
        
        <!-- Auto-Save Indicator -->
        <div class="auto-save-indicator" id="autoSaveIndicator">💾 Auto-saved</div>
        
        <!-- Action Feedback -->
        <div class="action-feedback" id="actionFeedback"></div>
        
        <!-- Celebration Container -->
        <div class="celebration" id="celebrationContainer"></div>
        
        
        <!-- Context Menu -->
        <div class="context-menu" id="contextMenu"></div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner-large"></div>
        </div>
        
        <div id="import-container" style="display: none;">
            <textarea id="import-textarea" placeholder="Paste the JSON code here to import"></textarea>
            <button class="import-export-button" onclick="importData()">Import Data</button>
            <button class="import-export-button" onclick="toggleImport()">Cancel</button>
        </div>
        <div class="pages-container">
            <div id="pagesList" class="pages-list"></div>
        </div>
        <!-- Manage buttons moved to pages and sections lists -->
        <div class="search-container">
            <!-- Notes button moved to top-left, removed from here -->
        </div>
        <div class="tabs" id="tabButtons"></div>
        <div id="tabContents"></div>
        <textarea id="export-textarea" style="display:none;" readonly placeholder="Copy this to the file."></textarea>

        <div id="removeTextModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRemoveTextModal()">×</span>
                <h2>Select text to remove</h2>
                <ul id="textList" class="section-list">
                </ul>
            </div>
        </div>

        <div id="addSectionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddSectionModal()">×</span>
                <h2>Add New Section</h2>
                <input type="text" id="newSectionName" placeholder="Enter section name">
                <button class="add-remove-button-section" onclick="addSection()">Add Section</button>
            </div>
        </div>
        <div id="removeSectionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRemoveSectionModal()">×</span>
                <h2>Select a section to remove</h2>
                <ul id="sectionList" class="section-list">
                </ul>
            </div>
        </div>
        <div id="renameSectionModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRenameSectionModal()">×</span>
                <h2>Select a section to rename</h2>
                <ul id="renameSectionList" class="section-list">
                </ul>
            </div>
        </div>
        <div id="addPageModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddPageModal()">×</span>
                <h2>Add New Page</h2>
                <input type="text" id="newPageName" placeholder="Enter page name">
                <button class="add-remove-button-section" onclick="addPage()">Add Page</button>
            </div>
        </div>
        <div id="removePageModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRemovePageModal()">×</span>
                <h2>Select a page to remove</h2>
                <ul id="pageList" class="section-list">
                </ul>
            </div>
        </div>
        <div id="renamePageModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRenamePageModal()">×</span>
                <h2>Select a page to rename</h2>
                <ul id="renamePageList" class="section-list">
                </ul>
            </div>
        </div>
        <div class="notepad-container" id="notepadContainer">
            <div class="notepad-content">
                <!-- Left Sidebar - Categories/Folders -->
                <div class="notepad-sidebar">
                    <div class="notepad-sidebar-header">
                        <button class="notepad-toggle-inline" onclick="toggleNotepad()" title="Close Notes">
                            <span>📝</span>
                        </button>
                        <button class="notepad-new-note-btn-header" onclick="addNewNote()" title="New Note (Ctrl+N)">
                            <span>➕</span> New Note
                        </button>
                    </div>
                    
                    <!-- Categories/Folders -->
                    <div class="notepad-categories">
                        <div class="notepad-category-item active" data-category="all" onclick="filterNotesByCategory('all')">
                            <span>📁</span> All Notes
                            <span class="note-count" id="allNotesCount">0</span>
                        </div>
                        <div class="notepad-category-item" data-category="favorites" onclick="filterNotesByCategory('favorites')">
                            <span>⭐</span> Favorites
                            <span class="note-count" id="favoriteNotesCount">0</span>
                        </div>
                        <div class="notepad-category-divider"></div>
                        <div id="notepadCustomCategories"></div>
                        <button class="notepad-add-category-btn" onclick="addNewCategory()" title="Add Category">
                            <span>➕</span> Add Category
                        </button>
                    </div>
                </div>
                
                <!-- Main Area with Notes Tabs at Top -->
                <div class="notepad-main-area">
                    <!-- Notes Tabs (Browser-like) -->
                    <div class="notepad-tabs-container">
                        <div class="notepad-tabs" id="notepadTabs">
                            <!-- Notes will be rendered as tabs here -->
                        </div>
                    </div>
                    <div class="notepad-editor-header" id="notepadEditorHeader">
                        <div class="notepad-editor-title-section">
                            <input type="text" id="notepadTitleInput" class="notepad-title-input" placeholder="Untitled Note" onblur="saveNoteTitle()" onkeydown="handleNoteTitleKeydown(event)">
                            <div class="notepad-meta-info" id="notepadMetaInfo">
                                <span id="notepadStats" class="notepad-stats"></span>
                                <span id="notepadSaveIndicator" class="notepad-save-indicator" style="display: none;">💾 Saved</span>
                            </div>
                        </div>
                        <div class="notepad-editor-actions">
                            <button class="notepad-action-btn" onclick="toggleNoteFavorite()" id="notepadFavoriteBtn" title="Toggle Favorite">
                                <span>☆</span>
                            </button>
                            <button class="notepad-action-btn" onclick="showNoteCategoryMenu()" id="notepadCategoryBtn" title="Category">
                                <span>📁</span>
                            </button>
                            <button class="notepad-action-btn danger" onclick="removeCurrentNote()" title="Delete Note (Ctrl+Delete)">
                                <span>🗑️</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="notepad-editor" id="notepadEditor">
                        <div class="notepad-empty-state" id="notepadEmptyState">
                            <div class="notepad-empty-icon">📝</div>
                            <h3>No note selected</h3>
                            <p>Select a note from the sidebar or create a new one</p>
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;">
                                <button class="notepad-new-note-btn-large" onclick="createNewNote()">Create New Note</button>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center;">
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('meeting')" title="Meeting Notes Template">📅 Meeting</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('todo')" title="To-Do List Template">✅ To-Do</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('ideas')" title="Ideas Template">💡 Ideas</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('journal')" title="Journal Entry Template">📔 Journal</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('project')" title="Project Plan Template">📊 Project</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('code')" title="Code Notes Template">💻 Code</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('recipe')" title="Recipe Template">🍳 Recipe</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('contact')" title="Contact Info Template">👤 Contact</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('book')" title="Book Notes Template">📚 Book</button>
                                <button class="notepad-template-btn" onclick="createNoteFromTemplate('workout')" title="Workout Log Template">💪 Workout</button>
                            </div>
                        </div>
                        <textarea class="notepad-textarea" id="notepadTextarea" placeholder="Start typing your note..." oninput="saveNoteContent()"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Layer System
        let layersData = JSON.parse(localStorage.getItem('layersData') || '{}');
        let currentLayerId = localStorage.getItem('currentLayerId') || 'default';
        
        // Initialize default layer if it doesn't exist
        if (!layersData[currentLayerId]) {
            layersData[currentLayerId] = {
                id: currentLayerId,
                name: 'Default',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                data: {
                    pages: [],
                    notes: [],
                    noteCategories: [],
                    subtextToggleStates: {}
                }
            };
            localStorage.setItem('layersData', JSON.stringify(layersData));
        }
        
        let textData = [];
        let pagesData = [];
        let currentPageId = null;
        let notesData = [];
        let currentNoteId = null;
        let noteCategories = JSON.parse(localStorage.getItem('noteCategories') || '[]');
        // Migrate old string array to object array with colors
        if (noteCategories.length > 0 && typeof noteCategories[0] === 'string') {
            noteCategories = noteCategories.map(name => ({ name: name, color: '#0073e6' }));
            localStorage.setItem('noteCategories', JSON.stringify(noteCategories));
        }
        let currentNoteFilter = 'all';
        // Search removed
        let subtextToggleStates = {};
        
        // Undo/Redo System
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;
        let isUndoRedo = false;
        
        
        // Bulk Selection
        let selectedSnippets = new Set();
        let bulkMode = false;
        
        
        // Smart Shortcuts System
        let snippetShortcuts = JSON.parse(localStorage.getItem('snippetShortcuts') || '{}');
        let shortcutMode = false;
        
        
        // Duplicate Detection
        let duplicateCache = {};
        
        
        // Keyboard Navigation
        let keyboardNavActive = false;
        let focusedSnippetIndex = -1;
        
        // Rich Text Support
        let richTextEnabled = JSON.parse(localStorage.getItem('richTextEnabled') || 'false');
        
        // Voice Commands
        
        // Performance Monitoring
        let performanceMode = localStorage.getItem('performanceMode') === 'true';
        let frameCount = 0;
        let lastTime = performance.now();
        
        // Advanced Filters
        let activeFilters = {
            tags: [],
            favorites: false,
            hasVariables: false,
            hasShortcuts: false
        };
        
        
        // Auto-backup
        
        // Command Palette
        let commandPaletteOpen = false;
        let commandSelectedIndex = 0;
        let currentCommands = [];
        
        // Quick Access
        
        // Theme - always dark mode
        let currentTheme = 'dark';
        
        // Smart Suggestions
        let usageFrequency = JSON.parse(localStorage.getItem('usageFrequency') || '{}');

        function createButtonWithIcon(text) {
            return `${text}`;
        }
        
        // ========== UNDO/REDO SYSTEM ==========
        function saveToHistory() {
            if (isUndoRedo) return;
            
            historyStack = historyStack.slice(0, historyIndex + 1);
            const state = JSON.parse(JSON.stringify({
                pages: pagesData,
                notes: notesData,
                timestamp: Date.now()
            }));
            historyStack.push(state);
            historyIndex++;
            
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
                historyIndex--;
            }
        }
        
        function undo() {
            if (historyIndex > 0) {
                isUndoRedo = true;
                historyIndex--;
                restoreState(historyStack[historyIndex]);
                showToast('Undone', 'info');
                isUndoRedo = false;
            } else {
                showToast('Nothing to undo', 'info');
            }
        }
        
        function redo() {
            if (historyIndex < historyStack.length - 1) {
                isUndoRedo = true;
                historyIndex++;
                restoreState(historyStack[historyIndex]);
                showToast('Redone', 'info');
                isUndoRedo = false;
            } else {
                showToast('Nothing to redo', 'info');
            }
        }
        
        function restoreState(state) {
            pagesData = JSON.parse(JSON.stringify(state.pages));
            notesData = JSON.parse(JSON.stringify(state.notes));
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (currentPage) {
                textData = currentPage.sections || [];
            }
            saveData();
            createTabs();
            createTabContents();
            renderPages();
            loadTextEdits();
        }
        
        
        function getAllSnippetsCount() {
            let count = 0;
            pagesData.forEach(page => {
                page.sections?.forEach(section => {
                    const countInSection = (texts) => {
                        texts.forEach(text => {
                            count++;
                            if (text.subtexts) countInSection(text.subtexts);
                        });
                    };
                    if (section.texts) countInSection(section.texts);
                });
            });
            return count;
        }
        
        function getAllFavoritesCount() {
            let count = 0;
            pagesData.forEach(page => {
                page.sections?.forEach(section => {
                    const countFavorites = (texts) => {
                        texts.forEach(text => {
                            if (text.favorite) count++;
                            if (text.subtexts) countFavorites(text.subtexts);
                        });
                    };
                    if (section.texts) countFavorites(section.texts);
                });
            });
            return count;
        }
        
        function getAllTagsCount() {
            const tagsSet = new Set();
            pagesData.forEach(page => {
                page.sections?.forEach(section => {
                    const collectTags = (texts) => {
                        texts.forEach(text => {
                            if (text.tags) text.tags.forEach(tag => tagsSet.add(tag));
                            if (text.subtexts) collectTags(text.subtexts);
                        });
                    };
                    if (section.texts) collectTags(section.texts);
                });
            });
            return tagsSet.size;
        }
        
        function getAllSectionsCount() {
            let count = 0;
            pagesData.forEach(page => {
                count += (page.sections?.length || 0);
            });
            return count;
        }
        
        // ========== AUTO-BACKUP SYSTEM ==========
        
        // Tag Autocomplete

        function createTabs() {
            const tabButtonsContainer = document.getElementById('tabButtons');
            tabButtonsContainer.innerHTML = '';
            
            // Add Manage Sections button first
            if (currentPageId && currentPageId !== 'favorites-page') {
                const manageSectionsBtn = document.createElement('button');
                manageSectionsBtn.classList.add('tab-button', 'manage-sections-btn');
                manageSectionsBtn.textContent = '✏️';
                manageSectionsBtn.title = 'Manage Sections';
                manageSectionsBtn.style.position = 'relative';
                manageSectionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showManageSectionsMenu(manageSectionsBtn);
                });
                tabButtonsContainer.appendChild(manageSectionsBtn);
            }
            
            textData.forEach((tab, index) => {
                const button = document.createElement('button');
                button.classList.add('tab-button', `tab-custom-${index}`);
                button.dataset.tabId = tab.id;
                button.textContent = tab.label;
                button.draggable = true;
                button.addEventListener('dragstart', (event) => dragStart(event, tab.id, 'tab'));
                button.addEventListener('dragover', (event) => dragOver(event));
                button.addEventListener('drop', (event) => drop(event, tab.id, 'tab'));
                button.addEventListener('dragenter', (event) => dragEnter(event, button));
                button.addEventListener('dragleave', (event) => dragLeave(event, button));
                button.addEventListener('click', () => showTab(tab.id));
                tabButtonsContainer.appendChild(button);
            });
        }
        
        function showManageSectionsMenu(element) {
            // Remove existing menu if any
            const existingMenu = document.querySelector('.manage-sections-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.className = 'manage-sections-menu';
            menu.style.cssText = 'position: absolute; background: rgba(34, 34, 34, 0.98); border: 1px solid #444; border-radius: 6px; padding: 5px; z-index: 1000; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            menu.innerHTML = `
                <button onclick="openAddSectionModal(); this.closest('.manage-sections-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Add Section</button>
                <button onclick="openRenameSectionModal(); this.closest('.manage-sections-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Rename Section</button>
                <button onclick="openRemoveSectionModal(); this.closest('.manage-sections-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Remove Section</button>
            `;
            
            const rect = element.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            document.body.appendChild(menu);
            
            // Close on outside click
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && e.target !== element) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        }
        
        function showManageTextMenu(element, tabId) {
            // Remove existing menu if any
            const existingMenu = document.querySelector('.manage-text-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.className = 'manage-text-menu';
            menu.style.cssText = 'position: absolute; background: rgba(34, 34, 34, 0.98); border: 1px solid #444; border-radius: 6px; padding: 5px; z-index: 1000; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            menu.innerHTML = `
                <button onclick="addTextSnippet('${tabId}'); this.closest('.manage-text-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Add Text</button>
                <button onclick="openRemoveTextModal('${tabId}'); this.closest('.manage-text-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Remove Text</button>
            `;
            
            const rect = element.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            document.body.appendChild(menu);
            
            // Close on outside click
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && e.target !== element) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        }

        function createTextAreas(tab) {
            const tabContent = document.createElement('div');
            tabContent.id = tab.id;
            tabContent.classList.add('tab-content');
            
            
            const buttonContainer = document.createElement('div');
            buttonContainer.classList.add('text-control-buttons');

            // Add Manage Text button (replaces Add Text and Remove Text buttons)
            const manageTextButton = document.createElement('button');
            manageTextButton.textContent = "✏️";
            manageTextButton.classList.add('manage-text-btn');
            manageTextButton.title = 'Manage Text';
            manageTextButton.style.position = 'relative';
            manageTextButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showManageTextMenu(manageTextButton, tab.id);
            });
            buttonContainer.appendChild(manageTextButton);
            
            // Bulk select button removed
            
            tabContent.appendChild(buttonContainer);
            if (tab.texts && Array.isArray(tab.texts) && tab.texts.length > 0) {
                tab.texts.forEach(item => {
                    const container = createTextContainer(item, tab.id);
                    tabContent.appendChild(container);
                });
            } else {
                // Simple, intuitive empty state
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">📝</div>
                        <div style="font-size: 16px; margin-bottom: 10px; color: #aaa;">No snippets yet</div>
                        <div style="font-size: 13px; color: #666;">Click "Add Text" above to create one</div>
                    </div>
                `;
                tabContent.appendChild(emptyState);
            }
            return tabContent;
        }

        function createTextContainer(item, tabId, isSubtext = false) {
            const container = document.createElement('div');
            container.classList.add('copy-container');
            container.dataset.textId = item.id;
            container.draggable = true;
            container.addEventListener('dragstart', (event) => dragStart(event, item.id, 'text', tabId));
            container.addEventListener('dragover', (event) => dragOver(event));
            container.addEventListener('drop', (event) => drop(event, item.id, 'text', tabId));
            container.addEventListener('dragenter', (event) => dragEnter(event, container));
            container.addEventListener('dragleave', (event) => dragLeave(event, container));

            const toggleButton = document.createElement('button');
            toggleButton.textContent = '▶';
            toggleButton.classList.add('toggle-subtext');
            if (item.subtexts && item.subtexts.length > 0) {
                toggleButton.classList.add('has-subtexts');
            }
            toggleButton.addEventListener('click', () => toggleSubtexts(item.id, toggleButton));
            container.appendChild(toggleButton);

            // Favorite Button
            const favoriteBtn = document.createElement('button');
            favoriteBtn.className = `favorite-button ${item.favorite ? 'active' : ''}`;
            favoriteBtn.title = 'Toggle favorite';
            favoriteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(item.id);
            });
            container.appendChild(favoriteBtn);

            const button = document.createElement('button');
            button.classList.add('copy-button', 'glow-on-hover');
            button.innerHTML = createButtonWithIcon(item.buttonText);
            button.dataset.target = item.id;
            button.addEventListener('click', () => {
                copyToClipboard(item.id, `success-${item.id}`);
                // Visual feedback
                button.classList.add('copied');
                setTimeout(() => button.classList.remove('copied'), 600);
            });
            container.appendChild(button);

            const editContainer = document.createElement('div');
            editContainer.classList.add('edit-button-container');
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '5px';

            const editButton = document.createElement('button');
            editButton.textContent = "✏️";
            editButton.classList.add('edit-button');
            editButton.addEventListener('click', () => toggleEdit(item.id, container));
            buttonContainer.appendChild(editButton);

            const addSubtextButton = document.createElement('button');
            addSubtextButton.textContent = "➕";
            addSubtextButton.classList.add('add-subtext-button');
            addSubtextButton.title = "Add Subtext";
            addSubtextButton.addEventListener('click', () => addSubtext(tabId, item.id));
            buttonContainer.appendChild(addSubtextButton);
            
            const duplicateButton = document.createElement('button');
            // Duplicate button removed
            
            editContainer.appendChild(buttonContainer);

            const input = document.createElement('input');
            input.type = 'text';
            input.id = item.id + '-input';
            input.classList.add('hidden-input');
            input.value = item.buttonText;
            input.addEventListener('input', () => saveTextEdit(item.id, 'buttonText'));

            const textarea = document.createElement('textarea');
            textarea.id = item.id;
            textarea.classList.add('hidden-textarea');
            textarea.value = item.text;
            textarea.addEventListener('input', () => saveTextEdit(item.id, 'text'));

            const successSpan = document.createElement('span');
            successSpan.id = `success-${item.id}`;
            successSpan.classList.add('copy-success');
            successSpan.textContent = 'Copied!';

            editContainer.appendChild(input);
            editContainer.appendChild(textarea);
            container.appendChild(editContainer);
            container.appendChild(successSpan);
            
            
            // Bulk selection removed
            
            
            // Variable Indicator
            if (item.text && (item.text.includes('{date}') || item.text.includes('{time}') || 
                item.text.includes('{datetime}') || item.text.includes('{year}'))) {
                const varIndicator = document.createElement('span');
                varIndicator.className = 'variable-tag';
                varIndicator.textContent = 'VARS';
                varIndicator.title = 'Contains variables';
                varIndicator.style.position = 'absolute';
                varIndicator.style.top = '5px';
                varIndicator.style.left = '5px';
                container.style.position = 'relative';
                container.appendChild(varIndicator);
            }
            

            if (item.subtexts && Array.isArray(item.subtexts)) {
                const subtextContainer = document.createElement('div');
                subtextContainer.classList.add('subtext-container');
                subtextContainer.id = `subtexts-${item.id}`;

                // Restore toggle state from localStorage
                const toggleState = subtextToggleStates[item.id];
                if (toggleState) {
                    subtextContainer.classList.add('show');
                }

                item.subtexts.forEach(subtext => {
                    const subtextElement = createTextContainer(subtext, tabId, true);
                    subtextContainer.appendChild(subtextElement);
                });

                container.appendChild(subtextContainer);
            }
            return container;
        }

        function loadTextEdits() {
            textData.forEach(tab => {
                if (tab && tab.texts) {
                    tab.texts.forEach(item => {
                        const textArea = document.getElementById(item.id);
                        if (textArea) {
                            textArea.value = item.text;
                        }
                        const input = document.getElementById(item.id + '-input');
                        const button = document.querySelector(`[data-target="${item.id}"]`);
                        if (input) {
                            input.value = item.buttonText;
                            if (button) {
                                button.innerHTML = createButtonWithIcon(item.buttonText);
                            }
                        }
                        if (item.subtexts) {
                            item.subtexts.forEach(subtext => {
                                const subtextArea = document.getElementById(subtext.id);
                                if (subtextArea) {
                                    subtextArea.value = subtext.text;
                                }
                                const subInput = document.getElementById(subtext.id + '-input');
                                const subButton = document.querySelector(`[data-target="${subtext.id}"]`);
                                if (subInput) {
                                    subInput.value = subtext.buttonText;
                                    if (subButton) {
                                        subButton.innerHTML = createButtonWithIcon(subtext.buttonText);
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }

        function createTabContents() {
            const tabContentsContainer = document.getElementById('tabContents');
            tabContentsContainer.innerHTML = '';
            textData.forEach(tab => {
                const content = createTextAreas(tab);
                tabContentsContainer.appendChild(content);
            });
        }

        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(button => button.classList.remove('active'));
            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            const activeTabButton = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
            if (activeTabButton) {
                activeTabButton.classList.add('active');
            }
            localStorage.setItem('activeTab', tabId);
            saveData();
        }

        function toggleEdit(itemId, container) {
            const input = document.getElementById(itemId + '-input');
            const textArea = document.getElementById(itemId);
            if (input) {
                if (input.style.display === 'none' || input.style.display === '') {
                    input.classList.remove('edit-mode');
                    input.style.display = 'block';
                } else {
                    input.classList.add('edit-mode');
                    input.style.display = 'none';
                }
            }
            if (textArea) {
                if (textArea.style.display === 'none' || textArea.style.display === '') {
                    textArea.classList.remove('edit-mode');
                    textArea.style.display = 'block';
                } else {
                    textArea.classList.add('edit-mode');
                    textArea.style.display = 'none';
                }
            }
            const button = container.querySelector(`[data-target="${itemId}"]`);
            if (input && button && input.style.display === 'none') {
                button.innerHTML = createButtonWithIcon(input.value);
            }
        }

        // Modern Clipboard API with fallback
        async function copyToClipboard(elementId, successId) {
            const textElement = document.getElementById(elementId);
            if (!textElement) return;
            
            const textToCopy = textElement.value;
            if (!textToCopy) {
                showToast('Nothing to copy', 'error');
                return;
            }
            
            try {
                // Modern Clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(textToCopy);
                    showToast('Copied to clipboard!', 'success');
                } else {
                    // Fallback for older browsers
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textToCopy;
                    tempTextarea.style.position = 'fixed';
                    tempTextarea.style.opacity = '0';
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    showToast('Copied to clipboard!', 'success');
                }
                
                // Update success indicator
                const successMessage = document.getElementById(successId);
                if (successMessage) {
                    successMessage.classList.add('show-success');
                    setTimeout(() => {
                        successMessage.classList.remove('show-success');
                    }, 2000);
                }
                
                // Track usage for quick access
                trackUsage(elementId);
            } catch (error) {
                console.error('Failed to copy:', error);
                showToast('Failed to copy to clipboard', 'error');
            }
        }
        
        function getButtonText(elementId) {
            const button = document.querySelector(`[data-target="${elementId}"]`);
            return button ? button.textContent.trim() : 'Unknown';
        }
        
        // Toast Notification System
        function showToast(message, type = 'info', duration = 3000) {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function saveTextEdit(elementId, type) {
            const element = document.getElementById(type === 'text' ? elementId : elementId + '-input');
            if (!element) return;
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (!currentPage) return;
            const updateText = (texts) => {
                texts.forEach(item => {
                    if (item.id === elementId) {
                        if (type === 'text') {
                            item.text = element.value;
                        } else if (type === 'buttonText') {
                            item.buttonText = element.value;
                        }
                    }
                    if (item.subtexts) {
                        updateText(item.subtexts);
                    }
                });
            };
            currentPage.sections.forEach(tab => {
                if (tab && tab.texts) {
                    updateText(tab.texts);
                }
            });
            if (type === 'buttonText') {
                const button = document.querySelector(`[data-target="${elementId}"]`);
                if (button) {
                    button.innerHTML = createButtonWithIcon(element.value);
                }
            }
            saveData();
        }

        function loadActiveTab() {
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab) {
                showTab(savedTab);
            }
        }

        function addTextSnippet(tabId) {
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (!currentPage) return;
            const tab = currentPage.sections.find(tab => tab.id === tabId);
            if (tab) {
                const newTextId = `text-${tabId}-${Date.now()}`;
                if (!tab.texts) {
                    tab.texts = [];
                }
                tab.texts.push({
                    id: newTextId,
                    buttonText: "Copy",
                    text: "Text",
                });
                saveData();
                createTabContents();
                showTab(tabId);
            }
        }

        function removeTextSnippet(tabId, textId, listItem = null) {
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (!currentPage) return;
            const tab = currentPage.sections.find(tab => tab.id === tabId);
            if (tab && tab.texts) {
                const removeText = (texts) => {
                    return texts.filter(item => {
                        if (item.id === textId) {
                            return false;
                        }
                        if (item.subtexts) {
                            item.subtexts = removeText(item.subtexts);
                        }
                        return true;
                    });
                };
                const removedCount = tab.texts.length;
                tab.texts = removeText(tab.texts);
                const newCount = tab.texts.length;
                saveData();
                createTabContents();
                showTab(tabId);
                
                // Remove the item from the modal list
                if (listItem) {
                    // Also remove the subtext container if it exists
                    const subtextContainer = document.getElementById(`remove-subtexts-${textId}`);
                    if (subtextContainer) {
                        subtextContainer.remove();
                    }
                    listItem.remove();
                } else {
                    // Fallback: find by data attribute
                    const item = document.querySelector(`[data-text-id="${textId}"]:not([data-parent-id])`);
                    if (item) {
                        const subtextContainer = document.getElementById(`remove-subtexts-${textId}`);
                        if (subtextContainer) {
                            subtextContainer.remove();
                        }
                        item.remove();
                    }
                }
                
                // Close modal if no items left
                const textList = document.getElementById('textList');
                if (textList && textList.children.length === 0) {
                    closeRemoveTextModal();
                }
            }
        }

        function openAddSectionModal() {
            // Inline add - no modal
            if (!currentPageId) {
                showToast('Please select a page first', 'info');
                return;
            }
            
            const tabsContainer = document.getElementById('tabButtons');
            if (!tabsContainer) return;
            
            // Create inline input
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Section name...';
            input.style.padding = '8px 12px';
            input.style.margin = '5px';
            input.style.background = 'rgba(0, 115, 230, 0.1)';
            input.style.border = '2px solid #0073e6';
            input.style.borderRadius = '6px';
            input.style.color = '#fff';
            input.style.fontSize = '14px';
            input.style.width = '200px';
            
            const addButton = document.createElement('button');
            addButton.textContent = '✓';
            addButton.className = 'add-remove-button';
            addButton.style.padding = '8px 12px';
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = '✕';
            cancelButton.className = 'remove-section-button';
            cancelButton.style.padding = '8px 12px';
            
            const container = document.createElement('div');
            container.style.display = 'inline-flex';
            container.style.alignItems = 'center';
            container.style.gap = '5px';
            container.style.margin = '5px';
            container.appendChild(input);
            container.appendChild(addButton);
            container.appendChild(cancelButton);
            
            tabsContainer.appendChild(container);
            input.focus();
            
            const finishAdd = () => {
                const name = input.value.trim() || `Section ${textData.length + 1}`;
                const currentPage = pagesData.find(p => p.id === currentPageId);
                if (currentPage) {
                    if (!currentPage.sections) {
                        currentPage.sections = [];
                    }
                    // Check for duplicates
                    if (currentPage.sections.some(s => s.label.toLowerCase() === name.toLowerCase())) {
                        showToast('A section with this name already exists', 'error');
                        return;
                    }
                    const newSectionId = `section-${Date.now()}`;
                    const newSection = {
                        id: newSectionId,
                        label: name,
                        className: 'tab-custom',
                        texts: [{
                            id: `text-${newSectionId}-${Date.now()}`,
                            buttonText: "Copy",
                            text: "Text",
                        }]
                    };
                    currentPage.sections.push(newSection);
                    textData = currentPage.sections;
                    saveData();
                    createTabs();
                    createTabContents();
                    showTab(newSectionId);
                }
                container.remove();
            };
            
            addButton.onclick = finishAdd;
            cancelButton.onclick = () => container.remove();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishAdd();
                } else if (e.key === 'Escape') {
                    container.remove();
                }
            });
        }

        function closeAddSectionModal() {
            // No modal to close
        }

        function addSection(name) {
            if (!name) {
                openAddSectionModal();
                return;
            }
            if (!currentPageId) {
                showToast('Please select a page first', 'info');
                return;
            }
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (currentPage) {
                if (!currentPage.sections) {
                    currentPage.sections = [];
                }
                if (currentPage.sections.some(s => s.label.toLowerCase() === name.toLowerCase())) {
                    showToast('A section with this name already exists', 'error');
                    return;
                }
                const newSectionId = `section-${Date.now()}`;
                const newSection = {
                    id: newSectionId,
                    label: name.trim(),
                    className: 'tab-custom',
                    texts: [{
                        id: `text-${newSectionId}-${Date.now()}`,
                        buttonText: "Copy",
                        text: "Text",
                    }]
                };
                currentPage.sections.push(newSection);
                textData = currentPage.sections;
                saveData();
                createTabs();
                createTabContents();
                showTab(newSectionId);
            }
        }

        function openRemoveSectionModal() {
            const modal = document.getElementById('removeSectionModal');
            const sectionList = document.getElementById('sectionList');
            sectionList.innerHTML = '';
            textData.forEach(section => {
                const listItem = document.createElement('li');
                listItem.classList.add('section-list-item');
                listItem.dataset.sectionId = section.id;
                listItem.textContent = section.label;
                listItem.addEventListener('click', () => removeSection(section.id, listItem));
                sectionList.appendChild(listItem);
            });
            modal.style.display = 'block';
        }

        function closeRemoveSectionModal() {
            const modal = document.getElementById('removeSectionModal');
            modal.style.display = 'none';
        }

        function removeSection(sectionId, listItem = null) {
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (currentPage) {
                currentPage.sections = currentPage.sections.filter(tab => tab.id !== sectionId);
                textData = currentPage.sections;
                saveData();
                createTabs();
                createTabContents();
                if (textData.length > 0) {
                    showTab(textData[0].id);
                }
            }
            
            // Remove the item from the modal list
            if (listItem) {
                listItem.remove();
            } else {
                // Fallback: find by data attribute
                const item = document.querySelector(`[data-section-id="${sectionId}"]`);
                if (item) item.remove();
            }
            
            // Close modal if no sections left
            const sectionList = document.getElementById('sectionList');
            if (sectionList && sectionList.children.length === 0) {
                closeRemoveSectionModal();
            }
        }

        function saveData() {
            try {
                saveToHistory(); // Save to undo/redo history
                
                // Save to current layer
                if (layersData[currentLayerId]) {
                    layersData[currentLayerId].data = {
                        pages: pagesData,
                        notes: notesData,
                        noteCategories: noteCategories,
                        subtextToggleStates: subtextToggleStates
                    };
                    layersData[currentLayerId].updatedAt = new Date().toISOString();
                    localStorage.setItem('layersData', JSON.stringify(layersData));
                }
                
                // Also save to legacy keys for backward compatibility
                localStorage.setItem('pagesData', JSON.stringify(pagesData));
                localStorage.setItem('notesData', JSON.stringify(notesData));
                localStorage.setItem('subtextToggleStates', JSON.stringify(subtextToggleStates));
                localStorage.setItem('noteCategories', JSON.stringify(noteCategories));
            } catch (error) {
                console.error('Failed to save data:', error);
                showToast('Failed to save data. Storage may be full.', 'error');
            }
        }

        function loadData() {
            // Load from current layer
            if (layersData[currentLayerId] && layersData[currentLayerId].data) {
                const layerData = layersData[currentLayerId].data;
                pagesData = layerData.pages || [];
                notesData = layerData.notes || [];
                noteCategories = layerData.noteCategories || [];
                subtextToggleStates = layerData.subtextToggleStates || {};
            } else {
                // Fallback to legacy storage
                const storedPages = localStorage.getItem('pagesData');
                const storedNotes = localStorage.getItem('notesData');
                const storedToggleStates = localStorage.getItem('subtextToggleStates');

                if (storedToggleStates) {
                    subtextToggleStates = JSON.parse(storedToggleStates);
                } else {
                    subtextToggleStates = {};
                }

                if (storedNotes) {
                    notesData = JSON.parse(storedNotes);
                } else {
                    notesData = [];
                }
                
                // Load categories
                const storedCategories = localStorage.getItem('noteCategories');
                if (storedCategories) {
                    noteCategories = JSON.parse(storedCategories);
                } else {
                    noteCategories = [];
                }
                
                if (storedPages) {
                    pagesData = JSON.parse(storedPages);
                } else {
                    pagesData = [];
                }
            }
            
            // Migrate old notes to new structure
            notesData.forEach(note => {
                if (note.favorite === undefined) note.favorite = false;
                if (note.category === undefined) note.category = null;
                // Initialize order based on creation date if not set
                if (note.order === undefined) {
                    note.order = new Date(note.created).getTime();
                }
            });
            
            if (pagesData.length > 0) {
                currentPageId = pagesData[0].id;
                textData = pagesData[0].sections || [];
            } else {
                const pageId = `page-${Date.now()}`;
                const sectionId = `section-${Date.now()}`;
                const newPage = {
                    id: pageId,
                    name: 'Default Page',
                    sections: [{
                        id: sectionId,
                        label: 'Section 1',
                        className: 'tab-custom-0',
                        texts: [{
                            id: `text-${sectionId}-${Date.now()}`,
                            buttonText: "Copy",
                            text: "Text",
                        }]
                    }]
                };
                pagesData = [newPage];
                currentPageId = pageId;
                textData = newPage.sections;
                saveData();
            }
        }

        async function exportData(format = 'json') {
            let exportString = '';
            let filename = 'copy-text-manager-export';
            
            if (format === 'json') {
                const exportData = {
                    pages: pagesData,
                    notes: notesData,
                    noteCategories: noteCategories,
                    subtextToggleStates: subtextToggleStates,
                    version: '2.0',
                    exportedAt: new Date().toISOString()
                };
                exportString = JSON.stringify(exportData, null, 2);
                filename += '.json';
            } else if (format === 'csv') {
                // Export as CSV
                const rows = [];
                rows.push(['Button Text', 'Content', 'Tags', 'Favorite', 'Page', 'Section']);
                pagesData.forEach(page => {
                    page.sections?.forEach(section => {
                        const exportSnippets = (texts, pageName, sectionName) => {
                            texts.forEach(text => {
                                rows.push([
                                    text.buttonText || '',
                                    (text.text || '').replace(/\n/g, ' ').substring(0, 100),
                                    (text.tags || []).join('; '),
                                    text.favorite ? 'Yes' : 'No',
                                    pageName,
                                    sectionName
                                ]);
                                if (text.subtexts) {
                                    exportSnippets(text.subtexts, pageName, sectionName);
                                }
                            });
                        };
                        if (section.texts) {
                            exportSnippets(section.texts, page.name, section.label);
                        }
                    });
                });
                exportString = rows.map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                filename += '.csv';
            } else if (format === 'txt') {
                // Export as plain text
                const lines = [];
                lines.push('COPY TEXT MANAGER EXPORT');
                lines.push('='.repeat(50));
                lines.push(`Exported: ${new Date().toLocaleString()}`);
                lines.push('');
                pagesData.forEach(page => {
                    lines.push(`\nPAGE: ${page.name}`);
                    lines.push('-'.repeat(50));
                    page.sections?.forEach(section => {
                        lines.push(`\n  Section: ${section.label}`);
                        const exportSnippets = (texts, indent = '    ') => {
                            texts.forEach(text => {
                                lines.push(`${indent}[${text.buttonText}]`);
                                if (text.tags && text.tags.length > 0) {
                                    lines.push(`${indent}Tags: ${text.tags.join(', ')}`);
                                }
                                if (text.favorite) {
                                    lines.push(`${indent}⭐ Favorite`);
                                }
                                lines.push(`${indent}${text.text || ''}`);
                                lines.push('');
                                if (text.subtexts) {
                                    exportSnippets(text.subtexts, indent + '  ');
                                }
                            });
                        };
                        if (section.texts) {
                            exportSnippets(section.texts);
                        }
                    });
                });
                exportString = lines.join('\n');
                filename += '.txt';
            }
            
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(exportString);
                    showToast(`Data exported as ${format.toUpperCase()} and copied to clipboard!`, 'success');
                } else {
                    // Fallback to textarea
                    const exportTextarea = document.getElementById('export-textarea');
                    exportTextarea.value = exportString;
                    exportTextarea.style.display = 'block';
                    exportTextarea.select();
                    showToast(`Data exported as ${format.toUpperCase()}! Copy from the textarea below.`, 'info');
                    setTimeout(() => {
                        exportTextarea.style.display = 'none';
                    }, 10000);
                }
            } catch (error) {
                console.error('Export error:', error);
                const exportTextarea = document.getElementById('export-textarea');
                exportTextarea.value = exportString;
                exportTextarea.style.display = 'block';
                exportTextarea.select();
                showToast(`Export ready as ${format.toUpperCase()}! Copy from the textarea below.`, 'info');
            }
        }
        
        function showExportOptions() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <span class="close" onclick="this.closest('.modal').remove()">×</span>
                    <h2>Export Format</h2>
                    <div class="export-format-selector">
                        <button class="format-button active" onclick="exportData('json'); this.closest('.modal').remove();">JSON</button>
                        <button class="format-button" onclick="exportData('csv'); this.closest('.modal').remove();">CSV</button>
                        <button class="format-button" onclick="exportData('txt'); this.closest('.modal').remove();">TXT</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        function importData() {
            const importTextarea = document.getElementById('import-textarea');
            try {
                let importedData = JSON.parse(importTextarea.value);
                
                // Parse imported data
                let importedPages = [];
                let importedNotes = [];
                let importedCategories = [];
                let importedToggleStates = {};
                
                if (importedData.pages && Array.isArray(importedData.pages)) {
                    importedPages = importedData.pages;
                    if (importedData.notes && Array.isArray(importedData.notes)) {
                        importedNotes = importedData.notes;
                    }
                    if (importedData.noteCategories && Array.isArray(importedData.noteCategories)) {
                        importedCategories = importedData.noteCategories;
                        // Migrate old string array to object array with colors if needed
                        if (importedCategories.length > 0 && typeof importedCategories[0] === 'string') {
                            importedCategories = importedCategories.map(name => ({ name: name, color: '#0073e6' }));
                        }
                    }
                    if (importedData.subtextToggleStates) {
                        importedToggleStates = importedData.subtextToggleStates;
                    }
                } else if (Array.isArray(importedData) && importedData.length > 0 && 'label' in importedData[0]) {
                    const pageId = `page-${Date.now()}`;
                    importedPages = [{
                        id: pageId,
                        name: 'Imported Data',
                        sections: importedData
                    }];
                } else if (!Array.isArray(importedData) && importedData.sections) {
                    const pageId = `page-${Date.now()}`;
                    importedPages = [{
                        id: pageId,
                        name: 'Imported Data',
                        sections: importedData.sections
                    }];
                } else {
                    throw new Error('Unrecognized data format');
                }
                
                // Clean and validate imported data
                importedPages.forEach(page => {
                    if (!page.id) page.id = `page-${Date.now()}`;
                    if (!page.sections) page.sections = [];
                    page.sections.forEach(section => {
                        if (!section.id) section.id = `section-${Date.now()}`;
                        if (!section.texts) section.texts = [];
                        section.texts.forEach(text => {
                            if (!text.id) text.id = `text-${section.id}-${Date.now()}`;
                            if (!text.buttonText) text.buttonText = "Copy";
                            if (!text.text) text.text = "";
                            if (text.subtexts) {
                                text.subtexts.forEach(subtext => {
                                    if (!subtext.id) subtext.id = `subtext-${text.id}-${Date.now()}`;
                                    if (!subtext.buttonText) subtext.buttonText = "Subtext";
                                    if (!subtext.text) subtext.text = "";
                                });
                            }
                        });
                    });
                });
                
                importedNotes.forEach(note => {
                    if (!note.id) note.id = `note-${Date.now()}`;
                    if (!note.title) note.title = "Imported Note";
                    if (!note.content) note.content = "";
                    if (!note.created) note.created = new Date().toISOString();
                    if (!note.modified) note.modified = new Date().toISOString();
                });
                
                // Create a new layer with imported data
                const layerId = `layer-${Date.now()}`;
                const layerName = prompt('Enter a name for this layer:', `Imported ${new Date().toLocaleDateString()}`);
                if (layerName === null) {
                    // User cancelled
                    return;
                }
                
                const newLayer = {
                    id: layerId,
                    name: layerName.trim() || `Imported ${new Date().toLocaleDateString()}`,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    data: {
                        pages: importedPages,
                        notes: importedNotes,
                        noteCategories: importedCategories,
                        subtextToggleStates: importedToggleStates
                    }
                };
                
                layersData[layerId] = newLayer;
                localStorage.setItem('layersData', JSON.stringify(layersData));
                
                // Switch to the new layer
                switchToLayer(layerId);
                
                showToast(`Layer "${newLayer.name}" created and loaded!`, 'success');
                importTextarea.value = '';
                toggleImport();
            } catch (e) {
                console.error("Import error:", e);
                showToast('Failed to import data. Please check the format and try again.', 'error');
            }
        }
        
        // Layer Management Functions
        function showLayersManager() {
            // Check if modal already exists, if not create it
            let modal = document.getElementById('layersManagerModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'layersManagerModal';
                modal.className = 'modal';
                // Append to body to ensure it overlays everything
                document.body.appendChild(modal);
            }
            
            modal.style.display = 'block';
            
            // Reload layers data
            layersData = JSON.parse(localStorage.getItem('layersData') || '{}');
            currentLayerId = localStorage.getItem('currentLayerId') || 'default';
            
            const layersList = Object.values(layersData).sort((a, b) => {
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });
            
            let layersHTML = '<div class="modal-content" style="max-width: 650px; max-height: 85vh; overflow-y: auto; position: relative;">';
            layersHTML += '<span class="close" onclick="closeLayersManager()" style="position: absolute; top: 15px; right: 20px; z-index: 10;">×</span>';
            layersHTML += '<h2 style="margin-top: 0; margin-bottom: 10px; color: var(--theme-text-primary); font-size: 24px;">📚 Manage Layers</h2>';
            layersHTML += '<p style="color: var(--theme-text-secondary); font-size: 13px; margin-bottom: 25px; line-height: 1.5;">Layers allow you to keep multiple versions of your data. Importing creates a new layer instead of overwriting your current work.</p>';
            layersHTML += '<div id="layersList" style="margin-top: 20px;">';
            
            if (layersList.length === 0) {
                layersHTML += '<div style="text-align: center; padding: 60px 40px; color: var(--theme-text-secondary);">';
                layersHTML += '<div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">📚</div>';
                layersHTML += '<div style="font-size: 16px; margin-bottom: 8px; color: var(--theme-text-primary);">No layers yet</div>';
                layersHTML += '<div style="font-size: 13px;">Import data to create your first layer</div>';
                layersHTML += '</div>';
            } else {
                layersList.forEach(layer => {
                    const isActive = layer.id === currentLayerId;
                    const layerDate = new Date(layer.updatedAt).toLocaleString();
                    const pageCount = (layer.data?.pages || []).length;
                    const noteCount = (layer.data?.notes || []).length;
                    
                    layersHTML += `<div class="layer-item" data-layer-id="${layer.id}" style="
                        padding: 18px;
                        margin: 12px 0;
                        background: ${isActive ? 'rgba(255, 215, 0, 0.15)' : 'var(--theme-bg-secondary)'};
                        border: 2px solid ${isActive ? '#ffd700' : 'var(--theme-border)'};
                        border-radius: 8px;
                        transition: all 0.2s ease;
                        box-shadow: ${isActive ? '0 4px 12px rgba(255, 215, 0, 0.2)' : '0 2px 8px rgba(0, 0, 0, 0.1)'};
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow='${isActive ? '0 4px 12px rgba(255, 215, 0, 0.2)' : '0 2px 8px rgba(0, 0, 0, 0.1)'}'">`;
                    layersHTML += `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">`;
                    layersHTML += `<div style="flex: 1; min-width: 0;">`;
                    layersHTML += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">`;
                    layersHTML += `<div style="font-weight: 600; color: ${isActive ? '#ffd700' : 'var(--theme-text-primary)'}; font-size: 16px;">`;
                    if (isActive) {
                        layersHTML += `<span style="display: inline-block; width: 8px; height: 8px; background: #ffd700; border-radius: 50%; margin-right: 6px; box-shadow: 0 0 8px #ffd700;"></span>`;
                    }
                    layersHTML += `${layer.name}`;
                    layersHTML += `</div>`;
                    layersHTML += `</div>`;
                    layersHTML += `<div style="font-size: 12px; color: var(--theme-text-secondary); margin-bottom: 4px;">Updated: ${layerDate}</div>`;
                    layersHTML += `<div style="display: flex; gap: 16px; font-size: 12px; color: var(--theme-text-secondary);">`;
                    layersHTML += `<span>📄 ${pageCount} pages</span>`;
                    layersHTML += `<span>📝 ${noteCount} notes</span>`;
                    layersHTML += `</div>`;
                    layersHTML += `</div>`;
                    layersHTML += `<div style="display: flex; gap: 8px; flex-shrink: 0;">`;
                    if (!isActive) {
                        layersHTML += `<button onclick="switchToLayer('${layer.id}'); closeLayersManager();" style="
                            padding: 8px 16px;
                            background: var(--theme-accent);
                            color: #000;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: 600;
                            transition: all 0.2s;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform=''">Switch To</button>`;
                    }
                    layersHTML += `<button onclick="renameLayer('${layer.id}');" style="
                        padding: 8px 16px;
                        background: rgba(255, 255, 255, 0.1);
                        color: var(--theme-text-primary);
                        border: 1px solid var(--theme-border);
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 13px;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'">✏️ Rename</button>`;
                    if (layersList.length > 1) {
                        layersHTML += `<button onclick="deleteLayer('${layer.id}');" style="
                            padding: 8px 16px;
                            background: rgba(244, 67, 54, 0.15);
                            color: #f44336;
                            border: 1px solid #f44336;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 13px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(244, 67, 54, 0.25)'" onmouseout="this.style.background='rgba(244, 67, 54, 0.15)'">🗑️ Delete</button>`;
                    }
                    layersHTML += `</div>`;
                    layersHTML += `</div>`;
                    layersHTML += `</div>`;
                });
            }
            
            layersHTML += '</div>';
            layersHTML += '</div>';
            
            modal.innerHTML = layersHTML;
            
            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeLayersManager();
                }
            };
        }
        
        function closeLayersManager() {
            const modal = document.getElementById('layersManagerModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function switchToLayer(layerId) {
            if (!layersData[layerId]) {
                showToast('Layer not found', 'error');
                return;
            }
            
            // Save current layer before switching
            saveData();
            
            // Switch to new layer
            currentLayerId = layerId;
            localStorage.setItem('currentLayerId', currentLayerId);
            
            // Load the new layer's data
            loadData();
            
            // Refresh UI
            createTabs();
            createTabContents();
            loadTextEdits();
            renderPages();
            renderNotes();
            renderCategories();
            updateNoteCounts();
            
            if (textData.length > 0) {
                showTab(textData[0].id);
            }
            
            const layerName = layersData[layerId].name;
            showToast(`Switched to layer: "${layerName}"`, 'success');
        }
        
        function renameLayer(layerId) {
            if (!layersData[layerId]) {
                showToast('Layer not found', 'error');
                return;
            }
            
            const currentName = layersData[layerId].name;
            const newName = prompt('Enter new name for this layer:', currentName);
            
            if (newName && newName.trim() && newName.trim() !== currentName) {
                layersData[layerId].name = newName.trim();
                layersData[layerId].updatedAt = new Date().toISOString();
                localStorage.setItem('layersData', JSON.stringify(layersData));
                
                // Refresh the layers manager
                showLayersManager();
                showToast('Layer renamed successfully', 'success');
            } else if (newName && newName.trim() === currentName) {
                // Name unchanged, no need to show error
                return;
            }
        }
        
        function deleteLayer(layerId) {
            if (!layersData[layerId]) {
                showToast('Layer not found', 'error');
                return;
            }
            
            const layerName = layersData[layerId].name;
            const layerCount = Object.keys(layersData).length;
            
            if (layerCount <= 1) {
                showToast('Cannot delete the last layer', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete layer "${layerName}"? This action cannot be undone.`)) {
                return;
            }
            
            // If deleting current layer, switch to another one first
            if (layerId === currentLayerId) {
                const otherLayers = Object.keys(layersData).filter(id => id !== layerId);
                if (otherLayers.length > 0) {
                    switchToLayer(otherLayers[0]);
                }
            }
            
            delete layersData[layerId];
            localStorage.setItem('layersData', JSON.stringify(layersData));
            
            // Refresh the layers manager
            showLayersManager();
            showToast('Layer deleted successfully', 'success');
        }
        
        // Make closeLayersManager available globally for onclick handlers
        window.closeLayersManager = closeLayersManager;

        function toggleImport() {
            const importContainer = document.getElementById('import-container');
            const isVisible = importContainer.style.display === 'block';
            importContainer.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                document.getElementById('import-textarea').value = '';
            }
        }

        function openRenameSectionModal() {
            const modal = document.getElementById('renameSectionModal');
            const sectionList = document.getElementById('renameSectionList');
            sectionList.innerHTML = '';
            textData.forEach(section => {
                const listItem = document.createElement('li');
                listItem.classList.add('section-list-item');
                listItem.textContent = section.label;
                listItem.addEventListener('click', () => promptNewSectionName(section.id));
                sectionList.appendChild(listItem);
            });
            modal.style.display = 'block';
        }

        function closeRenameSectionModal() {
            const modal = document.getElementById('renameSectionModal');
            modal.style.display = 'none';
        }

        function promptNewSectionName(sectionId) {
            // Close the modal first
            closeRenameSectionModal();
            
            // Inline editing - no popup
            const tab = textData.find(tab => tab.id === sectionId);
            if (!tab) {
                showToast('Section not found', 'error');
                return;
            }
            
            const tabButton = document.querySelector(`[data-tab-id="${sectionId}"]`);
            if (!tabButton) {
                showToast('Section button not found', 'error');
                return;
            }
            
            const currentName = tab.label;
            const originalContent = tabButton.textContent;
            
            // Create inline input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.style.background = 'rgba(255, 215, 0, 0.2)';
            input.style.border = '1px solid #ffd700';
            input.style.borderRadius = '4px';
            input.style.padding = '4px 8px';
            input.style.color = '#fff';
            input.style.fontSize = '14px';
            input.style.width = '150px';
            input.style.margin = '0';
            
            // Replace tab button content with input
            tabButton.textContent = '';
            tabButton.appendChild(input);
            input.focus();
            input.select();
            
            const finishEdit = () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    // Check for duplicates in the same page
                    const currentPage = pagesData.find(p => p.id === currentPageId);
                    if (currentPage && currentPage.sections) {
                        const hasDuplicate = currentPage.sections.some(s => 
                            s.id !== sectionId && s.label.toLowerCase() === newName.toLowerCase()
                        );
                        if (hasDuplicate) {
                            showToast('A section with this name already exists', 'error');
                            tabButton.textContent = originalContent;
                            return;
                        }
                        // Update in pagesData
                        const section = currentPage.sections.find(s => s.id === sectionId);
                        if (section) {
                            section.label = newName;
                        }
                    }
                    // Update in textData (which is a reference to currentPage.sections)
                    tab.label = newName;
                    saveData();
                    createTabs();
                    showTab(sectionId);
                } else {
                    tabButton.textContent = originalContent;
                }
            };
            
            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur(); // This will trigger finishEdit
                } else if (e.key === 'Escape') {
                    tabButton.textContent = originalContent;
                }
            });
        }

        let draggedElement = null;
        let draggedType = null;
        let draggedTabId = null;

        function dragStart(event, id, type, tabId = null) {
            draggedElement = id;
            draggedType = type;
            draggedTabId = tabId;
            event.dataTransfer.setData('text/plain', id);
            event.dataTransfer.effectAllowed = 'move';
            // Set opacity for drag feedback
            if (event.target.classList.contains('notepad-tab')) {
                event.target.style.opacity = '0.5';
            }
            if (event.target.classList.contains('pages-list-item')) {
                event.target.style.opacity = '0.5';
            }
            // Also handle if the target is inside a notepad-tab (like titleSpan)
            const tabElement = event.target.closest('.notepad-tab');
            if (tabElement) {
                tabElement.style.opacity = '0.5';
            }
            // Handle favorites containers
            if (event.target.classList.contains('copy-container') && event.target.dataset.favoriteId) {
                event.target.style.opacity = '0.5';
            }
            const favoriteContainer = event.target.closest('.copy-container[data-favorite-id]');
            if (favoriteContainer) {
                favoriteContainer.style.opacity = '0.5';
            }
        }

        function dragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        function dragEnter(event, element) {
            if (element) {
                if (element.classList.contains('copy-container') || element.classList.contains('notepad-tab') || element.classList.contains('pages-list-item')) {
                    element.classList.add('drag-over');
                }
            }
        }

        function dragLeave(event, element) {
            if (element) {
                if (element.classList.contains('copy-container') || element.classList.contains('notepad-tab') || element.classList.contains('pages-list-item')) {
                    element.classList.remove('drag-over');
                }
            }
        }

        function drop(event, targetId, type, targetTabId = null) {
            event.preventDefault();
            event.stopPropagation();
            
            // Reset opacity
            document.querySelectorAll('.notepad-tab').forEach(tab => {
                tab.style.opacity = '';
            });
            document.querySelectorAll('.pages-list-item').forEach(item => {
                item.style.opacity = '';
            });
            document.querySelectorAll('#favorites-section .copy-container').forEach(container => {
                container.style.opacity = '';
            });
            
            if (draggedElement === null) return;
            if (draggedType === type && draggedType === 'tab') {
                reorderTabs(draggedElement, targetId);
            } else if (draggedType === type && draggedType === 'text' && draggedTabId === targetTabId) {
                reorderText(draggedElement, targetId, targetTabId);
            } else if (draggedType === type && draggedType === 'note') {
                reorderNotes(draggedElement, targetId);
            } else if (draggedType === type && draggedType === 'page') {
                reorderPages(draggedElement, targetId);
            } else if (draggedType === type && draggedType === 'favorite') {
                reorderFavorites(draggedElement, targetId);
            }
            draggedElement = null;
            draggedType = null;
            draggedTabId = null;
        }

        function reorderTabs(draggedId, targetId) {
            if (draggedId === targetId) return;
            const draggedIndex = textData.findIndex(tab => tab.id === draggedId);
            const targetIndex = textData.findIndex(tab => tab.id === targetId);
            if (draggedIndex === -1 || targetIndex === -1) return;
            const [draggedItem] = textData.splice(draggedIndex, 1);
            textData.splice(targetIndex, 0, draggedItem);
            saveData();
            createTabs();
            createTabContents();
            showTab(draggedItem.id);
        }

        function reorderPages(draggedId, targetId) {
            if (draggedId === targetId) return;
            const draggedIndex = pagesData.findIndex(page => page.id === draggedId);
            const targetIndex = pagesData.findIndex(page => page.id === targetId);
            if (draggedIndex === -1 || targetIndex === -1) return;
            const [draggedItem] = pagesData.splice(draggedIndex, 1);
            pagesData.splice(targetIndex, 0, draggedItem);
            saveData();
            renderPages();
            // Keep the dragged page active if it was active
            if (currentPageId === draggedItem.id) {
                switchPage(draggedItem.id);
            }
        }

        function reorderText(draggedId, targetId, tabId) {
            if (draggedId === targetId) return;
            const tab = textData.find(tab => tab.id === tabId);
            if (!tab || !tab.texts) return;
            const draggedIndex = tab.texts.findIndex(text => text.id === draggedId);
            const targetIndex = tab.texts.findIndex(text => text.id === targetId);
            if (draggedIndex === -1 || targetIndex === -1) return;
            const [draggedItem] = tab.texts.splice(draggedIndex, 1);
            tab.texts.splice(targetIndex, 0, draggedItem);
            saveData();
            createTabContents();
            showTab(tabId);
        }

        function reorderNotes(draggedId, targetId) {
            if (draggedId === targetId) return;
            
            // Get filtered notes (same as in renderNotes) - this is what's currently displayed
            let filteredNotes = getFilteredNotes();
            
            // Initialize order for notes that don't have one
            filteredNotes.forEach(note => {
                if (note.order === undefined) {
                    note.order = new Date(note.created).getTime();
                }
            });
            
            // Sort by current order to get the actual displayed order
            filteredNotes.sort((a, b) => {
                const orderA = a.order !== undefined ? a.order : new Date(a.created).getTime();
                const orderB = b.order !== undefined ? b.order : new Date(b.created).getTime();
                return orderA - orderB;
            });
            
            // Find indices in the sorted filtered list
            const draggedIndex = filteredNotes.findIndex(n => n.id === draggedId);
            const targetIndex = filteredNotes.findIndex(n => n.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Remove dragged note from its current position
            const [draggedNote] = filteredNotes.splice(draggedIndex, 1);
            
            // Insert at target position
            // If dragging forward (draggedIndex < targetIndex), insert after target
            // If dragging backward (draggedIndex > targetIndex), insert before target
            const insertIndex = draggedIndex < targetIndex ? targetIndex : targetIndex;
            filteredNotes.splice(insertIndex, 0, draggedNote);
            
            // Now reassign order values based on final positions
            // Use a base value and increment by 1000 for each position
            // This ensures we always have space between orders
            const baseOrder = 1000000; // Large base to avoid conflicts with timestamp-based orders
            filteredNotes.forEach((note, index) => {
                const noteInData = notesData.find(n => n.id === note.id);
                if (noteInData) {
                    noteInData.order = baseOrder + (index * 1000);
                }
            });
            
            saveData();
            renderNotes();
            
            // Keep the dragged note selected
            showNote(draggedId);
        }

        function reorderFavorites(draggedId, targetId) {
            if (draggedId === targetId) return;
            
            // Load current favorites order
            let favoritesOrder = {};
            try {
                favoritesOrder = JSON.parse(localStorage.getItem('favoritesOrder') || '{}');
            } catch (e) {
                favoritesOrder = {};
            }
            
            // Get all favorites with their current order
            const favoriteIds = Object.keys(favoritesOrder);
            const sortedFavorites = favoriteIds
                .map(id => ({ id, order: favoritesOrder[id] }))
                .sort((a, b) => a.order - b.order);
            
            const draggedIndex = sortedFavorites.findIndex(f => f.id === draggedId);
            const targetIndex = sortedFavorites.findIndex(f => f.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Remove dragged favorite from its current position
            const [draggedFavorite] = sortedFavorites.splice(draggedIndex, 1);
            
            // Insert at target position
            sortedFavorites.splice(targetIndex, 0, draggedFavorite);
            
            // Reassign order values based on final positions
            const baseOrder = 1000000;
            sortedFavorites.forEach((fav, index) => {
                favoritesOrder[fav.id] = baseOrder + (index * 1000);
            });
            
            localStorage.setItem('favoritesOrder', JSON.stringify(favoritesOrder));
            showFavoritesPage();
        }

        // Enhanced Debounced Search with Tag Search

        function toggleSubtexts(itemId, toggleButton) {
            const subtextContainer = document.getElementById(`subtexts-${itemId}`);
            if (subtextContainer) {
                const isShowing = subtextContainer.classList.toggle('show');
                toggleButton.textContent = isShowing ? '▼' : '▶';
                subtextToggleStates[itemId] = isShowing;
                saveData();
            }
        }
        
        // Favorites System
        function toggleFavorite(textId, pageId = null, sectionId = null) {
            let found = false;
            
            // If pageId and sectionId are provided (from favorites page), use them directly
            if (pageId && sectionId) {
                const targetPage = pagesData.find(p => p.id === pageId);
                if (targetPage) {
                    const section = targetPage.sections.find(s => s.id === sectionId);
                    if (section && section.texts) {
                        const findAndToggle = (texts) => {
                            for (const item of texts) {
                                if (item.id === textId) {
                                    const wasFavorite = item.favorite;
                                    item.favorite = !item.favorite;
                                    found = true;
                                    
                                    // Clean up order if unfavoriting
                                    if (wasFavorite && !item.favorite) {
                                        const favoriteId = `${item.id}-${pageId}-${sectionId}`;
                                        let favoritesOrder = {};
                                        try {
                                            favoritesOrder = JSON.parse(localStorage.getItem('favoritesOrder') || '{}');
                                        } catch (e) {
                                            favoritesOrder = {};
                                        }
                                        delete favoritesOrder[favoriteId];
                                        localStorage.setItem('favoritesOrder', JSON.stringify(favoritesOrder));
                                    }
                                    
                                    saveData();
                                    updateFavoriteButton(textId, item.favorite);
                                    showToast(item.favorite ? 'Added to favorites' : 'Removed from favorites', 'info');
                                    return;
                                }
                                if (item.subtexts) {
                                    findAndToggle(item.subtexts);
                                    if (found) return;
                                }
                            }
                        };
                        findAndToggle(section.texts);
                    }
                }
            }
            
            // If not found and we have a current page (not favorites page), search it
            if (!found && currentPageId && currentPageId !== 'favorites-page') {
                const currentPage = pagesData.find(p => p.id === currentPageId);
                if (currentPage) {
                    const findAndToggle = (texts) => {
                        for (const item of texts) {
                            if (item.id === textId) {
                                item.favorite = !item.favorite;
                                found = true;
                                saveData();
                                updateFavoriteButton(textId, item.favorite);
                                showToast(item.favorite ? 'Added to favorites' : 'Removed from favorites', 'info');
                                return;
                            }
                            if (item.subtexts) {
                                findAndToggle(item.subtexts);
                                if (found) return;
                            }
                        }
                    };
                    
                    for (const section of currentPage.sections) {
                        if (section.texts && !found) {
                            findAndToggle(section.texts);
                            if (found) break;
                        }
                    }
                }
            }
            
            // If still not found, search all pages
            if (!found) {
                for (const page of pagesData) {
                    for (const section of page.sections) {
                        if (section.texts) {
                            const findAndToggle = (texts) => {
                                for (const item of texts) {
                                    if (item.id === textId) {
                                        item.favorite = !item.favorite;
                                        found = true;
                                        saveData();
                                        updateFavoriteButton(textId, item.favorite);
                                        showToast(item.favorite ? 'Added to favorites' : 'Removed from favorites', 'info');
                                        return;
                                    }
                                    if (item.subtexts) {
                                        findAndToggle(item.subtexts);
                                        if (found) return;
                                    }
                                }
                            };
                            findAndToggle(section.texts);
                            if (found) break;
                        }
                    }
                    if (found) break;
                }
            }
        }
        
        function updateFavoriteButton(textId, isFavorite) {
            const container = document.querySelector(`[data-text-id="${textId}"]`);
            if (container) {
                const favoriteBtn = container.querySelector('.favorite-button');
                if (favoriteBtn) {
                    favoriteBtn.classList.toggle('active', isFavorite);
                }
            }
        }
        
        // Tags System
        
        // Filter System
        function applyFilter(filterType, button, tabId) {
            // Update button states
            const filterButtons = document.querySelectorAll(`#${tabId} .filter-button`);
            filterButtons.forEach(btn => btn.classList.remove('active'));
            if (button) button.classList.add('active');
            
            if (filterType === 'favorites') {
                // Show favorites page
                showFavoritesPage();
                return;
            }
            
            // Apply filter to current section only
            const containers = document.querySelectorAll(`#${tabId} .copy-container`);
            containers.forEach(container => {
                if (filterType === 'all') {
                    container.style.display = '';
                }
            });
        }
        
        // Unified Favorites View - DEPRECATED, use showFavoritesPage instead
        function showAllFavorites() {
            const allFavorites = [];
            
            // Collect all favorites from all pages and sections
            pagesData.forEach(page => {
                page.sections.forEach(section => {
                    if (section.texts) {
                        const collectFavorites = (texts, pageName, sectionName) => {
                            texts.forEach(item => {
                                if (item.favorite) {
                                    allFavorites.push({
                                        ...item,
                                        pageName: page.name,
                                        sectionName: section.label,
                                        pageId: page.id,
                                        sectionId: section.id
                                    });
                                }
                                if (item.subtexts) {
                                    collectFavorites(item.subtexts, pageName, sectionName);
                                }
                            });
                        };
                        collectFavorites(section.texts, page.name, section.label);
                    }
                });
            });
            
            // Create modal to show all favorites
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.closest('.modal').remove()">×</span>
                    <h2>⭐ All Favorites</h2>
                    <div id="allFavoritesList" style="margin-top: 20px;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const favoritesList = modal.querySelector('#allFavoritesList');
            if (allFavorites.length === 0) {
                favoritesList.innerHTML = '<p style="color: #aaa; text-align: center; padding: 40px;">No favorites yet. Click the ⭐ star on any snippet to favorite it.</p>';
            } else {
                allFavorites.forEach(item => {
                    const favoriteItem = document.createElement('div');
                    favoriteItem.style.cssText = 'padding: 15px; margin: 10px 0; background: #252525; border-radius: 6px; border-left: 3px solid #ffd700;';
                    favoriteItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #0073e6; margin-bottom: 5px; font-size: 15px;">${item.buttonText}</div>
                                <div style="color: #888; font-size: 11px; margin-bottom: 8px;">📁 ${item.pageName} → ${item.sectionName}</div>
                                <div style="color: #ddd; font-size: 12px; word-break: break-all; max-height: 60px; overflow: hidden;">${item.text.substring(0, 150)}${item.text.length > 150 ? '...' : ''}</div>
                            </div>
                            <button onclick="copyFavoriteFromModal('${item.id}', '${item.pageId}', '${item.sectionId}'); this.textContent='✓ Copied!'; setTimeout(() => this.textContent='Copy', 2000);" style="padding: 6px 12px; background: #0073e6; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px; margin-left: 10px;">Copy</button>
                        </div>
                    `;
                    favoritesList.appendChild(favoriteItem);
                });
            }
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        async function copyFavoriteFromModal(textId, pageId, sectionId) {
            // Find and copy the favorite item
            const page = pagesData.find(p => p.id === pageId);
            if (!page) return;
            
            const section = page.sections.find(s => s.id === sectionId);
            if (!section) return;
            
            const findAndCopy = (texts) => {
                for (const text of texts) {
                    if (text.id === textId) {
                        let textToCopy = text.text || '';
                        // Process variables if any
                        textToCopy = processVariables(textToCopy);
                        
                        // Copy directly
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                showToast('Copied to clipboard!', 'success');
                            }).catch(() => {
                                showToast('Failed to copy', 'error');
                            });
                        } else {
                            const tempTextarea = document.createElement('textarea');
                            tempTextarea.value = textToCopy;
                            tempTextarea.style.position = 'fixed';
                            tempTextarea.style.opacity = '0';
                            document.body.appendChild(tempTextarea);
                            tempTextarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempTextarea);
                            showToast('Copied to clipboard!', 'success');
                        }
                        return true;
                    }
                    if (text.subtexts) {
                        if (findAndCopy(text.subtexts)) return true;
                    }
                }
                return false;
            };
            
            if (section.texts) {
                findAndCopy(section.texts);
            }
        }
        
        function findItemById(textId) {
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (!currentPage) return null;
            
            for (const section of currentPage.sections) {
                if (section.texts) {
                    const found = findInTexts(section.texts, textId);
                    if (found) return found;
                }
            }
            return null;
        }
        
        function findInTexts(texts, textId) {
            for (const text of texts) {
                if (text.id === textId) return text;
                if (text.subtexts) {
                    const found = findInTexts(text.subtexts, textId);
                    if (found) return found;
                }
            }
            return null;
        }
        
        // Duplicate Snippet
        function duplicateSnippet(tabId, textId) {
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (!currentPage) return;
            
            const tab = currentPage.sections.find(s => s.id === tabId);
            if (!tab) return;
            
            const findAndDuplicate = (texts) => {
                for (let i = 0; i < texts.length; i++) {
                    if (texts[i].id === textId) {
                        const original = texts[i];
                        const duplicate = {
                            id: `text-${tabId}-${Date.now()}`,
                            buttonText: original.buttonText + ' (Copy)',
                            text: original.text,
                            favorite: false,
                            subtexts: original.subtexts ? JSON.parse(JSON.stringify(original.subtexts)) : []
                        };
                        texts.splice(i + 1, 0, duplicate);
                        saveData();
                        createTabContents();
                        showTab(tabId);
                        showToast('Snippet duplicated', 'success');
                        return;
                    }
                    if (texts[i].subtexts) {
                        findAndDuplicate(texts[i].subtexts);
                    }
                }
            };
            
            if (tab.texts) {
                findAndDuplicate(tab.texts);
            }
        }
        

        function addSubtext(tabId, parentId) {
            const tab = textData.find(tab => tab.id === tabId);
            if (tab) {
                const parent = findTextById(tab, parentId);
                if (parent) {
                    if (!parent.subtexts) {
                        parent.subtexts = [];
                    }

                    const newSubtextId = `subtext-${parentId}-${Date.now()}`;
                    const newSubtext = {
                        id: newSubtextId,
                        parentId: parentId,
                        buttonText: "Subtext",
                        text: "New subtext",
                        subtexts: []
                    };

                    parent.subtexts.push(newSubtext);
                    saveData();
                    createTabContents();
                    showTab(tabId);

                    const toggleButton = document.querySelector(`[data-text-id="${parentId}"] .toggle-subtext`);
                    if (toggleButton) {
                        toggleButton.classList.add('has-subtexts');
                        toggleSubtexts(parentId, toggleButton);
                    }
                }
            }
        }

        function removeSubtext(tabId, parentId, subtextId, listItem = null) {
            const currentPage = pagesData.find(p => p.id === currentPageId);
            if (!currentPage) return;
            const tab = currentPage.sections.find(tab => tab.id === tabId);
            if (tab) {
                const parent = findTextById(tab, parentId);
                if (parent && parent.subtexts) {
                    parent.subtexts = parent.subtexts.filter(item => item.id !== subtextId);
                    if (parent.subtexts.length === 0) {
                        const toggleButton = document.querySelector(`[data-text-id="${parentId}"] .toggle-subtext`);
                        if (toggleButton) {
                            toggleButton.classList.remove('has-subtexts');
                            delete subtextToggleStates[parentId];
                        }
                        // Hide the subtext container if empty
                        const subtextContainer = document.getElementById(`remove-subtexts-${parentId}`);
                        if (subtextContainer) {
                            subtextContainer.style.display = 'none';
                        }
                    }
                    saveData();
                    createTabContents();
                    showTab(tabId);
                    
                    // Remove the item from the modal list
                    if (listItem) {
                        listItem.remove();
                    } else {
                        // Fallback: find by data attribute
                        const item = document.querySelector(`[data-text-id="${subtextId}"][data-parent-id="${parentId}"]`);
                        if (item) item.remove();
                    }
                }
            }
        }

        function findTextById(tab, textId) {
            for (const text of tab.texts) {
                if (text.id === textId) {
                    return text;
                }
                if (text.subtexts) {
                    const found = findSubtextById(text.subtexts, textId);
                    if (found) return found;
                }
            }
            return null;
        }

        function findSubtextById(subtexts, textId) {
            for (const subtext of subtexts) {
                if (subtext.id === textId) {
                    return subtext;
                }
                if (subtext.subtexts) {
                    const found = findSubtextById(subtext.subtexts, textId);
                    if (found) return found;
                }
            }
            return null;
        }

        function openRemoveTextModal(tabId) {
            const modal = document.getElementById('removeTextModal');
            const textList = document.getElementById('textList');
            textList.innerHTML = '';

            const tab = textData.find(t => t.id === tabId);
            if (tab && tab.texts) {
                const addListItems = (texts) => {
                    texts.forEach(text => {
                        const listItem = createRemoveTextListItem(text, tabId);
                        textList.appendChild(listItem);
                        if (text.subtexts && text.subtexts.length > 0) {
                            const subtextContainer = document.createElement('div');
                            subtextContainer.classList.add('subtext-list-container');
                            subtextContainer.id = `remove-subtexts-${text.id}`;
                            subtextContainer.style.display = 'none';
                            subtextContainer.style.paddingLeft = '20px';
                            text.subtexts.forEach(subtext => {
                                const subtextItem = createRemoveTextListItem(subtext, tabId, text.id);
                                subtextContainer.appendChild(subtextItem);
                            });
                            textList.appendChild(subtextContainer);
                        }
                    });
                };
                addListItems(tab.texts);
            }
            modal.style.display = 'block';
        }

        function createRemoveTextListItem(text, tabId, parentId = null) {
            const listItem = document.createElement('div');
            listItem.classList.add('section-list-item');
            listItem.style.display = 'flex';
            listItem.style.alignItems = 'center';
            listItem.style.gap = '10px';
            listItem.dataset.textId = text.id;
            if (parentId) {
                listItem.dataset.parentId = parentId;
            }
            if (text.subtexts && text.subtexts.length > 0) {
                const toggleButton = document.createElement('button');
                toggleButton.textContent = '▶';
                toggleButton.classList.add('toggle-subtext');
                toggleButton.classList.add('has-subtexts');
                toggleButton.style.padding = '2px 6px';
                toggleButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const subtextContainer = document.getElementById(`remove-subtexts-${text.id}`);
                    if (subtextContainer) {
                        const isShowing = subtextContainer.style.display === 'block';
                        subtextContainer.style.display = isShowing ? 'none' : 'block';
                        toggleButton.textContent = isShowing ? '▶' : '▼';
                    }
                });
                listItem.appendChild(toggleButton);
            } else {
                const spacer = document.createElement('span');
                spacer.style.width = '24px';
                spacer.style.display = 'inline-block';
                listItem.appendChild(spacer);
            }
            const textSpan = document.createElement('span');
            textSpan.textContent = text.buttonText;
            textSpan.style.flex = '1';
            listItem.appendChild(textSpan);
            listItem.addEventListener('click', () => {
                if (parentId) {
                    removeSubtext(tabId, parentId, text.id, listItem);
                } else {
                    removeTextSnippet(tabId, text.id, listItem);
                }
                // Don't close modal - allow removing multiple items
                // closeRemoveTextModal();
            });
            return listItem;
        }

        function closeRemoveTextModal() {
            const modal = document.getElementById('removeTextModal');
            modal.style.display = 'none';
        }

        function renderPages() {
            const pagesList = document.getElementById('pagesList');
            pagesList.innerHTML = '';

            // Add Manage Pages button first
            const managePagesItem = document.createElement('div');
            managePagesItem.classList.add('pages-list-item', 'manage-item');
            managePagesItem.innerHTML = '✏️';
            managePagesItem.title = 'Manage Pages';
            managePagesItem.style.cursor = 'pointer';
            managePagesItem.style.position = 'relative';
            managePagesItem.draggable = false;
            managePagesItem.addEventListener('click', (e) => {
                e.stopPropagation();
                showManagePagesMenu(managePagesItem);
            });
            pagesList.appendChild(managePagesItem);

            // Add Favorites page
            const favoritesItem = document.createElement('div');
            favoritesItem.classList.add('pages-list-item');
            favoritesItem.innerHTML = '⭐';
            if (currentPageId === 'favorites-page') {
                favoritesItem.classList.add('active');
            }
            favoritesItem.draggable = false;
            favoritesItem.addEventListener('click', () => showFavoritesPage());
            pagesList.appendChild(favoritesItem);

            // Then add regular pages
            pagesData.forEach(page => {
                const pageItem = document.createElement('div');
                pageItem.classList.add('pages-list-item');
                pageItem.dataset.pageId = page.id;
                pageItem.textContent = page.name;
                if (page.id === currentPageId) {
                    pageItem.classList.add('active');
                }
                pageItem.draggable = true;
                pageItem.addEventListener('dragstart', (event) => dragStart(event, page.id, 'page'));
                pageItem.addEventListener('dragover', (event) => dragOver(event));
                pageItem.addEventListener('drop', (event) => drop(event, page.id, 'page'));
                pageItem.addEventListener('dragenter', (event) => dragEnter(event, pageItem));
                pageItem.addEventListener('dragleave', (event) => dragLeave(event, pageItem));
                pageItem.addEventListener('click', () => switchPage(page.id));
                pagesList.appendChild(pageItem);
            });
        }
        
        function showManagePagesMenu(element) {
            // Remove existing menu if any
            const existingMenu = document.querySelector('.manage-pages-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }
            
            const menu = document.createElement('div');
            menu.className = 'manage-pages-menu';
            menu.style.cssText = 'position: absolute; background: rgba(34, 34, 34, 0.98); border: 1px solid #444; border-radius: 6px; padding: 5px; z-index: 1000; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            menu.innerHTML = `
                <button onclick="openAddPageModal(); this.closest('.manage-pages-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Add Page</button>
                <button onclick="openRenamePageModal(); this.closest('.manage-pages-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Rename Page</button>
                <button onclick="openRemovePageModal(); this.closest('.manage-pages-menu').remove();" style="width: 100%; padding: 8px; background: none; border: none; color: #ddd; text-align: left; cursor: pointer; border-radius: 4px;">Remove Page</button>
            `;
            
            const rect = element.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 5) + 'px';
            document.body.appendChild(menu);
            
            // Close on outside click
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && e.target !== element) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        }
        
        function showFavoritesPage() {
            currentPageId = 'favorites-page';
            renderPages();
            
            // Collect all favorites
            const allFavorites = [];
            pagesData.forEach(page => {
                page.sections.forEach(section => {
                    if (section.texts) {
                        const collectFavorites = (texts) => {
                            texts.forEach(item => {
                                if (item.favorite) {
                                    allFavorites.push({
                                        ...item,
                                        pageId: page.id,
                                        sectionId: section.id,
                                        favoriteId: `${item.id}-${page.id}-${section.id}` // Unique ID for favorites
                                    });
                                }
                                if (item.subtexts) {
                                    collectFavorites(item.subtexts);
                                }
                            });
                        };
                        collectFavorites(section.texts);
                    }
                });
            });
            
            // Load favorites order from localStorage
            let favoritesOrder = {};
            try {
                favoritesOrder = JSON.parse(localStorage.getItem('favoritesOrder') || '{}');
            } catch (e) {
                favoritesOrder = {};
            }
            
            // Initialize order for favorites that don't have one
            allFavorites.forEach(fav => {
                if (!favoritesOrder[fav.favoriteId]) {
                    favoritesOrder[fav.favoriteId] = Date.now();
                }
            });
            
            // Sort by order
            allFavorites.sort((a, b) => {
                const orderA = favoritesOrder[a.favoriteId] || 0;
                const orderB = favoritesOrder[b.favoriteId] || 0;
                return orderA - orderB;
            });
            
            // Clear tabs and create favorites content
            const tabButtonsContainer = document.getElementById('tabButtons');
            const tabContentsContainer = document.getElementById('tabContents');
            tabButtonsContainer.innerHTML = '';
            tabContentsContainer.innerHTML = '';
            
            // Create a single section for favorites
            const favoritesSection = document.createElement('div');
            favoritesSection.id = 'favorites-section';
            favoritesSection.classList.add('tab-content');
            favoritesSection.style.display = 'block';
            
            if (allFavorites.length === 0) {
                favoritesSection.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">⭐</div>
                        <div style="font-size: 18px; margin-bottom: 10px; color: #aaa;">No favorites yet</div>
                        <div style="font-size: 14px; color: #666;">Click the ⭐ star on any snippet to favorite it</div>
                    </div>
                `;
            } else {
                // Use a special tabId for favorites
                const favoritesTabId = 'favorites-tab';
                
                allFavorites.forEach(item => {
                    // Use createTextContainer to get the exact same structure as normal snippets
                    const container = createTextContainer(item, favoritesTabId);
                    
                    // Store the original pageId and sectionId for the favorite button
                    container.dataset.pageId = item.pageId;
                    container.dataset.sectionId = item.sectionId;
                    container.dataset.favoriteId = item.favoriteId;
                    
                    // Replace drag handlers for favorites (remove old ones, add new ones)
                    // Clone the container to remove all event listeners
                    const newContainer = container.cloneNode(true);
                    if (container.parentNode) {
                        container.parentNode.replaceChild(newContainer, container);
                    }
                    const finalContainer = newContainer;
                    
                    // Re-add all necessary event listeners for favorites
                    finalContainer.draggable = true;
                    
                    // Drag handlers for favorites
                    finalContainer.addEventListener('dragstart', (e) => {
                        if (e.target.closest('button') || e.target.tagName === 'BUTTON') {
                            e.preventDefault();
                            return false;
                        }
                        dragStart(e, item.favoriteId, 'favorite');
                    });
                    finalContainer.addEventListener('dragend', (e) => {
                        e.target.style.opacity = '';
                        document.querySelectorAll('#favorites-section .copy-container').forEach(c => {
                            c.classList.remove('drag-over');
                        });
                    });
                    finalContainer.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dragOver(e);
                    });
                    finalContainer.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        drop(e, item.favoriteId, 'favorite');
                    });
                    finalContainer.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        dragEnter(e, finalContainer);
                    });
                    finalContainer.addEventListener('dragleave', (e) => {
                        dragLeave(e, finalContainer);
                    });
                    
                    // Re-add toggle subtext functionality
                    const toggleBtn = finalContainer.querySelector('.toggle-subtext');
                    if (toggleBtn && item.subtexts && item.subtexts.length > 0) {
                        toggleBtn.addEventListener('click', () => {
                            const subtextContainer = document.getElementById(`subtexts-${item.id}`);
                            if (subtextContainer) {
                                const isShowing = subtextContainer.classList.toggle('show');
                                toggleBtn.textContent = isShowing ? '▼' : '▶';
                                subtextToggleStates[item.id] = isShowing;
                                saveData();
                            }
                        });
                    }
                    
                    // Update favorite button
                    const favoriteBtn = finalContainer.querySelector('.favorite-button');
                    if (favoriteBtn) {
                        favoriteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleFavorite(item.id, item.pageId, item.sectionId);
                            setTimeout(() => {
                                showFavoritesPage();
                            }, 100);
                        });
                    }
                    
                    // Copy button should work with existing copyToClipboard function
                    const copyBtn = finalContainer.querySelector('.copy-button');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', () => {
                            copyToClipboard(item.id, `success-${item.id}`);
                            copyBtn.classList.add('copied');
                            setTimeout(() => copyBtn.classList.remove('copied'), 600);
                        });
                    }
                    
                    // Edit button functionality
                    const editBtn = finalContainer.querySelector('.edit-button');
                    if (editBtn) {
                        editBtn.addEventListener('click', () => toggleEdit(item.id, finalContainer));
                    }
                    
                    // Add subtext button
                    const addSubtextBtn = finalContainer.querySelector('.add-subtext-button');
                    if (addSubtextBtn) {
                        addSubtextBtn.addEventListener('click', () => {
                            // For favorites, we need to add subtext to the original location
                            const page = pagesData.find(p => p.id === item.pageId);
                            if (page) {
                                const section = page.sections.find(s => s.id === item.sectionId);
                                if (section) {
                                    addSubtext(section.id, item.id);
                                    setTimeout(() => showFavoritesPage(), 100);
                                }
                            }
                        });
                    }
                    
                    // Input and textarea handlers
                    const input = finalContainer.querySelector('.hidden-input');
                    if (input) {
                        input.addEventListener('input', () => saveTextEdit(item.id, 'buttonText'));
                    }
                    const textarea = finalContainer.querySelector('.hidden-textarea');
                    if (textarea) {
                        textarea.addEventListener('input', () => saveTextEdit(item.id, 'text'));
                    }
                    
                    favoritesSection.appendChild(finalContainer);
                });
            }
            
            tabContentsContainer.appendChild(favoritesSection);
            localStorage.setItem('favoritesOrder', JSON.stringify(favoritesOrder));
        }

        function switchPage(pageId) {
            currentPageId = pageId;
            const page = pagesData.find(p => p.id === pageId);
            if (page) {
                textData = page.sections || [];
                createTabs();
                createTabContents();
                loadTextEdits();
                if (textData.length > 0) {
                    showTab(textData[0].id);
                }
                renderPages();
                saveData();
            }
        }

        function openAddPageModal() {
            // Inline add - no modal
            const pagesList = document.getElementById('pagesList');
            if (!pagesList) return;
            
            // Create inline input at the top
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Page name...';
            input.style.width = '100%';
            input.style.padding = '10px';
            input.style.marginBottom = '10px';
            input.style.background = 'rgba(0, 115, 230, 0.1)';
            input.style.border = '2px solid #0073e6';
            input.style.borderRadius = '6px';
            input.style.color = '#fff';
            input.style.fontSize = '14px';
            
            const addButton = document.createElement('button');
            addButton.textContent = '✓';
            addButton.className = 'add-remove-button';
            addButton.style.marginLeft = '5px';
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = '✕';
            cancelButton.className = 'remove-section-button';
            cancelButton.style.marginLeft = '5px';
            
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.alignItems = 'center';
            container.style.marginBottom = '10px';
            container.appendChild(input);
            container.appendChild(addButton);
            container.appendChild(cancelButton);
            
            pagesList.insertBefore(container, pagesList.firstChild);
            input.focus();
            
            const finishAdd = () => {
                const name = input.value.trim() || `Page ${pagesData.length + 1}`;
                if (pagesData.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    showToast('A page with this name already exists', 'error');
                    return;
                }
                const newPageId = `page-${Date.now()}`;
                const sectionId = `section-${Date.now()}`;
                const newPage = {
                    id: newPageId,
                    name: name,
                    sections: [{
                        id: sectionId,
                        label: `Section 1`,
                        className: `tab-custom-0`,
                        texts: [{
                            id: `text-${sectionId}-${Date.now()}`,
                            buttonText: "Copy",
                            text: "Text",
                        }]
                    }]
                };
                pagesData.push(newPage);
                saveData();
                renderPages();
                switchPage(newPageId);
                container.remove();
            };
            
            addButton.onclick = finishAdd;
            cancelButton.onclick = () => container.remove();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishAdd();
                } else if (e.key === 'Escape') {
                    container.remove();
                }
            });
        }

        function closeAddPageModal() {
            // No modal to close
        }

        function addPage(name) {
            if (!name) {
                openAddPageModal();
                return;
            }
            if (pagesData.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast('A page with this name already exists', 'error');
                return;
            }
            const newPageId = `page-${Date.now()}`;
            const sectionId = `section-${Date.now()}`;
            const newPage = {
                id: newPageId,
                name: name.trim(),
                sections: [{
                    id: sectionId,
                    label: `Section 1`,
                    className: `tab-custom-0`,
                    texts: [{
                        id: `text-${sectionId}-${Date.now()}`,
                        buttonText: "Copy",
                        text: "Text",
                    }]
                }]
            };
            pagesData.push(newPage);
            saveData();
            renderPages();
            switchPage(newPageId);
        }

        function openRemovePageModal() {
            const modal = document.getElementById('removePageModal');
            const pageList = document.getElementById('pageList');
            pageList.innerHTML = '';
            pagesData.forEach(page => {
                const listItem = document.createElement('li');
                listItem.classList.add('section-list-item');
                listItem.dataset.pageId = page.id;
                listItem.textContent = page.name;
                listItem.addEventListener('click', () => removePage(page.id, listItem));
                pageList.appendChild(listItem);
            });
            modal.style.display = 'block';
        }

        function closeRemovePageModal() {
            const modal = document.getElementById('removePageModal');
            modal.style.display = 'none';
        }

        function removePage(pageId, listItem = null) {
            pagesData = pagesData.filter(page => page.id !== pageId);
            saveData();
            if (currentPageId === pageId) {
                if (pagesData.length > 0) {
                    switchPage(pagesData[0].id);
                } else {
                    textData = [];
                    createTabs();
                    createTabContents();
                }
            }
            renderPages();
            
            // Remove the item from the modal list
            if (listItem) {
                listItem.remove();
            } else {
                // Fallback: find by data attribute
                const item = document.querySelector(`[data-page-id="${pageId}"]`);
                if (item) item.remove();
            }
            
            // Close modal if no pages left
            const pageList = document.getElementById('pageList');
            if (pageList && pageList.children.length === 0) {
                closeRemovePageModal();
            }
        }

        function openRenamePageModal() {
            const modal = document.getElementById('renamePageModal');
            const pageList = document.getElementById('renamePageList');
            pageList.innerHTML = '';
            pagesData.forEach(page => {
                const listItem = document.createElement('li');
                listItem.classList.add('section-list-item');
                listItem.textContent = page.name;
                listItem.addEventListener('click', () => promptNewPageName(page.id));
                pageList.appendChild(listItem);
            });
            modal.style.display = 'block';
        }

        function closeRenamePageModal() {
            const modal = document.getElementById('renamePageModal');
            modal.style.display = 'none';
        }

        function promptNewPageName(pageId) {
            // Close the modal first
            closeRenamePageModal();
            
            // Inline editing - no popup
            const page = pagesData.find(p => p.id === pageId);
            if (!page) return;
            
            const pageItem = document.querySelector(`[data-page-id="${pageId}"]`);
            if (!pageItem) {
                showToast('Page not found', 'error');
                return;
            }
            
            const currentName = page.name;
            const originalContent = pageItem.textContent;
            
            // Create inline input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.style.background = 'rgba(255, 215, 0, 0.2)';
            input.style.border = '1px solid #ffd700';
            input.style.borderRadius = '4px';
            input.style.padding = '4px 8px';
            input.style.color = '#fff';
            input.style.fontSize = '14px';
            input.style.width = '200px';
            input.style.display = 'block';
            input.style.margin = '0';
            
            // Replace page item content with input
            pageItem.textContent = '';
            pageItem.appendChild(input);
            input.focus();
            input.select();
            
            const finishEdit = () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    // Check for duplicates
                    if (pagesData.some(p => p.id !== pageId && p.name.toLowerCase() === newName.toLowerCase())) {
                        showToast('A page with this name already exists', 'error');
                        pageItem.textContent = originalContent;
                        return;
                    }
                    page.name = newName;
                    saveData();
                    renderPages();
                    switchPage(pageId);
                } else {
                    pageItem.textContent = originalContent;
                }
            };
            
            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    input.blur(); // This will trigger finishEdit
                } else if (e.key === 'Escape') {
                    pageItem.textContent = originalContent;
                }
            });
        }

        function toggleNotepad() {
            const notepadContainer = document.getElementById('notepadContainer');
            const notepadToggle = document.querySelector('.notepad-toggle');
            const isVisible = notepadContainer.style.display === 'block';
            notepadContainer.style.display = isVisible ? 'none' : 'block';
            
            // Update button active state
            if (notepadToggle) {
                if (!isVisible) {
                    notepadToggle.classList.add('active');
                    localStorage.setItem('notepadOpen', 'true');
                } else {
                    notepadToggle.classList.remove('active');
                    localStorage.setItem('notepadOpen', 'false');
                }
            }

            if (!isVisible) {
                renderNotes();
                renderCategories();
                updateNoteCounts();
                if (currentNoteId) {
                    showNote(currentNoteId);
                } else if (notesData.length > 0) {
                    showNote(notesData[0].id);
                }
            }
        }

        function renderNotes() {
            const notepadTabs = document.getElementById('notepadTabs');
            if (!notepadTabs) return;
            
            notepadTabs.innerHTML = '';

            let filteredNotes = getFilteredNotes();
            
            // Initialize order for notes that don't have one (based on creation date - oldest first)
            filteredNotes.forEach(note => {
                if (note.order === undefined) {
                    // Use creation timestamp as order (oldest = lower number)
                    note.order = new Date(note.created).getTime();
                }
            });
            
            // Sort: by order first (manual drag order), then by creation date (oldest first)
            filteredNotes.sort((a, b) => {
                // If both have explicit orders, use those
                if (a.order !== undefined && b.order !== undefined) {
                    return a.order - b.order;
                }
                // Otherwise, sort by creation date (oldest first)
                const dateA = new Date(a.created);
                const dateB = new Date(b.created);
                return dateA - dateB;
            });

            if (filteredNotes.length === 0) {
                return;
            }

            filteredNotes.forEach((note) => {
                const tab = document.createElement('div');
                tab.classList.add('notepad-tab');
                tab.dataset.noteId = note.id;
                if (note.id === currentNoteId) {
                    tab.classList.add('active');
                }
                
                // Make tab draggable
                tab.draggable = true;
                
                const title = note.title || 'Untitled Note';
                const titleText = title.length > 25 ? title.substring(0, 25) + '...' : title;
                
                const titleSpan = document.createElement('span');
                titleSpan.classList.add('notepad-tab-title');
                titleSpan.textContent = `${note.favorite ? '⭐ ' : ''}${titleText}`;
                
                const closeSpan = document.createElement('span');
                closeSpan.classList.add('notepad-tab-close');
                closeSpan.textContent = '×';
                closeSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    closeNoteTab(note.id);
                });
                closeSpan.addEventListener('mousedown', (e) => {
                    e.stopPropagation(); // Prevent drag when clicking close
                });
                
                tab.appendChild(titleSpan);
                tab.appendChild(closeSpan);
                
                // Drag event handlers - must be on the tab, not inner elements
                tab.addEventListener('dragstart', (e) => {
                    // Don't start drag if clicking on close button
                    if (e.target.classList.contains('notepad-tab-close') || e.target.closest('.notepad-tab-close')) {
                        e.preventDefault();
                        return false;
                    }
                    dragStart(e, note.id, 'note');
                    e.stopPropagation();
                });
                tab.addEventListener('dragend', (e) => {
                    // Reset opacity after drag ends
                    e.target.style.opacity = '';
                    // Remove drag-over class from all tabs
                    document.querySelectorAll('.notepad-tab').forEach(t => {
                        t.classList.remove('drag-over');
                    });
                });
                tab.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dragOver(e);
                });
                tab.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    drop(e, note.id, 'note');
                });
                tab.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dragEnter(e, tab);
                });
                tab.addEventListener('dragleave', (e) => {
                    dragLeave(e, tab);
                });
                
                tab.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('notepad-tab-close')) {
                        showNote(note.id);
                    }
                });
                
                notepadTabs.appendChild(tab);
            });
        }
        
        function closeNoteTab(noteId) {
            const note = notesData.find(n => n.id === noteId);
            if (!note) return;
            
            if (confirm(`Close "${note.title || 'Untitled Note'}"?`)) {
                if (currentNoteId === noteId) {
                    // If closing active note, switch to another
                    const filteredNotes = getFilteredNotes();
                    const currentIndex = filteredNotes.findIndex(n => n.id === noteId);
                    if (filteredNotes.length > 1) {
                        const nextIndex = currentIndex > 0 ? currentIndex - 1 : 1;
                        if (filteredNotes[nextIndex]) {
                            showNote(filteredNotes[nextIndex].id);
                        }
                    } else {
                        currentNoteId = null;
                        showNote(null);
                    }
                }
                // Remove the note
                notesData = notesData.filter(n => n.id !== noteId);
                saveData();
                renderNotes();
                renderCategories();
                updateNoteCounts();
                if (currentNoteId === noteId) {
                    currentNoteId = null;
                    showNote(null);
                }
            }
        }

        function getFilteredNotes() {
            let filtered = [...notesData];
            
            // Apply category filter
            if (currentNoteFilter === 'favorites') {
                filtered = filtered.filter(note => note.favorite);
            } else if (currentNoteFilter !== 'all') {
                filtered = filtered.filter(note => note.category === currentNoteFilter);
            }
            
            return filtered;
        }

        function showNote(noteId) {
            currentNoteId = noteId;
            const note = notesData.find(n => n.id === noteId);
            const editor = document.getElementById('notepadEditor');
            const textarea = document.getElementById('notepadTextarea');
            const titleInput = document.getElementById('notepadTitleInput');
            const metaInfo = document.getElementById('notepadMetaInfo');
            const emptyState = document.getElementById('notepadEmptyState');
            const favoriteBtn = document.getElementById('notepadFavoriteBtn');

            if (note) {
                emptyState.style.display = 'none';
                textarea.style.display = 'block';
                titleInput.value = note.title || 'Untitled Note';
                textarea.value = note.content || '';
                
                const created = new Date(note.created);
                const modified = new Date(note.modified || note.created);
                const content = note.content || '';
                const words = content.trim() ? content.trim().split(/\s+/).length : 0;
                const chars = content.length;
                const lines = content.split('\n').length;
                
                updateNoteStats(words, chars, lines);
                
                let categoryDisplay = '';
                if (note.category) {
                    const catObj = noteCategories.find(cat => {
                        const catName = typeof cat === 'string' ? cat : cat.name;
                        return catName === note.category;
                    });
                    const catColor = (typeof catObj === 'object' && catObj.color) ? catObj.color : '#0073e6';
                    categoryDisplay = `<span style="display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 5px; background: linear-gradient(135deg, ${catColor} 0%, ${catColor}dd 100%); margin-right: 8px; position: relative; box-shadow: 0 2px 5px ${catColor}40, inset 0 1px 0 rgba(255, 255, 255, 0.3); border: 1px solid ${catColor}80;"><span style="font-size: 13px; line-height: 1; filter: brightness(0) invert(1) drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));">📁</span></span><span>${note.category}</span>`;
                }
                metaInfo.innerHTML = `
                    <span>Created: ${formatDate(created)}</span>
                    <span>Modified: ${formatDate(modified)}</span>
                    ${categoryDisplay}
                `;
                
                // Update favorite button
                if (note.favorite) {
                    favoriteBtn.classList.add('favorite-active');
                    favoriteBtn.querySelector('span').textContent = '★';
                } else {
                    favoriteBtn.classList.remove('favorite-active');
                    favoriteBtn.querySelector('span').textContent = '☆';
                }
                
                // Focus textarea
                setTimeout(() => textarea.focus(), 100);
            } else {
                emptyState.style.display = 'flex';
                textarea.style.display = 'none';
            }

            renderNotes();
        }

        function addNewNote() {
            // Show empty state instead of creating immediately
            currentNoteId = null;
            showNote(null);
        }
        
        function createNewNote() {
            const noteId = `note-${Date.now()}`;
            const now = Date.now();
            const newNote = {
                id: noteId,
                title: `Note ${notesData.length + 1}`,
                content: '',
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                favorite: false,
                category: null,
                order: now // Set order to current timestamp (newest notes get higher order)
            };

            notesData.push(newNote);
            saveData();
            updateNoteCounts();
            renderNotes();
            showNote(noteId);
            
            // Focus title input for immediate editing
            setTimeout(() => {
                const titleInput = document.getElementById('notepadTitleInput');
                if (titleInput) {
                    titleInput.select();
                    titleInput.focus();
                }
            }, 100);
        }

        function removeCurrentNote() {
            if (!currentNoteId) return;
            
            showConfirmDialog('Delete Note', 'Are you sure you want to delete this note?', () => {
                notesData = notesData.filter(note => note.id !== currentNoteId);
                saveData();

                currentNoteId = notesData.length > 0 ? notesData[0].id : null;
                renderNotes();
                renderCategories();
                updateNoteCounts();

                if (currentNoteId) {
                    showNote(currentNoteId);
                } else {
                    const emptyState = document.getElementById('notepadEmptyState');
                    const textarea = document.getElementById('notepadTextarea');
                    if (emptyState) emptyState.style.display = 'flex';
                    if (textarea) textarea.style.display = 'none';
                }
                showToast('Note deleted', 'success');
            });
        }
        
        // Better Confirmation Dialog
        function showConfirmDialog(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '99999'; // Ensure it's above everything
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '400px';
            modalContent.style.zIndex = '99999'; // Ensure it's above everything
            
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close';
            closeBtn.textContent = '×';
            closeBtn.onclick = () => modal.remove();
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'confirm-modal-content';
            
            const titleEl = document.createElement('h2');
            titleEl.textContent = title;
            
            const messageEl = document.createElement('p');
            messageEl.style.cssText = 'color: #aaa; margin: 20px 0;';
            messageEl.textContent = message;
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'confirm-buttons';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'add-remove-button';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => modal.remove();
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'remove-section-button';
            confirmBtn.textContent = 'Confirm';
            confirmBtn.onclick = () => {
                modal.remove();
                onConfirm();
            };
            
            buttonsDiv.appendChild(cancelBtn);
            buttonsDiv.appendChild(confirmBtn);
            contentDiv.appendChild(titleEl);
            contentDiv.appendChild(messageEl);
            contentDiv.appendChild(buttonsDiv);
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(contentDiv);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        function saveNoteTitle() {
            if (!currentNoteId) return;
            const titleInput = document.getElementById('notepadTitleInput');
            const note = notesData.find(n => n.id === currentNoteId);
            if (note && titleInput) {
                const newTitle = titleInput.value.trim() || 'Untitled Note';
                if (newTitle !== note.title) {
                    note.title = newTitle;
                    note.modified = new Date().toISOString();
                    saveData();
                    renderNotes();
                }
            }
        }

        function handleNoteTitleKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveNoteTitle();
                const textarea = document.getElementById('notepadTextarea');
                if (textarea) textarea.focus();
            } else if (event.key === 'Escape') {
                const note = notesData.find(n => n.id === currentNoteId);
                if (note) {
                    const titleInput = document.getElementById('notepadTitleInput');
                    if (titleInput) titleInput.value = note.title;
                }
            }
        }

        function saveNoteContent() {
            if (!currentNoteId) return;

            const textarea = document.getElementById('notepadTextarea');
            const note = notesData.find(n => n.id === currentNoteId);

            if (note && textarea) {
                note.content = textarea.value;
                note.modified = new Date().toISOString();
                saveData();
                
                // Update stats
                const content = textarea.value || '';
                const words = content.trim() ? content.trim().split(/\s+/).length : 0;
                const chars = content.length;
                const lines = content.split('\n').length;
                updateNoteStats(words, chars, lines);
                
                // Show save indicator
                const saveIndicator = document.getElementById('notepadSaveIndicator');
                if (saveIndicator) {
                    saveIndicator.style.display = 'inline';
                    setTimeout(() => {
                        saveIndicator.style.display = 'none';
                    }, 2000);
                }
                
                // Update preview in list
                renderNotes();
            }
        }

        function updateNoteStats(words, chars, lines) {
            const statsEl = document.getElementById('notepadStats');
            if (statsEl) {
                statsEl.innerHTML = `${words} words • ${chars} characters • ${lines} lines`;
            }
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                return 'Today ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } else if (days === 1) {
                return 'Yesterday ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } else if (days < 7) {
                return days + ' days ago';
            } else {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }

        // Search notes
        // Search function removed

        // Category functions
        function filterNotesByCategory(category) {
            // Toggle: if clicking the same category again, go back to "all"
            if (currentNoteFilter === category) {
                category = 'all';
            }
            
            currentNoteFilter = category;
            document.querySelectorAll('.notepad-category-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`)?.classList.add('active');
            renderNotes();
        }

        function renderCategories() {
            const container = document.getElementById('notepadCustomCategories');
            if (!container) return;
            
            container.innerHTML = '';
            noteCategories.forEach(categoryObj => {
                const categoryName = typeof categoryObj === 'string' ? categoryObj : categoryObj.name;
                const categoryColor = typeof categoryObj === 'object' && categoryObj.color ? categoryObj.color : '#0073e6';
                const item = document.createElement('div');
                item.className = 'notepad-category-item';
                item.dataset.category = categoryName;
                
                const folderIconWrapper = document.createElement('span');
                folderIconWrapper.className = 'category-folder-icon-wrapper';
                folderIconWrapper.style.cssText = `display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 6px; background: linear-gradient(135deg, ${categoryColor} 0%, ${categoryColor}dd 100%); margin-right: 10px; position: relative; box-shadow: 0 2px 6px ${categoryColor}40, inset 0 1px 0 rgba(255, 255, 255, 0.3); border: 1px solid ${categoryColor}80;`;
                
                const folderIcon = document.createElement('span');
                folderIcon.className = 'category-folder-icon';
                folderIcon.style.cssText = `font-size: 14px; line-height: 1; filter: brightness(0) invert(1) drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));`;
                folderIcon.textContent = '📁';
                folderIconWrapper.appendChild(folderIcon);
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = ` ${categoryName}`;
                
                const countSpan = document.createElement('span');
                countSpan.className = 'note-count';
                countSpan.textContent = notesData.filter(n => n.category === categoryName).length;
                
                const editBtn = document.createElement('span');
                editBtn.className = 'notepad-edit-category';
                editBtn.title = 'Edit category color';
                editBtn.textContent = '✏️';
                editBtn.style.cssText = 'margin-left: 3px; color: #ffd700; cursor: pointer; padding: 2px 6px; border-radius: 4px; font-size: 12px; z-index: 10; position: relative;';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    editCategoryColor(categoryName);
                });
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'notepad-delete-category';
                deleteBtn.title = 'Delete category';
                deleteBtn.textContent = '🗑️';
                deleteBtn.style.cssText = 'margin-left: 5px; color: #f44336; cursor: pointer; padding: 2px 6px; border-radius: 4px; font-size: 12px; z-index: 10; position: relative;';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    deleteCategory(categoryName);
                });
                
                item.appendChild(folderIconWrapper);
                item.appendChild(nameSpan);
                item.appendChild(countSpan);
                item.appendChild(editBtn);
                item.appendChild(deleteBtn);
                item.onclick = () => filterNotesByCategory(categoryName);
                container.appendChild(item);
            });
        }

        function deleteCategory(categoryName) {
            if (!categoryName) return;
            
            const notesInCategory = notesData.filter(n => n.category === categoryName).length;
            if (notesInCategory > 0) {
                showConfirmDialog('Delete Category', `This category has ${notesInCategory} note(s). They will be moved to "No category". Delete this category?`, () => {
                    // Remove category from notes
                    notesData.forEach(note => {
                        if (note.category === categoryName) {
                            note.category = null;
                        }
                    });
                    
                    // Remove category from list
                    noteCategories = noteCategories.filter(cat => {
                        const catName = typeof cat === 'string' ? cat : cat.name;
                        return catName !== categoryName;
                    });
                    localStorage.setItem('noteCategories', JSON.stringify(noteCategories));
                    
                    // If current filter is this category, switch to "all"
                    if (currentNoteFilter === categoryName) {
                        filterNotesByCategory('all');
                    }
                    
                    saveData();
                    renderCategories();
                    renderNotes();
                    updateNoteCounts();
                    showToast('Category deleted', 'success');
                });
            } else {
                // No notes in category, just delete it
                noteCategories = noteCategories.filter(cat => {
                    const catName = typeof cat === 'string' ? cat : cat.name;
                    return catName !== categoryName;
                });
                localStorage.setItem('noteCategories', JSON.stringify(noteCategories));
                
                if (currentNoteFilter === categoryName) {
                    filterNotesByCategory('all');
                }
                
                renderCategories();
                updateNoteCounts();
                showToast('Category deleted', 'success');
            }
        }

        function addNewCategory() {
            const categoryName = prompt('Enter category name:');
            if (categoryName && categoryName.trim()) {
                const name = categoryName.trim();
                // Check if category already exists
                const exists = noteCategories.some(cat => {
                    const catName = typeof cat === 'string' ? cat : cat.name;
                    return catName === name;
                });
                
                if (!exists) {
                    // Show color picker
                    const color = showCategoryColorPicker('#0073e6', (selectedColor) => {
                        noteCategories.push({ name: name, color: selectedColor });
                        localStorage.setItem('noteCategories', JSON.stringify(noteCategories));
                        renderCategories();
                        updateNoteCounts();
                        showToast('Category added', 'success');
                    });
                } else {
                    showToast('Category already exists', 'error');
                }
            }
        }
        
        function editCategoryColor(categoryName) {
            const category = noteCategories.find(cat => {
                const catName = typeof cat === 'string' ? cat : cat.name;
                return catName === categoryName;
            });
            const currentColor = (typeof category === 'object' && category.color) ? category.color : '#0073e6';
            
            showCategoryColorPicker(currentColor, (selectedColor) => {
                const categoryIndex = noteCategories.findIndex(cat => {
                    const catName = typeof cat === 'string' ? cat : cat.name;
                    return catName === categoryName;
                });
                if (categoryIndex !== -1) {
                    noteCategories[categoryIndex] = { name: categoryName, color: selectedColor };
                    localStorage.setItem('noteCategories', JSON.stringify(noteCategories));
                    renderCategories();
                    showToast('Category color updated', 'success');
                }
            });
        }
        
        function showCategoryColorPicker(initialColor, callback) {
            const colors = [
                '#0073e6', '#4caf50', '#ff9800', '#e91e63', '#9c27b0', 
                '#00bcd4', '#ff5722', '#795548', '#607d8b', '#ffd700',
                '#ff1744', '#00e676', '#3f51b5', '#ff6f00', '#e91e63'
            ];
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100000; display: flex; align-items: center; justify-content: center;';
            
            const colorPicker = document.createElement('div');
            colorPicker.style.cssText = 'background: var(--theme-bg-secondary); border: 2px solid var(--theme-border); border-radius: 8px; padding: 20px; max-width: 400px; width: 90%;';
            
            const title = document.createElement('h3');
            title.style.cssText = 'color: var(--theme-text-primary); margin: 0 0 15px 0;';
            title.textContent = 'Choose Folder Color';
            colorPicker.appendChild(title);
            
            const colorsGrid = document.createElement('div');
            colorsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;';
            
            let selectedColor = initialColor;
            
            colors.forEach(color => {
                const colorBtn = document.createElement('button');
                colorBtn.style.cssText = `width: 40px; height: 40px; border-radius: 50%; background: ${color}; border: 3px solid ${color === initialColor ? '#ffffff' : 'transparent'}; cursor: pointer; transition: all 0.2s;`;
                if (color === initialColor) {
                    colorBtn.classList.add('selected-color');
                }
                colorBtn.dataset.selectedColor = color;
                colorBtn.addEventListener('click', () => {
                    colorsGrid.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('selected-color');
                        btn.style.border = '3px solid transparent';
                    });
                    colorBtn.classList.add('selected-color');
                    colorBtn.style.border = '3px solid #ffffff';
                    selectedColor = color;
                });
                colorsGrid.appendChild(colorBtn);
            });
            
            colorPicker.appendChild(colorsGrid);
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.cssText = 'padding: 8px 16px; background: var(--theme-bg-tertiary); color: var(--theme-text-primary); border: 1px solid var(--theme-border); border-radius: 4px; cursor: pointer;';
            cancelBtn.addEventListener('click', () => {
                modal.remove();
            });
            buttonsContainer.appendChild(cancelBtn);
            
            const applyBtn = document.createElement('button');
            applyBtn.textContent = 'Apply';
            applyBtn.style.cssText = 'padding: 8px 16px; background: var(--theme-accent); color: #000000; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;';
            applyBtn.addEventListener('click', () => {
                callback(selectedColor);
                modal.remove();
            });
            buttonsContainer.appendChild(applyBtn);
            
            colorPicker.appendChild(buttonsContainer);
            modal.appendChild(colorPicker);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function updateNoteCounts() {
            const allCount = document.getElementById('allNotesCount');
            const favoriteCount = document.getElementById('favoriteNotesCount');
            if (allCount) allCount.textContent = notesData.length;
            if (favoriteCount) favoriteCount.textContent = notesData.filter(n => n.favorite).length;
            
            // Update custom category counts
            document.querySelectorAll('#notepadCustomCategories .note-count').forEach(countEl => {
                const categoryItem = countEl.closest('.notepad-category-item');
                if (categoryItem) {
                    const category = categoryItem.dataset.category;
                    if (category) {
                        countEl.textContent = notesData.filter(n => n.category === category).length;
                    }
                }
            });
        }

        function toggleNoteFavorite() {
            if (!currentNoteId) return;
            const note = notesData.find(n => n.id === currentNoteId);
            if (note) {
                note.favorite = !note.favorite;
                note.modified = new Date().toISOString();
                saveData();
                showNote(currentNoteId);
                updateNoteCounts();
                showToast(note.favorite ? 'Added to favorites' : 'Removed from favorites', 'success');
            }
        }

        function duplicateCurrentNote() {
            if (!currentNoteId) return;
            const note = notesData.find(n => n.id === currentNoteId);
            if (note) {
                const newNote = {
                    id: `note-${Date.now()}`,
                    title: `${note.title} (Copy)`,
                    content: note.content,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    favorite: false,
                    category: note.category
                };
                notesData.push(newNote);
                saveData();
                updateNoteCounts();
                renderNotes();
                showNote(newNote.id);
                showToast('Note duplicated', 'success');
            }
        }

        function showNoteCategoryMenu() {
            if (!currentNoteId) return;
            const note = notesData.find(n => n.id === currentNoteId);
            if (!note) return;
            
            // Remove any existing category menu
            const existingMenu = document.getElementById('notepadCategoryMenu');
            if (existingMenu) existingMenu.remove();
            
            const notepadContainer = document.getElementById('notepadContainer');
            if (!notepadContainer) return;
            
            const options = ['None', ...noteCategories.map(cat => typeof cat === 'string' ? cat : cat.name)];
            const current = note.category || 'None';
            const index = options.indexOf(current);
            
            const menu = document.createElement('div');
            menu.id = 'notepadCategoryMenu';
            menu.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100001; background: rgba(34, 34, 34, 0.98); border: 1px solid #444; border-radius: 8px; padding: 20px; min-width: 300px; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';
            
            // Create header
            const header = document.createElement('div');
            header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;';
            const title = document.createElement('h2');
            title.style.cssText = 'margin: 0; color: #fff; font-size: 1.2em;';
            title.textContent = 'Select Category';
            const closeBtn = document.createElement('span');
            closeBtn.style.cssText = 'color: #aaa; font-size: 24px; cursor: pointer; line-height: 1;';
            closeBtn.textContent = '×';
            closeBtn.onclick = () => menu.remove();
            header.appendChild(title);
            header.appendChild(closeBtn);
            menu.appendChild(header);
            
            // Create options container
            const optionsContainer = document.createElement('div');
            optionsContainer.style.cssText = 'max-height: 300px; overflow-y: auto;';
            
            // Create option items with event listeners
            options.forEach((cat, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.style.cssText = `padding: 12px; cursor: pointer; border-radius: 6px; margin: 5px 0; background: ${i === index ? 'rgba(0, 115, 230, 0.2)' : 'rgba(255, 255, 255, 0.05)'}; color: ${i === index ? '#0073e6' : '#ddd'}; transition: all 0.2s;`;
                optionDiv.textContent = cat;
                optionDiv.dataset.category = cat === 'None' ? '' : cat;
                
                // Add hover effects
                optionDiv.onmouseover = () => {
                    optionDiv.style.background = 'rgba(255,255,255,0.1)';
                };
                optionDiv.onmouseout = () => {
                    optionDiv.style.background = i === index ? 'rgba(0, 115, 230, 0.2)' : 'rgba(255, 255, 255, 0.05)';
                };
                
                // Add click handler
                optionDiv.onclick = () => {
                    const categoryValue = optionDiv.dataset.category || null;
                    setNoteCategory(categoryValue);
                    menu.remove();
                };
                
                optionsContainer.appendChild(optionDiv);
            });
            
            menu.appendChild(optionsContainer);
            notepadContainer.appendChild(menu);
            
            // Close menu when clicking outside
            menu.onclick = (e) => {
                if (e.target === menu) menu.remove();
            };
        }

        function setNoteCategory(category) {
            if (!currentNoteId) return;
            const note = notesData.find(n => n.id === currentNoteId);
            if (note) {
                note.category = category || null;
                note.modified = new Date().toISOString();
                saveData();
                showNote(currentNoteId);
                renderNotes();
                renderCategories();
                updateNoteCounts();
            }
            // Remove menu after selection
            const menu = document.getElementById('notepadCategoryMenu');
            if (menu) menu.remove();
        }


        // Note templates
        const noteTemplates = {
            meeting: {
                title: 'Meeting Notes',
                content: `Meeting: [Topic]
Date: ${new Date().toLocaleDateString()}
Attendees:
- 

Agenda:
1. 
2. 
3. 

Notes:
- 

Action Items:
- [ ] 
- [ ] 
- [ ] 

Next Meeting: `
            },
            todo: {
                title: 'To-Do List',
                content: `To-Do List - ${new Date().toLocaleDateString()}

Priority:
- [ ] 
- [ ] 
- [ ] 

Today:
- [ ] 
- [ ] 
- [ ] 

This Week:
- [ ] 
- [ ] 
- [ ] 

Completed:
- [x] 
`
            },
            ideas: {
                title: 'Ideas',
                content: `Ideas - ${new Date().toLocaleDateString()}

💡 New Ideas:
- 
- 
- 

🔍 To Research:
- 
- 

✅ To Implement:
- 
- 

📝 Notes:
- 
`
            },
            journal: {
                title: 'Journal Entry',
                content: `Journal - ${new Date().toLocaleDateString()}

Today's Highlights:
- 
- 

Gratitude:
- 
- 

Reflections:
- 

Goals for Tomorrow:
- 
- 
`
            },
            project: {
                title: 'Project Plan',
                content: `Project: [Project Name]
Start Date: ${new Date().toLocaleDateString()}

Overview:
- 

Objectives:
- 
- 
- 

Tasks:
- [ ] 
- [ ] 
- [ ] 

Resources Needed:
- 
- 

Timeline:
- Week 1: 
- Week 2: 
- Week 3: 

Notes:
- 
`
            },
            code: {
                title: 'Code Notes',
                content: `Code Notes - ${new Date().toLocaleDateString()}

Problem:
- 

Solution:
\`\`\`
// Code here
\`\`\`

Notes:
- 

References:
- 
`
            },
            recipe: {
                title: 'Recipe',
                content: `Recipe: [Dish Name]

Ingredients:
- 
- 
- 

Instructions:
1. 
2. 
3. 

Notes:
- 

Rating: ⭐⭐⭐⭐⭐
`
            },
            contact: {
                title: 'Contact Info',
                content: `Contact: [Name]

Email: 
Phone: 
Address: 

Company: 
Position: 

Notes:
- 

Last Contact: ${new Date().toLocaleDateString()}
`
            },
            book: {
                title: 'Book Notes',
                content: `Book: [Title]
Author: 
Date Started: ${new Date().toLocaleDateString()}

Key Points:
- 
- 
- 

Quotes:
""
""

Thoughts:
- 

Rating: ⭐⭐⭐⭐⭐
`
            },
            workout: {
                title: 'Workout Log',
                content: `Workout - ${new Date().toLocaleDateString()}

Warm-up:
- 

Main Workout:
- 
- 
- 

Cool-down:
- 

Notes:
- 

Duration:  minutes
`
            }
        };

        function createNoteFromTemplate(templateName) {
            const template = noteTemplates[templateName];
            if (!template) return;
            
            const noteId = `note-${Date.now()}`;
            const now = Date.now();
            const newNote = {
                id: noteId,
                title: template.title,
                content: template.content,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                favorite: false,
                category: null,
                order: now // Set order to current timestamp
            };

            notesData.push(newNote);
            saveData();
            updateNoteCounts();
            renderNotes();
            showNote(noteId);
            showToast('Note created from template', 'success');
        }

        // ========== SETTINGS MENU ==========
        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        }
        
        function closeSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.remove('active');
        }
        
        // Close settings menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('settingsMenu');
            const button = document.querySelector('.settings-button');
            if (menu && button && !menu.contains(e.target) && !button.contains(e.target)) {
                menu.classList.remove('active');
            }
        });


        // Auto-save with debounce
        let autoSaveTimeout;
        document.addEventListener('DOMContentLoaded', () => {
            // High Contrast theme is always applied via CSS
            
            const textarea = document.getElementById('notepadTextarea');
            if (textarea) {
                textarea.addEventListener('input', () => {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(saveNoteContent, 500);
                });
                
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            const notepadVisible = document.getElementById('notepadContainer')?.style.display === 'block';
            
            // Close notepad with Escape
            if (event.key === 'Escape' && notepadVisible) {
                toggleNotepad();
                return;
            }
            
            // Notepad shortcuts (only when notepad is open)
            if (notepadVisible) {
                // Ctrl+N - New note
                if ((event.ctrlKey || event.metaKey) && event.key === 'n' && !event.shiftKey) {
                    event.preventDefault();
                    addNewNote();
                    return;
                }
                
                // Ctrl+F - Focus search
                if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
                    event.preventDefault();
                    const searchInput = document.getElementById('notepadSearchInput');
                    if (searchInput) searchInput.focus();
                    return;
                }
                
                // Ctrl+Delete - Delete current note
                if ((event.ctrlKey || event.metaKey) && event.key === 'Delete') {
                    event.preventDefault();
                    removeCurrentNote();
                    return;
                }
                
                // Ctrl+D - Duplicate note removed
                
                // Ctrl+S - Save (just show feedback)
                if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                    event.preventDefault();
                    saveNoteContent();
                    saveNoteTitle();
                    showToast('Saved', 'success');
                    return;
                }
                
                
            }
            
            // Global shortcuts
            if (event.key === 'Escape') {
                closeAllModals();
                exitEditMode();
            }
        });
        
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        function exitEditMode() {
            document.querySelectorAll('.hidden-textarea.edit-mode, .hidden-input.edit-mode').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('edit-mode');
            });
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((reg) => console.log('Service Worker registered'))
                    .catch((err) => console.log('Service Worker registration failed'));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderPages();
            renderCategories();
            updateNoteCounts();
            if (pagesData.length > 0) {
                switchPage(pagesData[0].id);
            }
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && textData.some(tab => tab.id === savedTab)) {
                showTab(savedTab);
            } else if (textData.length > 0) {
                showTab(textData[0].id);
            }
            
            
            // Initialize history with current state
            saveToHistory();
            
            // Initialize theme - always dark mode
            applyTheme('dark');
            localStorage.setItem('theme', 'dark');
            
            // Initialize notepad button state if notepad was previously open
            const notepadContainer = document.getElementById('notepadContainer');
            const notepadToggle = document.querySelector('.notepad-toggle');
            if (notepadContainer && notepadToggle) {
                const wasOpen = localStorage.getItem('notepadOpen') === 'true';
                if (wasOpen && typeof renderNotes === 'function') {
                    notepadContainer.style.display = 'block';
                    notepadToggle.classList.add('active');
                    renderNotes();
                    // renderNotes will be called when needed
                }
            }
            
            // Initialize shortcuts
            updateShortcutBadges();
            
            // Add context menu listeners
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', () => hideContextMenu());
            
            // Initialize smart suggestions panel
            showSmartSuggestions(); // Creates the panel
            document.getElementById('smartSuggestionsPanel')?.classList.remove('active');
            
            
            
            // Start Performance Monitoring if enabled
            if (performanceMode) {
                startPerformanceMonitoring();
            }
            
            // Add mobile gesture support
            initMobileGestures();
            
            // Add ARIA labels for accessibility
            addAriaLabels();
            
        });
        
        
        // ========== COMMAND PALETTE ==========
        function openCommandPalette() {
            const palette = document.getElementById('commandPalette');
            const input = document.getElementById('commandInput');
            palette.classList.add('active');
            commandPaletteOpen = true;
            input.value = '';
            input.focus();
            updateCommandPalette('');
            commandSelectedIndex = 0;
        }
        
        function closeCommandPalette() {
            const palette = document.getElementById('commandPalette');
            palette.classList.remove('active');
            commandPaletteOpen = false;
        }
        
        function updateCommandPalette(query) {
            const results = document.getElementById('commandResults');
            results.innerHTML = '';
            commandSelectedIndex = 0;
            
            const commands = [
                { id: 'new-snippet', title: 'New Snippet', desc: 'Create a new text snippet', icon: '➕', shortcut: 'Ctrl+N', action: () => { addTextSnippet(getCurrentTabId()); closeCommandPalette(); } },
                { id: 'notepad', title: 'Notepad', desc: 'Open notepad', icon: '📝', action: () => { toggleNotepad(); closeCommandPalette(); } },
                { id: 'export', title: 'Export Data', desc: 'Export all data', icon: '⬇', action: () => { showExportOptions(); closeCommandPalette(); } },
                { id: 'import', title: 'Import Data', desc: 'Import data', icon: '⬆', action: () => { toggleImport(); closeCommandPalette(); } },
                // Theme toggle removed - dark mode only
                { id: 'shortcuts', title: 'Set Shortcut', desc: 'Set keyboard shortcut for snippet', icon: '⚡', action: () => { showShortcutManager(); closeCommandPalette(); } },
                { id: 'suggestions', title: 'Smart Suggestions', desc: 'View AI-like suggestions', icon: '💡', action: () => { showSmartSuggestions(); closeCommandPalette(); } },
                { id: 'analytics', title: 'Advanced Analytics', desc: 'View detailed analytics', icon: '📈', action: () => { showAdvancedAnalytics(); closeCommandPalette(); } },
                { id: 'filters', title: 'Advanced Filters', desc: 'Apply multiple filters', icon: '🔍', action: () => { showAdvancedFilters(); closeCommandPalette(); } },
                { id: 'performance', title: 'Performance Monitor', desc: 'Toggle performance stats', icon: '⚡', action: () => { togglePerformanceMonitor(); closeCommandPalette(); } }
            ];
            
            let filtered = commands;
            if (query) {
                const lowerQuery = query.toLowerCase();
                filtered = commands.filter(cmd => 
                    cmd.title.toLowerCase().includes(lowerQuery) ||
                    cmd.desc.toLowerCase().includes(lowerQuery)
                );
            }
            
            currentCommands = filtered;
            
            filtered.forEach((cmd, index) => {
                const item = document.createElement('div');
                item.className = `command-item ${index === 0 ? 'selected' : ''}`;
                item.innerHTML = `
                    <span class="command-item-icon">${cmd.icon}</span>
                    <div class="command-item-content">
                        <div class="command-item-title">${cmd.title}</div>
                        <div class="command-item-desc">${cmd.desc}</div>
                    </div>
                    ${cmd.shortcut ? `<span class="command-item-shortcut">${cmd.shortcut}</span>` : ''}
                `;
                item.onclick = cmd.action;
                results.appendChild(item);
            });
        }
        
        function getCurrentTabId() {
            const activeTab = document.querySelector('.tab-button.active');
            return activeTab ? activeTab.dataset.tabId : null;
        }
        
        // ========== QUICK ACTIONS ==========
        // ========== CONTEXTUAL TOOLBAR SYSTEM ==========
        // Tools adapt automatically based on what user is doing (like painting tools)
        let currentContext = 'default';
        
        function updateContextualTools() {
            const menu = document.getElementById('quickActionsMenu');
            const fab = document.querySelector('.quick-actions-fab');
            
            // Detect context
            const activeElement = document.activeElement;
            const selectedText = window.getSelection().toString();
            const hoveredSnippet = document.querySelector('.copy-container:hover');
            let newContext = 'default';
            let tools = [];
            
            if (hoveredSnippet) {
                newContext = 'snippet';
                const textId = hoveredSnippet.dataset.textId;
                tools = [
                    { icon: '📋', title: 'Copy', action: () => { if (textId) copyToClipboard(textId, `success-${textId}`); toggleQuickActions(); } },
                    { icon: '⭐', title: 'Toggle Favorite', action: () => { if (textId) toggleFavorite(textId); toggleQuickActions(); } },
                    { icon: '📋', title: 'Duplicate', action: () => { if (textId) duplicateSnippet(getCurrentTabId(), textId); toggleQuickActions(); } },
                    { icon: '✏️', title: 'Edit', action: () => { if (textId) editSnippetFromContext(textId); toggleQuickActions(); } },
                ];
            } else if (selectedText) {
                newContext = 'text-selected';
                tools = [
                    { icon: '📋', title: 'Copy Selection', action: () => { navigator.clipboard.writeText(selectedText); showToast('Copied!', 'success'); toggleQuickActions(); } },
                ];
            } else {
                newContext = 'default';
                tools = [
                    { icon: '⌨️', title: 'Command Palette', shortcut: 'Ctrl/Cmd + P', action: () => { openCommandPalette(); toggleQuickActions(); } },
                    { icon: '➕', title: 'New Snippet', shortcut: 'Ctrl/Cmd + N', action: () => { addTextSnippet(getCurrentTabId()); toggleQuickActions(); } },
                ];
            }
            
            if (newContext !== currentContext) {
                currentContext = newContext;
                renderContextualTools(tools);
                if (fab) {
                    fab.style.background = getContextColor(newContext);
                }
            }
        }
        
        function renderContextualTools(tools) {
            const menu = document.getElementById('quickActionsMenu');
            menu.innerHTML = '';
            
            tools.forEach(tool => {
                const item = document.createElement('div');
                item.className = 'quick-action-item';
                item.onclick = tool.action;
                item.innerHTML = `
                    <span>${tool.icon}</span>
                    <div>
                        <div style="font-weight: 600;">${tool.title}</div>
                        ${tool.shortcut ? `<div style="font-size: 11px; color: #aaa;">${tool.shortcut}</div>` : ''}
                    </div>
                `;
                menu.appendChild(item);
            });
        }
        
        function getContextColor(context) {
            const colors = {
                'search': 'linear-gradient(135deg, #4caf50, #45a049)',
                'snippet': 'linear-gradient(135deg, #2196F3, #1976d2)',
                'text-selected': 'linear-gradient(135deg, #ff9800, #f57c00)',
                'default': 'linear-gradient(135deg, #0073e6, #005bb5)'
            };
            return colors[context] || colors.default;
        }
        
        function createSnippetFromSelection(text) {
            const tabId = getCurrentTabId();
            if (!tabId) {
                showToast('Please select a section first', 'info');
                return;
            }
            addTextSnippet(tabId);
            // Set the text after a short delay
            setTimeout(() => {
                const containers = document.querySelectorAll('.copy-container');
                const lastContainer = containers[containers.length - 1];
                if (lastContainer) {
                    const textArea = lastContainer.querySelector('textarea');
                    if (textArea) {
                        textArea.value = text;
                        textArea.dispatchEvent(new Event('input'));
                    }
                }
            }, 100);
        }
        
        
        
        
        // ========== CONTEXT MENU ==========
        function handleContextMenu(e) {
            const target = e.target.closest('.copy-container');
            if (target) {
                e.preventDefault();
                const textId = target.dataset.textId;
                showContextMenu(e.pageX, e.pageY, textId);
            }
        }
        
        function showContextMenu(x, y, textId) {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            
            menu.innerHTML = `
                <div class="context-menu-item" onclick="copySnippetFromContext('${textId}'); hideContextMenu();">
                    <span>📋</span> Copy
                </div>
                <div class="context-menu-item" onclick="toggleFavorite('${textId}'); hideContextMenu();">
                    <span>⭐</span> Toggle Favorite
                </div>
                <!-- Duplicate removed -->
                <div class="context-menu-item" onclick="setShortcutForSnippet('${textId}'); hideContextMenu();">
                    <span>⚡</span> Set Shortcut
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="editSnippetFromContext('${textId}'); hideContextMenu();">
                    <span>✏️</span> Edit
                </div>
                <div class="context-menu-item" onclick="removeSnippetFromContext('${textId}'); hideContextMenu();">
                    <span>🗑️</span> Delete
                </div>
            `;
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }
        
        function copySnippetFromContext(textId) {
            const textElement = document.getElementById(textId);
            if (textElement) {
                copyToClipboard(textId, `success-${textId}`);
            }
        }
        
        function editSnippetFromContext(textId) {
            const container = document.querySelector(`[data-text-id="${textId}"]`);
            if (container) {
                const editBtn = container.querySelector('.edit-button');
                if (editBtn) editBtn.click();
            }
        }
        
        function removeSnippetFromContext(textId) {
            const container = document.querySelector(`[data-text-id="${textId}"]`);
            if (container) {
                const tabId = getCurrentTabId();
                if (tabId) {
                    removeTextSnippet(tabId, textId);
                    showToast('Snippet deleted', 'success');
                }
            }
        }
        
        // ========== THEME SYSTEM ==========
        // Theme toggle removed - dark mode is now permanent
        function toggleTheme() {
            // Disabled - dark mode only
        }
        
        function applyTheme(theme) {
            // Force dark theme always
            document.body.className = '';
            // Remove any light theme classes
            document.body.classList.remove('light-theme');
        }
        
        // ========== USAGE TRACKING ==========
        function trackUsage(textId) {
            usageFrequency[textId] = (usageFrequency[textId] || 0) + 1;
            localStorage.setItem('usageFrequency', JSON.stringify(usageFrequency));
        }
        
        function updateCommandSelection() {
            const items = document.querySelectorAll('.command-item');
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === commandSelectedIndex);
            });
        }
        
        // ========== SNIPPET VARIABLES SYSTEM ==========
        function processVariables(text) {
            const variables = {
                '{date}': new Date().toLocaleDateString(),
                '{time}': new Date().toLocaleTimeString(),
                '{datetime}': new Date().toLocaleString(),
                '{year}': new Date().getFullYear(),
                '{month}': new Date().getMonth() + 1,
                '{day}': new Date().getDate(),
                '{timestamp}': Date.now()
            };
            
            let processed = text;
            Object.keys(variables).forEach(key => {
                processed = processed.replace(new RegExp(key.replace(/[{}]/g, '\\$&'), 'g'), variables[key]);
            });
            
            return processed;
        }
        
        // Update copyToClipboard to process variables
        const originalCopyToClipboard = copyToClipboard;
        copyToClipboard = async function(elementId, successId) {
            const textElement = document.getElementById(elementId);
            if (!textElement) return;
            
            let textToCopy = textElement.value;
            if (!textToCopy) {
                showToast('Nothing to copy', 'error');
                return;
            }
            
            // Process variables
            textToCopy = processVariables(textToCopy);
            
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(textToCopy);
                    // Show toast only once
                    showToast('Copied to clipboard!', 'success');
                } else {
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textToCopy;
                    tempTextarea.style.position = 'fixed';
                    tempTextarea.style.opacity = '0';
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextarea);
                    // Show toast only once
                    showToast('Copied to clipboard!', 'success');
                }
                
                const successMessage = document.getElementById(successId);
                if (successMessage) {
                    successMessage.classList.add('show-success');
                    setTimeout(() => {
                        successMessage.classList.remove('show-success');
                    }, 2000);
                }
                
                trackUsage(elementId);
            } catch (error) {
                console.error('Failed to copy:', error);
                showToast('Failed to copy to clipboard', 'error');
            }
        };
        
        // ========== SMART SUGGESTIONS ==========
        function showSmartSuggestions(input, query) {
            // This would show AI-like suggestions based on usage patterns
            // For now, show recent/frequent snippets
            const suggestions = [];
            pagesData.forEach(page => {
                page.sections?.forEach(section => {
                    const collectSuggestions = (texts) => {
                        texts.forEach(text => {
                            if (text.buttonText.toLowerCase().includes(query.toLowerCase()) ||
                                text.text.toLowerCase().includes(query.toLowerCase())) {
                                suggestions.push({
                                    text: text.buttonText,
                                    content: text.text,
                                    usage: usageFrequency[text.id] || 0,
                                    id: text.id
                                });
                            }
                            if (text.subtexts) collectSuggestions(text.subtexts);
                        });
                    };
                    if (section.texts) collectSuggestions(section.texts);
                });
            });
            
            suggestions.sort((a, b) => b.usage - a.usage);
            return suggestions.slice(0, 5);
        }
        
        // ========== LOADING STATES ==========
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        // ========== BULK OPERATIONS ==========
        function toggleBulkMode(tabId) {
            bulkMode = !bulkMode;
            selectedSnippets.clear();
            
            const containers = document.querySelectorAll(`#${tabId} .copy-container`);
            containers.forEach(container => {
                const checkbox = container.querySelector('.bulk-select-checkbox');
                if (checkbox) {
                    checkbox.style.display = bulkMode ? 'block' : 'none';
                }
            });
            
            updateBulkActionsBar();
            showToast(bulkMode ? 'Bulk mode enabled' : 'Bulk mode disabled', 'info');
        }
        
        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            if (!bar) {
                const newBar = document.createElement('div');
                newBar.id = 'bulkActionsBar';
                newBar.className = 'bulk-actions-bar';
                newBar.innerHTML = `
                    <div style="color: #fff; font-weight: 600;">
                        ${selectedSnippets.size} snippet${selectedSnippets.size !== 1 ? 's' : ''} selected
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="add-remove-button" onclick="bulkCopy()">📋 Copy All</button>
                        <button class="add-remove-button" style="background: #9c27b0;" onclick="bulkFavorite()">⭐ Favorite</button>
                        <button class="remove-section-button" onclick="bulkDelete()">🗑️ Delete</button>
                        <button class="import-export-button" onclick="exitBulkMode()">✕ Cancel</button>
                    </div>
                `;
                document.body.appendChild(newBar);
            }
            
            if (bulkMode && selectedSnippets.size > 0) {
                bar.classList.add('active');
                bar.querySelector('div').textContent = `${selectedSnippets.size} snippet${selectedSnippets.size !== 1 ? 's' : ''} selected`;
            } else {
                bar.classList.remove('active');
            }
        }
        
        async function bulkCopy() {
            const texts = [];
            selectedSnippets.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    texts.push(processVariables(element.value));
                }
            });
            
            const combined = texts.join('\n\n---\n\n');
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(combined);
                    showToast(`Copied ${selectedSnippets.size} snippets!`, 'success');
                }
            } catch (error) {
                showToast('Failed to copy', 'error');
            }
        }
        
        function bulkFavorite() {
            selectedSnippets.forEach(id => {
                toggleFavorite(id);
            });
            showToast(`Favorited ${selectedSnippets.size} snippets`, 'success');
            exitBulkMode();
        }
        
        function bulkDelete() {
            showConfirmDialog(
                'Delete Multiple Snippets',
                `Are you sure you want to delete ${selectedSnippets.size} snippets?`,
                () => {
                    const tabId = getCurrentTabId();
                    selectedSnippets.forEach(id => {
                        if (tabId) removeTextSnippet(tabId, id);
                    });
                    showToast(`Deleted ${selectedSnippets.size} snippets`, 'success');
                    exitBulkMode();
                }
            );
        }
        
        function exitBulkMode() {
            bulkMode = false;
            selectedSnippets.clear();
            document.querySelectorAll('.bulk-select-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.checked = false;
            });
            const bar = document.getElementById('bulkActionsBar');
            if (bar) bar.classList.remove('active');
        }
        
        
        
        // ========== ENHANCED VISUAL FEEDBACK ==========
        function animateCopy(button) {
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 150);
        }
        
        // ========== SMART GROUPING ==========
        function autoOrganizeByUsage() {
            showConfirmDialog(
                'Auto-Organize',
                'This will reorganize snippets by usage frequency. Continue?',
                () => {
                    pagesData.forEach(page => {
                        page.sections?.forEach(section => {
                            if (section.texts) {
                                section.texts.sort((a, b) => {
                                    const usageA = usageFrequency[a.id] || 0;
                                    const usageB = usageFrequency[b.id] || 0;
                                    if (a.favorite && !b.favorite) return -1;
                                    if (!a.favorite && b.favorite) return 1;
                                    return usageB - usageA;
                                });
                            }
                        });
                    });
                    saveData();
                    createTabs();
                    createTabContents();
                    showToast('Snippets organized by usage!', 'success');
                }
            );
        }
        
        // ========== ENHANCED SEARCH WITH FUZZY MATCHING ==========
        function fuzzyMatch(str, pattern) {
            pattern = pattern.toLowerCase();
            str = str.toLowerCase();
            let patternIdx = 0;
            for (let i = 0; i < str.length && patternIdx < pattern.length; i++) {
                if (str[i] === pattern[patternIdx]) {
                    patternIdx++;
                }
            }
            return patternIdx === pattern.length;
        }
        
        
        // ========== SMART SHORTCUTS SYSTEM ==========
        function setSnippetShortcut(textId, shortcut) {
            if (!shortcut || shortcut.length < 2) {
                showToast('Shortcut must be at least 2 characters', 'error');
                return;
            }
            shortcut = shortcut.toLowerCase();
            snippetShortcuts[shortcut] = textId;
            localStorage.setItem('snippetShortcuts', JSON.stringify(snippetShortcuts));
            showToast(`Shortcut "${shortcut}" set! Type "/${shortcut}" to use`, 'success');
            updateShortcutBadges();
        }
        
        function getSnippetByShortcut(shortcut) {
            return snippetShortcuts[shortcut.toLowerCase()];
        }
        
        function updateShortcutBadges() {
            document.querySelectorAll('.shortcut-badge').forEach(badge => badge.remove());
            Object.entries(snippetShortcuts).forEach(([shortcut, textId]) => {
                const container = document.querySelector(`[data-text-id="${textId}"]`);
                if (container) {
                    const badge = document.createElement('span');
                    badge.className = 'shortcut-badge';
                    badge.textContent = shortcut;
                    badge.title = `Type "/${shortcut}" to copy`;
                    container.style.position = 'relative';
                    container.appendChild(badge);
                }
            });
        }
        
        
        
        // ========== KEYBOARD NAVIGATION ==========
        function enableKeyboardNavigation() {
            keyboardNavActive = true;
            document.body.classList.add('keyboard-nav-active');
            showToast('Keyboard navigation enabled. Use Tab/Shift+Tab to navigate, Enter to copy', 'info');
        }
        
        function disableKeyboardNavigation() {
            keyboardNavActive = false;
            document.body.classList.remove('keyboard-nav-active');
            focusedSnippetIndex = -1;
        }
        
        // ========== SMART COLLECTIONS ==========
        
        // ========== SHORTCUT MANAGEMENT ==========
        function setShortcutForSnippet(textId) {
            const shortcut = prompt('Enter shortcut (2+ characters):');
            if (shortcut && shortcut.length >= 2) {
                setSnippetShortcut(textId, shortcut);
            }
        }
        
        function showShortcutManager() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="this.closest('.modal').remove()">×</span>
                    <h2>⚡ Shortcut Manager</h2>
                    <p style="color: #aaa; margin-bottom: 20px;">Type "/shortcut" in search to quickly copy snippets</p>
                    <div id="shortcutsList"></div>
                </div>
            `;
            
            const list = modal.querySelector('#shortcutsList');
            const shortcuts = Object.entries(snippetShortcuts);
            if (shortcuts.length === 0) {
                list.innerHTML = '<p style="color: #aaa; text-align: center; padding: 20px;">No shortcuts set. Right-click a snippet to set a shortcut.</p>';
            } else {
                shortcuts.forEach(([shortcut, textId]) => {
                    const item = findItemById(textId);
                    if (item) {
                        const div = document.createElement('div');
                        div.className = 'section-list-item';
                        div.style.display = 'flex';
                        div.style.justifyContent = 'space-between';
                        div.innerHTML = `
                            <div>
                                <div style="font-weight: 600;">/${shortcut}</div>
                                <div style="font-size: 11px; color: #aaa;">${item.buttonText}</div>
                            </div>
                            <button class="remove-section-button" onclick="removeShortcut('${shortcut}'); this.closest('.modal').querySelector('#shortcutsList').innerHTML = ''; showShortcutManager();" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                        `;
                        list.appendChild(div);
                    }
                });
            }
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        function removeShortcut(shortcut) {
            delete snippetShortcuts[shortcut.toLowerCase()];
            localStorage.setItem('snippetShortcuts', JSON.stringify(snippetShortcuts));
            updateShortcutBadges();
            showToast('Shortcut removed', 'success');
        }
        
        // ========== VOICE COMMANDS ==========
        function processVoiceCommand_DISABLED(command) {
            // Voice commands
            if (command.includes('new snippet') || command.includes('add snippet')) {
                addTextSnippet(getCurrentTabId());
                showToast('Creating new snippet...', 'success');
            } else if (command.includes('copy') || command.includes('paste')) {
                // Try to find snippet by name
                const snippetName = command.replace(/copy|paste|the/gi, '').trim();
                const snippet = findSnippetByName(snippetName);
                if (snippet) {
                    copyToClipboard(snippet.id, `success-${snippet.id}`);
                    showToast(`Copied: ${snippet.buttonText}`, 'success');
                }
            } else if (command.includes('history')) {
            } else if (command.includes('statistics') || command.includes('stats')) {
                // Statistics removed
            } else if (command.includes('favorites') || command.includes('favorite')) {
                showFavoritesPage();
            } else if (command.includes('command palette') || command.includes('palette')) {
                openCommandPalette();
            } else {
                showToast(`Command not recognized: "${command}"`, 'info');
            }
        }
        
        function findSnippetByName(name) {
            for (const page of pagesData) {
                for (const section of (page.sections || [])) {
                    const findInTexts = (texts) => {
                        for (const text of texts) {
                            if (text.buttonText.toLowerCase().includes(name.toLowerCase())) {
                                return text;
                            }
                            if (text.subtexts) {
                                const found = findInTexts(text.subtexts);
                                if (found) return found;
                            }
                        }
                        return null;
                    };
                    if (section.texts) {
                        const found = findInTexts(section.texts);
                        if (found) return found;
                    }
                }
            }
            return null;
        }
        
        // ========== ADVANCED ANALYTICS ==========
        function showAdvancedAnalytics() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <span class="close" onclick="this.closest('.modal').remove()">×</span>
                    <h2>📈 Advanced Analytics</h2>
                    <div class="analytics-dashboard">
                        <div class="analytics-card">
                            <div class="analytics-label">Total Copies</div>
                            <div class="analytics-value">0</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">Most Used</div>
                            <div class="analytics-value">${getMostUsedSnippetCount()}</div>
                            <div style="font-size: 11px; color: #aaa; margin-top: 5px;">${getMostUsedSnippetName()}</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">Avg per Day</div>
                            <div class="analytics-value">${getAverageCopiesPerDay()}</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-label">Total Favorites</div>
                            <div class="analytics-value">${getAllFavoritesCount()}</div>
                        </div>
                    </div>
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Usage Over Time</h3>
                        <div class="analytics-chart" id="usageChart"></div>
                    </div>
                </div>
            `;
            
            // Generate chart
            const chart = modal.querySelector('#usageChart');
            const dailyUsage = getDailyUsageData();
            const maxUsage = Math.max(...dailyUsage, 1);
            dailyUsage.forEach((value, index) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(value / maxUsage) * 100}%`;
                bar.title = `Day ${index + 1}: ${value} copies`;
                chart.appendChild(bar);
            });
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        function getMostUsedSnippetCount() {
            const maxUsage = Math.max(...Object.values(usageFrequency), 0);
            return maxUsage;
        }
        
        function getMostUsedSnippetName() {
            const maxUsage = Math.max(...Object.values(usageFrequency), 0);
            const snippetId = Object.keys(usageFrequency).find(id => usageFrequency[id] === maxUsage);
            if (snippetId) {
                const item = findItemById(snippetId);
                return item ? item.buttonText : 'N/A';
            }
            return 'N/A';
        }
        
        function getAverageCopiesPerDay() {
            return 0;
        }
        
        function getDailyUsageData() {
            // Simplified - would track daily usage in real implementation
            return [5, 8, 12, 6, 15, 10, 7];
        }
        
        // ========== ADVANCED FILTERS ==========
        function showAdvancedFilters() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="this.closest('.modal').remove()">×</span>
                    <h2>🔍 Advanced Filters</h2>
                    <div class="advanced-filters">
                        <div>
                            <label style="font-weight: 600; margin-bottom: 10px; display: block;">Filter by Tags:</label>
                            <div class="filter-group" id="tagFilters"></div>
                        </div>
                        <div style="margin-top: 20px;">
                            <label style="font-weight: 600; margin-bottom: 10px; display: block;">Other Filters:</label>
                            <div class="filter-group">
                                <div class="filter-chip ${activeFilters.favorites ? 'active' : ''}" onclick="toggleFilter('favorites')">⭐ Favorites Only</div>
                                <div class="filter-chip ${activeFilters.hasVariables ? 'active' : ''}" onclick="toggleFilter('hasVariables')">🔄 Has Variables</div>
                                <div class="filter-chip ${activeFilters.hasShortcuts ? 'active' : ''}" onclick="toggleFilter('hasShortcuts')">⚡ Has Shortcuts</div>
                            </div>
                        </div>
                        <button class="add-remove-button" onclick="applyAdvancedFilters(); this.closest('.modal').remove();" style="margin-top: 20px; width: 100%;">Apply Filters</button>
                    </div>
                </div>
            `;
            
            // Populate tag filters
            const tagFilters = modal.querySelector('#tagFilters');
            const allTags = getAllTags();
            allTags.forEach(tag => {
                const chip = document.createElement('div');
                chip.className = `filter-chip ${activeFilters.tags.includes(tag) ? 'active' : ''}`;
                chip.textContent = tag;
                chip.onclick = () => {
                    chip.classList.toggle('active');
                    if (chip.classList.contains('active')) {
                        if (!activeFilters.tags.includes(tag)) {
                            activeFilters.tags.push(tag);
                        }
                    } else {
                        activeFilters.tags = activeFilters.tags.filter(t => t !== tag);
                    }
                };
                tagFilters.appendChild(chip);
            });
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        function toggleFilter(filterName) {
            activeFilters[filterName] = !activeFilters[filterName];
        }
        
        function applyAdvancedFilters() {
            // Apply filters to snippets
            textData.forEach(tab => {
                if (tab && tab.texts) {
                    const filterTexts = (texts) => {
                        texts.forEach(item => {
                            const container = document.querySelector(`[data-text-id="${item.id}"]`);
                            if (container) {
                                let matches = true;
                                
                                if (activeFilters.favorites && !item.favorite) matches = false;
                                if (activeFilters.tags.length > 0) {
                                    const hasTag = item.tags && item.tags.some(tag => activeFilters.tags.includes(tag));
                                    if (!hasTag) matches = false;
                                }
                                if (activeFilters.hasVariables) {
                                    const hasVar = item.text && (item.text.includes('{date}') || item.text.includes('{time}'));
                                    if (!hasVar) matches = false;
                                }
                                if (activeFilters.hasShortcuts) {
                                    const hasShortcut = Object.values(snippetShortcuts).includes(item.id);
                                    if (!hasShortcut) matches = false;
                                }
                                
                                if (matches) {
                                    container.classList.remove('hidden-text-filtered');
                                } else {
                                    container.classList.add('hidden-text-filtered');
                                }
                            }
                            if (item.subtexts) filterTexts(item.subtexts);
                        });
                    };
                    filterTexts(tab.texts);
                }
            });
            showToast('Filters applied!', 'success');
        }
        
        // ========== PERFORMANCE MONITORING ==========
        function togglePerformanceMonitor() {
            performanceMode = !performanceMode;
            localStorage.setItem('performanceMode', performanceMode.toString());
            const monitor = document.getElementById('performanceMonitor');
            if (performanceMode) {
                monitor.classList.add('active');
                startPerformanceMonitoring();
            } else {
                monitor.classList.remove('active');
            }
        }
        
        function startPerformanceMonitoring() {
            function updatePerformance() {
                if (!performanceMode) return;
                
                // FPS calculation
                frameCount++;
                const currentTime = performance.now();
                if (currentTime >= lastTime + 1000) {
                    const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                    document.getElementById('fpsCounter').textContent = fps;
                    frameCount = 0;
                    lastTime = currentTime;
                }
                
                // Memory (if available)
                if (performance.memory) {
                    const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    document.getElementById('memoryCounter').textContent = memoryMB + ' MB';
                }
                
                requestAnimationFrame(updatePerformance);
            }
            updatePerformance();
        }
        
        // ========== MOBILE GESTURES ==========
        function initMobileGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                if (!touchStartX || !touchStartY) return;
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                
                touchStartX = 0;
                touchStartY = 0;
            });
        }
        
        // ========== ACCESSIBILITY - ARIA LABELS ==========
        function addAriaLabels() {
            // Add ARIA labels to buttons
            document.querySelectorAll('button').forEach(button => {
                if (!button.getAttribute('aria-label') && button.textContent) {
                    button.setAttribute('aria-label', button.textContent.trim());
                }
            });
            
            // Add role attributes
            document.querySelectorAll('.copy-container').forEach(container => {
                container.setAttribute('role', 'button');
                container.setAttribute('tabindex', '0');
            });
            
            // Add skip link
            const skipLink = document.createElement('a');
            skipLink.href = '#main-content';
            skipLink.className = 'skip-link';
            skipLink.textContent = 'Skip to main content';
            document.body.insertBefore(skipLink, document.body.firstChild);
        }
        
        // ========== CONTEXTUAL HELP (OPTIONAL) ==========
        // Only shows when user clicks help button, not automatically
        
        
        
        
        
        // ========== AUTO-SAVE INDICATOR ==========
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('active');
            setTimeout(() => {
                indicator.classList.remove('active');
            }, 2000);
        }
        
        // Override saveData to show indicator
        const originalSaveData = saveData;
        saveData = function() {
            originalSaveData();
            showAutoSaveIndicator();
        };
        
        // ========== SEARCH SUGGESTIONS ==========
        
        // Search suggestions are now handled inline in the input oninput
        
        // ========== KEYBOARD SHORTCUT DISPLAY ==========
        function addKeyboardShortcutDisplay(element, shortcut) {
            if (!element) return;
            
            const display = document.createElement('span');
            display.className = 'keyboard-shortcut-display';
            const keys = shortcut.split('+').map(key => {
                const keySpan = document.createElement('span');
                keySpan.className = 'keyboard-key';
                keySpan.textContent = key.trim();
                return keySpan.outerHTML;
            }).join('+');
            display.innerHTML = keys;
            element.appendChild(display);
        }
        
        // Add shortcut displays to key buttons
        setTimeout(() => {
            const quickActionsBtn = document.querySelector('.quick-actions-fab');
            if (quickActionsBtn) {
                addKeyboardShortcutDisplay(quickActionsBtn, 'Click');
            }
        }, 1000);
        
        // ========== INTERACTIVE WALKTHROUGH ==========
        function startWalkthrough(steps) {
            const overlay = document.getElementById('walkthroughOverlay');
            overlay.classList.add('active');
            let currentStep = 0;
            
            function showStep() {
                if (currentStep >= steps.length) {
                    overlay.classList.remove('active');
                    localStorage.setItem('walkthroughCompleted', 'true');
                    return;
                }
                
                const step = steps[currentStep];
                const element = document.querySelector(step.selector);
                if (!element) {
                    currentStep++;
                    showStep();
                    return;
                }
                
                const rect = element.getBoundingClientRect();
                const spotlight = document.createElement('div');
                spotlight.className = 'walkthrough-spotlight';
                spotlight.style.left = rect.left + 'px';
                spotlight.style.top = rect.top + 'px';
                spotlight.style.width = rect.width + 'px';
                spotlight.style.height = rect.height + 'px';
                overlay.appendChild(spotlight);
                
                const content = document.createElement('div');
                content.className = 'walkthrough-content';
                content.innerHTML = `
                    <div class="walkthrough-title">${step.title}</div>
                    <div class="walkthrough-text">${step.text}</div>
                    <div class="walkthrough-actions">
                        ${currentStep > 0 ? '<button class="add-remove-button" onclick="walkthroughPrevious()">Previous</button>' : ''}
                        <button class="add-remove-button" onclick="walkthroughNext()">Next</button>
                        <button class="remove-section-button" onclick="walkthroughSkip()">Skip</button>
                    </div>
                `;
                
                // Position content
                if (step.position === 'top') {
                    content.style.top = (rect.top - 200) + 'px';
                    content.style.left = rect.left + 'px';
                } else if (step.position === 'bottom') {
                    content.style.top = (rect.bottom + 20) + 'px';
                    content.style.left = rect.left + 'px';
                } else {
                    content.style.top = '50%';
                    content.style.left = '50%';
                    content.style.transform = 'translate(-50%, -50%)';
                }
                
                overlay.appendChild(content);
            }
            
            window.walkthroughNext = () => {
                overlay.innerHTML = '';
                currentStep++;
                showStep();
            };
            
            window.walkthroughPrevious = () => {
                overlay.innerHTML = '';
                currentStep--;
                showStep();
            };
            
            window.walkthroughSkip = () => {
                overlay.classList.remove('active');
                overlay.innerHTML = '';
                localStorage.setItem('walkthroughCompleted', 'true');
            };
            
            showStep();
        }
        
        
        // ========== MICRO-INTERACTIONS ==========
        function addMicroInteraction(element, type = 'bounce') {
            if (!element) return;
            element.classList.add(`micro-${type}`);
            setTimeout(() => {
                element.classList.remove(`micro-${type}`);
            }, 500);
        }
        
        // Add micro-interactions to buttons
        document.addEventListener('click', (e) => {
            if (e.target.matches('button, .copy-button, .favorite-button')) {
                addMicroInteraction(e.target, 'bounce');
            }
        });
        
        // ========== VISUAL FEEDBACK ==========
        function showActionFeedback(message) {
            const feedback = document.getElementById('actionFeedback');
            feedback.textContent = message;
            feedback.classList.add('active');
            setTimeout(() => {
                feedback.classList.remove('active');
            }, 2000);
        }
        
        // ========== CELEBRATION ANIMATION ==========
        function triggerCelebration() {
            const container = document.getElementById('celebrationContainer');
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24'];
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'celebration-particle';
                particle.style.left = '50%';
                particle.style.top = '50%';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                const angle = (Math.PI * 2 * i) / 50;
                const velocity = 200 + Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                
                container.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }
        
        
        
        // ========== SMART TOOLTIPS ==========
        function showSmartTooltip(element, text, position = 'top') {
            const tooltip = document.createElement('div');
            tooltip.className = `smart-tooltip ${position}`;
            tooltip.textContent = text;
            
            const rect = element.getBoundingClientRect();
            if (position === 'top') {
                tooltip.style.top = (rect.top - 50) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
            } else if (position === 'bottom') {
                tooltip.style.top = (rect.bottom + 10) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                tooltip.style.transform = 'translateX(-50%)';
            }
            
            document.body.appendChild(tooltip);
            
            const hideTooltip = () => {
                tooltip.remove();
                element.removeEventListener('mouseleave', hideTooltip);
            };
            
            element.addEventListener('mouseleave', hideTooltip);
        }
        
        // ========== INTEGRATED TOOLS SYSTEM ==========
        // Tools that work together seamlessly
        
        // 1. Smart Text Transformations
        function transformText(text, transformation) {
            switch(transformation) {
                case 'uppercase': return text.toUpperCase();
                case 'lowercase': return text.toLowerCase();
                case 'title': return text.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
                case 'sentence': return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
                case 'reverse': return text.split('').reverse().join('');
                case 'remove-spaces': return text.replace(/\s+/g, '');
                case 'remove-newlines': return text.replace(/\n/g, ' ');
                case 'add-line-numbers': return text.split('\n').map((line, i) => `${i + 1}. ${line}`).join('\n');
                case 'remove-duplicates': return [...new Set(text.split('\n'))].join('\n');
                case 'sort-lines': return text.split('\n').sort().join('\n');
                case 'word-count': return `Words: ${text.split(/\s+/).filter(w => w).length}\nChars: ${text.length}\nLines: ${text.split('\n').length}`;
                case 'base64-encode': return btoa(unescape(encodeURIComponent(text)));
                case 'base64-decode': try { return decodeURIComponent(escape(atob(text))); } catch { return 'Invalid base64'; }
                case 'url-encode': return encodeURIComponent(text);
                case 'url-decode': return decodeURIComponent(text);
                case 'json-format': try { return JSON.stringify(JSON.parse(text), null, 2); } catch { return 'Invalid JSON'; }
                case 'minify-json': try { return JSON.stringify(JSON.parse(text)); } catch { return 'Invalid JSON'; }
                default: return text;
            }
        }
        
        // 2. Quick Format Tools (accessible from context menu)
        function showFormatTools(textId) {
            const textElement = document.getElementById(textId);
            if (!textElement) return;
            
            const text = textElement.value || textElement.textContent;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.innerHTML = `
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'uppercase'); hideContextMenu();">🔤 Uppercase</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'lowercase'); hideContextMenu();">🔤 Lowercase</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'title'); hideContextMenu();">📝 Title Case</div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'remove-spaces'); hideContextMenu();">✂️ Remove Spaces</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'remove-newlines'); hideContextMenu();">↩️ Remove Newlines</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'add-line-numbers'); hideContextMenu();">🔢 Add Line Numbers</div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'word-count'); hideContextMenu();">📊 Word Count</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'sort-lines'); hideContextMenu();">🔀 Sort Lines</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'remove-duplicates'); hideContextMenu();">🔁 Remove Duplicates</div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'base64-encode'); hideContextMenu();">🔐 Base64 Encode</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'base64-decode'); hideContextMenu();">🔓 Base64 Decode</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'url-encode'); hideContextMenu();">🔗 URL Encode</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'url-decode'); hideContextMenu();">🔗 URL Decode</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'json-format'); hideContextMenu();">📋 Format JSON</div>
                <div class="context-menu-item" onclick="applyFormat('${textId}', 'minify-json'); hideContextMenu();">📋 Minify JSON</div>
            `;
        }
        
        function applyFormat(textId, format) {
            const textElement = document.getElementById(textId);
            if (!textElement) return;
            
            const originalText = textElement.value || textElement.textContent;
            const transformed = transformText(originalText, format);
            
            if (textElement.tagName === 'TEXTAREA') {
                textElement.value = transformed;
                textElement.dispatchEvent(new Event('input'));
            } else {
                textElement.textContent = transformed;
            }
            
            saveData();
            showToast(`Applied: ${format}`, 'success');
        }
        
        // 3. Smart Batch Operations
        function batchTransformSnippets(transformation) {
            const selected = document.querySelectorAll('.copy-container.selected');
            if (selected.length === 0) {
                showToast('Select snippets first (use Bulk Select)', 'info');
                return;
            }
            
            selected.forEach(container => {
                const textId = container.dataset.textId;
                if (textId) {
                    applyFormat(textId, transformation);
                }
            });
            
            showToast(`Applied ${transformation} to ${selected.length} snippets`, 'success');
        }
        
        // 4. Smart Text Analysis
        function analyzeText(textId) {
            const textElement = document.getElementById(textId);
            if (!textElement) return;
            
            const text = textElement.value || textElement.textContent;
            const words = text.split(/\s+/).filter(w => w);
            const chars = text.length;
            const charsNoSpaces = text.replace(/\s/g, '').length;
            const lines = text.split('\n').length;
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim()).length;
            const sentences = text.split(/[.!?]+/).filter(s => s.trim()).length;
            
            // Analysis removed - using simpler approach
            showToast(`Words: ${words.length} | Chars: ${chars} | Lines: ${lines}`, 'info');
            
            // Create snippet with analysis
            const tabId = getCurrentTabId();
            if (tabId) {
                addTextSnippet(tabId);
                setTimeout(() => {
                    const containers = document.querySelectorAll('.copy-container');
                    const lastContainer = containers[containers.length - 1];
                    if (lastContainer) {
                        const textArea = lastContainer.querySelector('textarea');
                        if (textArea) {
                            textArea.value = `Words: ${words.length}\nCharacters: ${chars}\nCharacters (no spaces): ${charsNoSpaces}\nLines: ${lines}\nParagraphs: ${paragraphs}\nSentences: ${sentences}`;
                            textArea.dispatchEvent(new Event('input'));
                        }
                    }
                }, 100);
            }
        }
        
        // ========== ENHANCED COPY WITH FEEDBACK ==========
        // Final wrapper - only adds visual feedback, no duplicate toast
        const originalCopyToClipboardFunction = copyToClipboard;
        copyToClipboard = async function(elementId, successId) {
            // Set flag to prevent duplicate toasts
            const result = await originalCopyToClipboardFunction(elementId, successId);
            // Only show action feedback, toast already shown by previous wrapper
            showActionFeedback('✓ Copied!');
            addMicroInteraction(document.getElementById(elementId)?.closest('.copy-button'), 'glow');
            return result;
        };
        
        // No auto-popups - everything just works
        
        // ========== ENHANCED USER FEEDBACK ==========
        // Add visual feedback to all important actions
        function enhanceUserFeedback() {
            // Copy button feedback
            document.addEventListener('click', (e) => {
                if (e.target.closest('.copy-button')) {
                    const button = e.target.closest('.copy-button');
                    addMicroInteraction(button, 'bounce');
                    setTimeout(() => {
                        button.classList.add('micro-glow');
                        setTimeout(() => button.classList.remove('micro-glow'), 1000);
                    }, 100);
                }
                
                // Favorite button feedback
                if (e.target.closest('.favorite-button')) {
                    addMicroInteraction(e.target.closest('.favorite-button'), 'bounce');
                }
                
                // Add button feedback
                if (e.target.closest('.add-remove-button, .add-page-button')) {
                    addMicroInteraction(e.target, 'bounce');
                    showActionFeedback('✓ Action completed!');
                }
            });
        }
        
        enhanceUserFeedback();
        
        // ========== SMART DEFAULTS ==========
        // Smart defaults are applied naturally through intuitive design
        
        // ========== ERROR PREVENTION ==========
        function preventCommonErrors() {
            // Warn before deleting
            const originalRemoveTextSnippet = removeTextSnippet;
            removeTextSnippet = function(tabId, textId) {
                const item = findItemById(textId);
                if (item && item.favorite) {
                    showConfirmDialog('Delete Favorite', 'This is a favorite snippet. Are you sure you want to delete it?', () => {
                        originalRemoveTextSnippet(tabId, textId);
                    });
                    return;
                }
                originalRemoveTextSnippet(tabId, textId);
            };
            
            // Prevent duplicate names
            const originalAddPage = addPage;
            addPage = function() {
                const name = prompt('Enter page name:');
                if (!name) return;
                
                if (pagesData.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    showToast('A page with this name already exists!', 'error');
                    addMicroInteraction(document.querySelector('.add-page-button'), 'shake');
                    return;
                }
                
                originalAddPage(name);
            };
        }
        
        preventCommonErrors();
        
        // ========== HELPER FUNCTIONS ==========
        function findItemById(id) {
            for (const page of pagesData) {
                for (const section of (page.sections || [])) {
                    const findInTexts = (texts) => {
                        for (const text of texts) {
                            if (text.id === id) return text;
                            if (text.subtexts) {
                                const found = findInTexts(text.subtexts);
                                if (found) return found;
                            }
                        }
                        return null;
                    };
                    if (section.texts) {
                        const found = findInTexts(section.texts);
                        if (found) return found;
                    }
                }
            }
            return null;
        }
        
        function getButtonText(textId) {
            const item = findItemById(textId);
            return item ? item.buttonText : 'Unknown';
        }
        
        // ========== ENHANCED SEARCH WITH SHORTCUTS ==========
        // Handle shortcut search in search input
        function handleShortcutSearch(searchTerm) {
            if (searchTerm.startsWith('/') && searchTerm.length > 1) {
                const shortcut = searchTerm.substring(1).toLowerCase();
                const textId = getSnippetByShortcut(shortcut);
                if (textId) {
                    // Highlight the snippet
                    document.querySelectorAll('.copy-container').forEach(container => {
                        if (container.dataset.textId === textId) {
                            container.style.border = '2px solid #ffd700';
                            container.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.5)';
                            container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            container.style.border = '';
                            container.style.boxShadow = '';
                        }
                    });
                    return true;
                }
            }
            return false;
        }
        
        // ========== UPDATE COPY BUTTON TO SHOW SHORTCUT ==========
        // This will be handled in createTextContainer
        
        
        // ========== RICH TEXT PREVIEW ==========
        function toggleRichText() {
            richTextEnabled = !richTextEnabled;
            localStorage.setItem('richTextEnabled', JSON.stringify(richTextEnabled));
            showToast(richTextEnabled ? 'Rich text preview enabled' : 'Rich text preview disabled', 'info');
            // Would update preview rendering
        }
        
        // ========== SMART SUGGESTIONS PANEL ==========
        function showSmartSuggestions() {
            const panel = document.getElementById('smartSuggestionsPanel');
            if (!panel) {
                const newPanel = document.createElement('div');
                newPanel.id = 'smartSuggestionsPanel';
                newPanel.className = 'smart-suggestions-panel';
                newPanel.innerHTML = `
                    <div class="suggestion-header">💡 Smart Suggestions</div>
                    <div id="suggestionsContent"></div>
                `;
                document.body.appendChild(newPanel);
                updateSmartSuggestions();
            } else {
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    updateSmartSuggestions();
                }
            }
        }
        
        function updateSmartSuggestions() {
            const content = document.getElementById('suggestionsContent');
            if (!content) return;
            content.innerHTML = '';
            
            // Suggest based on time of day, usage patterns, etc.
            const suggestions = [];
            
            // Most used today
            const today = new Date().toDateString();
            const todayUsage = Object.entries(usageFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([id]) => findItemById(id))
                .filter(Boolean);
            
            if (todayUsage.length > 0) {
                const section = document.createElement('div');
                section.innerHTML = '<div style="font-size: 11px; color: #666; margin-bottom: 5px;">Most Used Today</div>';
                todayUsage.forEach(item => {
                    const sug = document.createElement('div');
                    sug.className = 'quick-access-item';
                    sug.innerHTML = `<span>⭐</span><div>${item.buttonText}</div>`;
                    sug.onclick = () => copyToClipboard(item.id, `success-${item.id}`);
                    section.appendChild(sug);
                });
                content.appendChild(section);
            }
            
            // Recently added
            // Favorites
            // etc.
        }

        // Removed duplicate event listener - copy buttons already have their own click handlers

        window.onclick = function(event) {
            const removeModal = document.getElementById('removeSectionModal');
            const renameModal = document.getElementById('renameSectionModal');
            const addModal = document.getElementById('addSectionModal');
            const removeTextModal = document.getElementById('removeTextModal');
            const addPageModal = document.getElementById('addPageModal');
            const removePageModal = document.getElementById('removePageModal');
            const renamePageModal = document.getElementById('renamePageModal');

            if (event.target === removeModal) {
                removeModal.style.display = 'none';
            }
            if (event.target === renameModal) {
                renameModal.style.display = 'none';
            }
            if (event.target === addModal) {
                addModal.style.display = 'none';
            }
            if (event.target === removeTextModal) {
                removeTextModal.style.display = 'none';
            }
            if (event.target === addPageModal) {
                addPageModal.style.display = 'none';
            }
            if (event.target === removePageModal) {
                removePageModal.style.display = 'none';
            }
            if (event.target === renamePageModal) {
                renamePageModal.style.display = 'none';
            }
        };
    </script>
</body>
</html>